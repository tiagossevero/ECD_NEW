[
{
  "model": "desktop.document2",
  "pk": 167922,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "ECD: 1 Criação tbls",
    "description": "",
    "uuid": "e1637a8a-8f17-fc5e-c6ef-87e64343dde3",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 167922, \"uuid\": \"20963b48-c419-411d-8d3d-6aba3f95aae1\", \"name\": \"ECD: 1 Cria\\u00e7\\u00e3o tbls\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": \"e1637a8a-8f17-fc5e-c6ef-87e64343dde3\", \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"f78fd8f4-ce29-2a5d-3c99-8c53ca700891\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 392, \"column\": 0}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": true, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"teste\", \"currentQueryTab\": \"queryResults\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- ================================================================================\\r\\n-- ECD ONLINE - PARTE 1 [VERS\\u00c3O DEFINITIVA - 100% FUNCIONAL]\\r\\n-- ================================================================================\\r\\n-- \\u2705 Todos os campos TINYINT corrigidos\\r\\n-- \\u2705 Elimina 11.464 duplicatas\\r\\n-- \\u2705 Plano referencial completo (I051 + J100)\\r\\n-- \\u2705 Hierarquia de 3 n\\u00edveis\\r\\n-- ================================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 1: CADASTRO DE EMPRESAS (COM CNAE INTEGRADO)\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_empresas_cadastro;\\r\\nCREATE TABLE teste.ecd_empresas_cadastro AS\\r\\n\\r\\nWITH ecd_mais_recente AS (\\r\\n    SELECT\\r\\n        id_ecd,\\r\\n        nu_cnpj,\\r\\n        dt_referencia,\\r\\n        dt_recepcao,\\r\\n        ROW_NUMBER() OVER (\\r\\n            PARTITION BY nu_cnpj, dt_referencia \\r\\n            ORDER BY dt_recepcao DESC, dt_criacao DESC\\r\\n        ) AS rn\\r\\n    FROM usr_sat_ecd.ecd_controle\\r\\n    WHERE nu_cnpj IS NOT NULL\\r\\n),\\r\\n\\r\\nempresas_base AS (\\r\\n    SELECT DISTINCT\\r\\n        r0000.id_ecd,\\r\\n        REGEXP_REPLACE(TRIM(r0000.nu_cnpj), '[^0-9]', '') AS cnpj,\\r\\n        r0000.nm_empresarial,\\r\\n        r0000.cd_uf,\\r\\n        r0000.nu_ie,\\r\\n        r0000.cd_municipio,\\r\\n        r0000.nu_im,\\r\\n        r0000.ind_sit_especial,\\r\\n        r0000.ind_sit_inicio_periodo,\\r\\n        r0000.ind_grande_porte,\\r\\n        r0000.tp_ecd,\\r\\n        r0000.dt_inicio,\\r\\n        r0000.dt_fim,\\r\\n        r0000.dt_referencia,\\r\\n        r0000.ano_dt_criacao_ecd_ctrl,\\r\\n        r0000.mes_dt_criacao_ecd_ctrl\\r\\n    FROM usr_sat_ecd.ecd_r0000_identificacao r0000\\r\\n    INNER JOIN ecd_mais_recente emr \\r\\n        ON r0000.id_ecd = emr.id_ecd\\r\\n        AND emr.rn = 1\\r\\n    WHERE r0000.nu_cnpj IS NOT NULL\\r\\n        AND LENGTH(REGEXP_REPLACE(TRIM(r0000.nu_cnpj), '[^0-9]', '')) = 14\\r\\n),\\r\\n\\r\\ncnae_lookup AS (\\r\\n    SELECT DISTINCT\\r\\n        REGEXP_REPLACE(TRIM(contrib.nu_cnpj), '[^0-9]', '') AS cnpj,\\r\\n        contrib.cd_cnae,\\r\\n        contrib.de_cnae,\\r\\n        contrib.cd_secao,\\r\\n        contrib.de_secao,\\r\\n        contrib.cd_divisao,\\r\\n        contrib.de_divisao,\\r\\n        contrib.cd_grupo,\\r\\n        contrib.de_grupo,\\r\\n        contrib.cd_classe,\\r\\n        contrib.de_classe,\\r\\n        contrib.qt_cnae_sec,\\r\\n        contrib.nm_razao_social AS nm_razao_social_sefaz,\\r\\n        contrib.nm_fantasia AS nm_fantasia_sefaz,\\r\\n        contrib.cd_sit_cadastral,\\r\\n        contrib.nm_sit_cadastral,\\r\\n        contrib.dt_constituicao_empresa,\\r\\n        contrib.cd_natureza_juridica,\\r\\n        contrib.nm_natureza_juridica,\\r\\n        contrib.cd_tipo_contribuinte,\\r\\n        contrib.nm_tipo_contribuinte,\\r\\n        contrib.cd_reg_apuracao,\\r\\n        contrib.nm_reg_apuracao,\\r\\n        contrib.sn_simples_nacional_rfb\\r\\n    FROM usr_sat_ods.vw_ods_contrib contrib\\r\\n    WHERE contrib.cd_cnae IS NOT NULL\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    eb.id_ecd,\\r\\n    eb.cnpj,\\r\\n    \\r\\n    -- Raz\\u00e3o social: prioriza SEFAZ se dispon\\u00edvel\\r\\n    COALESCE(cl.nm_razao_social_sefaz, eb.nm_empresarial) AS nm_razao_social,\\r\\n    COALESCE(cl.nm_fantasia_sefaz, eb.nm_empresarial) AS nm_fantasia,\\r\\n    \\r\\n    eb.cd_uf,\\r\\n    eb.nu_ie,\\r\\n    eb.cd_municipio,\\r\\n    eb.nu_im AS inscricao_municipal,\\r\\n    \\r\\n    -- CNAE COMPLETO (do SEFAZ):\\r\\n    CAST(cl.cd_cnae AS STRING) AS cd_cnae,\\r\\n    cl.de_cnae,\\r\\n    cl.cd_secao AS cnae_secao,\\r\\n    cl.de_secao AS cnae_secao_descricao,\\r\\n    cl.cd_divisao AS cnae_divisao,\\r\\n    cl.de_divisao AS cnae_divisao_descricao,\\r\\n    cl.cd_grupo AS cnae_grupo,\\r\\n    cl.de_grupo AS cnae_grupo_descricao,\\r\\n    cl.cd_classe AS cnae_classe,\\r\\n    cl.de_classe AS cnae_classe_descricao,\\r\\n    cl.qt_cnae_sec AS qtd_cnaes_secundarios,\\r\\n    \\r\\n    -- Dados cadastrais SEFAZ:\\r\\n    cl.cd_sit_cadastral AS sit_cadastral_sefaz,\\r\\n    cl.nm_sit_cadastral AS nm_sit_cadastral_sefaz,\\r\\n    cl.dt_constituicao_empresa AS dt_constituicao_sefaz,\\r\\n    cl.cd_natureza_juridica AS natureza_juridica_sefaz,\\r\\n    cl.nm_natureza_juridica AS nm_natureza_juridica_sefaz,\\r\\n    cl.cd_tipo_contribuinte,\\r\\n    cl.nm_tipo_contribuinte,\\r\\n    cl.cd_reg_apuracao,\\r\\n    cl.nm_reg_apuracao,\\r\\n    cl.sn_simples_nacional_rfb,\\r\\n    \\r\\n    -- Situa\\u00e7\\u00e3o ECD:\\r\\n    eb.ind_sit_especial AS situacao_especial_ecd,\\r\\n    eb.ind_sit_inicio_periodo AS situacao_inicio_periodo_ecd,\\r\\n    CASE WHEN eb.ind_grande_porte = 1 THEN 'Sim' ELSE 'N\\u00e3o' END AS empresa_grande_porte,\\r\\n    \\r\\n    CASE eb.tp_ecd\\r\\n        WHEN 1 THEN 'Livro Di\\u00e1rio (Completo)'\\r\\n        WHEN 2 THEN 'Livro Di\\u00e1rio com Redu\\u00e7\\u00e3o'\\r\\n        WHEN 3 THEN 'Livro Balancetes'\\r\\n        WHEN 4 THEN 'Livro Auxiliar'\\r\\n        ELSE 'Outros'\\r\\n    END AS tipo_ecd,\\r\\n    \\r\\n    eb.dt_inicio AS data_inicio_periodo,\\r\\n    eb.dt_fim AS data_fim_periodo,\\r\\n    eb.dt_referencia AS ano_referencia,\\r\\n    \\r\\n    CASE\\r\\n        WHEN eb.dt_inicio IS NOT NULL THEN\\r\\n            CAST(CONCAT(\\r\\n                CAST(YEAR(eb.dt_inicio) AS STRING),\\r\\n                LPAD(CAST(MONTH(eb.dt_inicio) AS STRING), 2, '0')\\r\\n            ) AS INT)\\r\\n        ELSE eb.dt_referencia * 100 + 1\\r\\n    END AS periodo_referencia_aaaamm,\\r\\n    \\r\\n    eb.ano_dt_criacao_ecd_ctrl AS ano_criacao_ecd,\\r\\n    eb.mes_dt_criacao_ecd_ctrl AS mes_criacao_ecd,\\r\\n    \\r\\n    COUNT(*) OVER (PARTITION BY eb.cnpj) AS qtd_ecds_entregues,\\r\\n    MAX(eb.dt_referencia) OVER (PARTITION BY eb.cnpj) AS ultima_ecd_ano\\r\\n\\r\\nFROM empresas_base eb\\r\\nLEFT JOIN cnae_lookup cl ON eb.cnpj = cl.cnpj\\r\\n\\r\\nORDER BY eb.cnpj, eb.dt_referencia DESC;\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 2: PLANO DE CONTAS COMPLETO\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_plano_contas;\\r\\nCREATE TABLE teste.ecd_plano_contas AS\\r\\n\\r\\nWITH ecd_mais_recente AS (\\r\\n    SELECT id_ecd\\r\\n    FROM (\\r\\n        SELECT\\r\\n            id_ecd,\\r\\n            ROW_NUMBER() OVER (\\r\\n                PARTITION BY nu_cnpj, dt_referencia \\r\\n                ORDER BY dt_recepcao DESC, dt_criacao DESC\\r\\n            ) AS rn\\r\\n        FROM usr_sat_ecd.ecd_controle\\r\\n        WHERE nu_cnpj IS NOT NULL\\r\\n    ) t\\r\\n    WHERE rn = 1\\r\\n),\\r\\n\\r\\nplano_contas_base AS (\\r\\n    SELECT\\r\\n        ri050.id_ecd,\\r\\n        ri050.dt_referencia,\\r\\n        ri050.cd_conta_anl,\\r\\n        ri050.nm_conta_anl,\\r\\n        ri050.cd_natureza,\\r\\n        ri050.tp_conta,\\r\\n        ri050.nivel,\\r\\n        ri050.cd_conta_sint\\r\\n    FROM usr_sat_ecd.ecd_ri050_plano_contas ri050\\r\\n    INNER JOIN ecd_mais_recente emr ON ri050.id_ecd = emr.id_ecd\\r\\n    WHERE ri050.cd_conta_anl IS NOT NULL\\r\\n),\\r\\n\\r\\nplano_hierarquia AS (\\r\\n    SELECT\\r\\n        a.*,\\r\\n        b.nivel AS nivel_sint1,\\r\\n        b.cd_conta_anl AS cd_conta_sint1,\\r\\n        b.nm_conta_anl AS nm_conta_sint1,\\r\\n        c.nivel AS nivel_sint2,\\r\\n        c.cd_conta_anl AS cd_conta_sint2,\\r\\n        c.nm_conta_anl AS nm_conta_sint2,\\r\\n        d.nivel AS nivel_sint3,\\r\\n        d.cd_conta_anl AS cd_conta_sint3,\\r\\n        d.nm_conta_anl AS nm_conta_sint3\\r\\n    FROM plano_contas_base a\\r\\n    LEFT JOIN usr_sat_ecd.ecd_ri050_plano_contas b \\r\\n        ON b.id_ecd = a.id_ecd \\r\\n        AND b.cd_conta_anl = a.cd_conta_sint \\r\\n        AND b.tp_conta = 'S'\\r\\n    LEFT JOIN usr_sat_ecd.ecd_ri050_plano_contas c \\r\\n        ON c.id_ecd = b.id_ecd \\r\\n        AND c.cd_conta_anl = b.cd_conta_sint\\r\\n        AND c.tp_conta = 'S'\\r\\n    LEFT JOIN usr_sat_ecd.ecd_ri050_plano_contas d \\r\\n        ON d.id_ecd = c.id_ecd \\r\\n        AND d.cd_conta_anl = c.cd_conta_sint\\r\\n        AND d.tp_conta = 'S'\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    ph.id_ecd,\\r\\n    iden.cnpj,\\r\\n    ph.dt_referencia AS ano_referencia,\\r\\n    ph.cd_conta_anl AS cd_conta,\\r\\n    ph.nm_conta_anl AS nm_conta,\\r\\n    ph.cd_natureza AS natureza_conta,\\r\\n    ph.tp_conta AS tipo_conta,\\r\\n    ph.nivel AS nivel_conta,\\r\\n    ph.cd_conta_sint,\\r\\n    \\r\\n    ph.nivel_sint1,\\r\\n    ph.cd_conta_sint1,\\r\\n    ph.nm_conta_sint1,\\r\\n    ph.nivel_sint2,\\r\\n    ph.cd_conta_sint2,\\r\\n    ph.nm_conta_sint2,\\r\\n    ph.nivel_sint3,\\r\\n    ph.cd_conta_sint3,\\r\\n    ph.nm_conta_sint3,\\r\\n    \\r\\n    ri051.cd_conta_plano_contas_ref AS cd_conta_referencial,\\r\\n    rj100.cod_agl AS cod_grupo_balanco,\\r\\n    rj100.descr_cod_agl AS descricao_grupo_balanco\\r\\n\\r\\nFROM plano_hierarquia ph\\r\\n\\r\\nINNER JOIN teste.ecd_empresas_cadastro iden\\r\\n    ON ph.id_ecd = iden.id_ecd\\r\\n    AND ph.dt_referencia = iden.ano_referencia\\r\\n\\r\\nLEFT JOIN (\\r\\n    SELECT id_ecd, cd_conta_plano_contas, cd_conta_plano_contas_ref\\r\\n    FROM usr_sat_ecd.ecd_ri051_plano_contas_referencial\\r\\n    GROUP BY id_ecd, cd_conta_plano_contas, cd_conta_plano_contas_ref\\r\\n) ri051 \\r\\n    ON ri051.id_ecd = ph.id_ecd \\r\\n    AND ri051.cd_conta_plano_contas = ph.cd_conta_anl\\r\\n\\r\\nLEFT JOIN (\\r\\n    SELECT id_ecd, cod_agl, descr_cod_agl\\r\\n    FROM usr_sat_ecd.ecd_rj100_balanco_patrimonial\\r\\n    GROUP BY id_ecd, cod_agl, descr_cod_agl\\r\\n) rj100 \\r\\n    ON rj100.id_ecd = ri051.id_ecd \\r\\n    AND rj100.cod_agl = ri051.cd_conta_plano_contas_ref\\r\\n\\r\\nORDER BY iden.cnpj, ph.dt_referencia, ph.cd_conta_anl;\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 3: SALDOS PERI\\u00d3DICOS\\r\\n-- ================================================================================\\r\\n\\r\\n-- RODAR NO PYTHON\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 4: BALAN\\u00c7O PATRIMONIAL\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_balanco_patrimonial;\\r\\nCREATE TABLE teste.ecd_balanco_patrimonial AS\\r\\n\\r\\nWITH saldos_bp AS (\\r\\n    SELECT\\r\\n        sc.id_ecd,\\r\\n        sc.cnpj,\\r\\n        sc.ano_referencia,\\r\\n        sc.data_fim_periodo,\\r\\n        sc.cd_conta_referencial,\\r\\n        sc.saldo_final_contabil\\r\\n    FROM teste.ecd_saldos_contas_v2 sc\\r\\n    WHERE sc.cd_conta_referencial IS NOT NULL\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    s.id_ecd,\\r\\n    s.cnpj,\\r\\n    s.ano_referencia,\\r\\n    s.data_fim_periodo,\\r\\n    \\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '1%' THEN s.saldo_final_contabil ELSE 0 END) AS ativo_total,\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '1.01%' THEN s.saldo_final_contabil ELSE 0 END) AS ativo_circulante,\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '1.02%' THEN s.saldo_final_contabil ELSE 0 END) AS ativo_nao_circulante,\\r\\n    \\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '2%' THEN s.saldo_final_contabil ELSE 0 END) AS passivo_pl_total,\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '2.01%' THEN s.saldo_final_contabil ELSE 0 END) AS passivo_circulante,\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '2.02%' THEN s.saldo_final_contabil ELSE 0 END) AS passivo_nao_circulante,\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '2.03%' THEN s.saldo_final_contabil ELSE 0 END) AS patrimonio_liquido,\\r\\n    \\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '2.01%' OR s.cd_conta_referencial LIKE '2.02%' \\r\\n        THEN s.saldo_final_contabil ELSE 0 END) AS passivo_total,\\r\\n    \\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '1%' THEN s.saldo_final_contabil ELSE 0 END) -\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '2%' THEN s.saldo_final_contabil ELSE 0 END) AS diferenca_bp\\r\\n\\r\\nFROM saldos_bp s\\r\\n\\r\\nGROUP BY s.id_ecd, s.cnpj, s.ano_referencia, s.data_fim_periodo\\r\\n\\r\\nORDER BY s.cnpj, s.ano_referencia, s.data_fim_periodo;\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 5: DRE\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_dre;\\r\\nCREATE TABLE teste.ecd_dre AS\\r\\n\\r\\nWITH saldos_dre AS (\\r\\n    SELECT\\r\\n        sc.id_ecd,\\r\\n        sc.cnpj,\\r\\n        sc.ano_referencia,\\r\\n        sc.data_fim_periodo,\\r\\n        sc.cd_conta_referencial,\\r\\n        sc.saldo_final_contabil\\r\\n    FROM teste.ecd_saldos_contas_v2 sc\\r\\n    WHERE sc.cd_conta_referencial IS NOT NULL\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    s.id_ecd,\\r\\n    s.cnpj,\\r\\n    s.ano_referencia,\\r\\n    s.data_fim_periodo,\\r\\n    \\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.01%' THEN s.saldo_final_contabil ELSE 0 END) AS receita_bruta,\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.02%' THEN s.saldo_final_contabil ELSE 0 END) AS deducoes_receita,\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.01%' THEN s.saldo_final_contabil ELSE 0 END) +\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.02%' THEN s.saldo_final_contabil ELSE 0 END) AS receita_liquida,\\r\\n    \\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.03%' THEN s.saldo_final_contabil ELSE 0 END) AS custos_totais,\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.04%' THEN s.saldo_final_contabil ELSE 0 END) AS despesas_totais,\\r\\n    \\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.01%' THEN s.saldo_final_contabil ELSE 0 END) +\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.02%' THEN s.saldo_final_contabil ELSE 0 END) +\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.03%' THEN s.saldo_final_contabil ELSE 0 END) AS lucro_bruto,\\r\\n    \\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3%' THEN s.saldo_final_contabil ELSE 0 END) AS resultado_liquido\\r\\n\\r\\nFROM saldos_dre s\\r\\n\\r\\nGROUP BY s.id_ecd, s.cnpj, s.ano_referencia, s.data_fim_periodo\\r\\n\\r\\nORDER BY s.cnpj, s.ano_referencia, s.data_fim_periodo;\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- VALIDA\\u00c7\\u00d5ES\\r\\n-- ================================================================================\\r\\n\\r\\nSELECT 'ecd_empresas_cadastro' AS tabela, COUNT(*) AS qtd, COUNT(DISTINCT cnpj) AS empresas\\r\\nFROM teste.ecd_empresas_cadastro\\r\\nUNION ALL\\r\\nSELECT 'ecd_plano_contas', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_plano_contas\\r\\nUNION ALL\\r\\nSELECT 'ecd_saldos_contas_v2', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_saldos_contas_v2\\r\\nUNION ALL\\r\\nSELECT 'ecd_balanco_patrimonial', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_balanco_patrimonial\\r\\nUNION ALL\\r\\nSELECT 'ecd_dre', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_dre;\\r\\n\", \"statementsList\": [\"-- ================================================================================\\r\\n-- ECD ONLINE - PARTE 1 [VERS\\u00c3O DEFINITIVA - 100% FUNCIONAL]\\r\\n-- ================================================================================\\r\\n-- \\u2705 Todos os campos TINYINT corrigidos\\r\\n-- \\u2705 Elimina 11.464 duplicatas\\r\\n-- \\u2705 Plano referencial completo (I051 + J100)\\r\\n-- \\u2705 Hierarquia de 3 n\\u00edveis\\r\\n-- ================================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 1: CADASTRO DE EMPRESAS (COM CNAE INTEGRADO)\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_empresas_cadastro;\", \"\\r\\nCREATE TABLE teste.ecd_empresas_cadastro AS\\r\\n\\r\\nWITH ecd_mais_recente AS (\\r\\n    SELECT\\r\\n        id_ecd,\\r\\n        nu_cnpj,\\r\\n        dt_referencia,\\r\\n        dt_recepcao,\\r\\n        ROW_NUMBER() OVER (\\r\\n            PARTITION BY nu_cnpj, dt_referencia \\r\\n            ORDER BY dt_recepcao DESC, dt_criacao DESC\\r\\n        ) AS rn\\r\\n    FROM usr_sat_ecd.ecd_controle\\r\\n    WHERE nu_cnpj IS NOT NULL\\r\\n),\\r\\n\\r\\nempresas_base AS (\\r\\n    SELECT DISTINCT\\r\\n        r0000.id_ecd,\\r\\n        REGEXP_REPLACE(TRIM(r0000.nu_cnpj), '[^0-9]', '') AS cnpj,\\r\\n        r0000.nm_empresarial,\\r\\n        r0000.cd_uf,\\r\\n        r0000.nu_ie,\\r\\n        r0000.cd_municipio,\\r\\n        r0000.nu_im,\\r\\n        r0000.ind_sit_especial,\\r\\n        r0000.ind_sit_inicio_periodo,\\r\\n        r0000.ind_grande_porte,\\r\\n        r0000.tp_ecd,\\r\\n        r0000.dt_inicio,\\r\\n        r0000.dt_fim,\\r\\n        r0000.dt_referencia,\\r\\n        r0000.ano_dt_criacao_ecd_ctrl,\\r\\n        r0000.mes_dt_criacao_ecd_ctrl\\r\\n    FROM usr_sat_ecd.ecd_r0000_identificacao r0000\\r\\n    INNER JOIN ecd_mais_recente emr \\r\\n        ON r0000.id_ecd = emr.id_ecd\\r\\n        AND emr.rn = 1\\r\\n    WHERE r0000.nu_cnpj IS NOT NULL\\r\\n        AND LENGTH(REGEXP_REPLACE(TRIM(r0000.nu_cnpj), '[^0-9]', '')) = 14\\r\\n),\\r\\n\\r\\ncnae_lookup AS (\\r\\n    SELECT DISTINCT\\r\\n        REGEXP_REPLACE(TRIM(contrib.nu_cnpj), '[^0-9]', '') AS cnpj,\\r\\n        contrib.cd_cnae,\\r\\n        contrib.de_cnae,\\r\\n        contrib.cd_secao,\\r\\n        contrib.de_secao,\\r\\n        contrib.cd_divisao,\\r\\n        contrib.de_divisao,\\r\\n        contrib.cd_grupo,\\r\\n        contrib.de_grupo,\\r\\n        contrib.cd_classe,\\r\\n        contrib.de_classe,\\r\\n        contrib.qt_cnae_sec,\\r\\n        contrib.nm_razao_social AS nm_razao_social_sefaz,\\r\\n        contrib.nm_fantasia AS nm_fantasia_sefaz,\\r\\n        contrib.cd_sit_cadastral,\\r\\n        contrib.nm_sit_cadastral,\\r\\n        contrib.dt_constituicao_empresa,\\r\\n        contrib.cd_natureza_juridica,\\r\\n        contrib.nm_natureza_juridica,\\r\\n        contrib.cd_tipo_contribuinte,\\r\\n        contrib.nm_tipo_contribuinte,\\r\\n        contrib.cd_reg_apuracao,\\r\\n        contrib.nm_reg_apuracao,\\r\\n        contrib.sn_simples_nacional_rfb\\r\\n    FROM usr_sat_ods.vw_ods_contrib contrib\\r\\n    WHERE contrib.cd_cnae IS NOT NULL\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    eb.id_ecd,\\r\\n    eb.cnpj,\\r\\n    \\r\\n    -- Raz\\u00e3o social: prioriza SEFAZ se dispon\\u00edvel\\r\\n    COALESCE(cl.nm_razao_social_sefaz, eb.nm_empresarial) AS nm_razao_social,\\r\\n    COALESCE(cl.nm_fantasia_sefaz, eb.nm_empresarial) AS nm_fantasia,\\r\\n    \\r\\n    eb.cd_uf,\\r\\n    eb.nu_ie,\\r\\n    eb.cd_municipio,\\r\\n    eb.nu_im AS inscricao_municipal,\\r\\n    \\r\\n    -- CNAE COMPLETO (do SEFAZ):\\r\\n    CAST(cl.cd_cnae AS STRING) AS cd_cnae,\\r\\n    cl.de_cnae,\\r\\n    cl.cd_secao AS cnae_secao,\\r\\n    cl.de_secao AS cnae_secao_descricao,\\r\\n    cl.cd_divisao AS cnae_divisao,\\r\\n    cl.de_divisao AS cnae_divisao_descricao,\\r\\n    cl.cd_grupo AS cnae_grupo,\\r\\n    cl.de_grupo AS cnae_grupo_descricao,\\r\\n    cl.cd_classe AS cnae_classe,\\r\\n    cl.de_classe AS cnae_classe_descricao,\\r\\n    cl.qt_cnae_sec AS qtd_cnaes_secundarios,\\r\\n    \\r\\n    -- Dados cadastrais SEFAZ:\\r\\n    cl.cd_sit_cadastral AS sit_cadastral_sefaz,\\r\\n    cl.nm_sit_cadastral AS nm_sit_cadastral_sefaz,\\r\\n    cl.dt_constituicao_empresa AS dt_constituicao_sefaz,\\r\\n    cl.cd_natureza_juridica AS natureza_juridica_sefaz,\\r\\n    cl.nm_natureza_juridica AS nm_natureza_juridica_sefaz,\\r\\n    cl.cd_tipo_contribuinte,\\r\\n    cl.nm_tipo_contribuinte,\\r\\n    cl.cd_reg_apuracao,\\r\\n    cl.nm_reg_apuracao,\\r\\n    cl.sn_simples_nacional_rfb,\\r\\n    \\r\\n    -- Situa\\u00e7\\u00e3o ECD:\\r\\n    eb.ind_sit_especial AS situacao_especial_ecd,\\r\\n    eb.ind_sit_inicio_periodo AS situacao_inicio_periodo_ecd,\\r\\n    CASE WHEN eb.ind_grande_porte = 1 THEN 'Sim' ELSE 'N\\u00e3o' END AS empresa_grande_porte,\\r\\n    \\r\\n    CASE eb.tp_ecd\\r\\n        WHEN 1 THEN 'Livro Di\\u00e1rio (Completo)'\\r\\n        WHEN 2 THEN 'Livro Di\\u00e1rio com Redu\\u00e7\\u00e3o'\\r\\n        WHEN 3 THEN 'Livro Balancetes'\\r\\n        WHEN 4 THEN 'Livro Auxiliar'\\r\\n        ELSE 'Outros'\\r\\n    END AS tipo_ecd,\\r\\n    \\r\\n    eb.dt_inicio AS data_inicio_periodo,\\r\\n    eb.dt_fim AS data_fim_periodo,\\r\\n    eb.dt_referencia AS ano_referencia,\\r\\n    \\r\\n    CASE\\r\\n        WHEN eb.dt_inicio IS NOT NULL THEN\\r\\n            CAST(CONCAT(\\r\\n                CAST(YEAR(eb.dt_inicio) AS STRING),\\r\\n                LPAD(CAST(MONTH(eb.dt_inicio) AS STRING), 2, '0')\\r\\n            ) AS INT)\\r\\n        ELSE eb.dt_referencia * 100 + 1\\r\\n    END AS periodo_referencia_aaaamm,\\r\\n    \\r\\n    eb.ano_dt_criacao_ecd_ctrl AS ano_criacao_ecd,\\r\\n    eb.mes_dt_criacao_ecd_ctrl AS mes_criacao_ecd,\\r\\n    \\r\\n    COUNT(*) OVER (PARTITION BY eb.cnpj) AS qtd_ecds_entregues,\\r\\n    MAX(eb.dt_referencia) OVER (PARTITION BY eb.cnpj) AS ultima_ecd_ano\\r\\n\\r\\nFROM empresas_base eb\\r\\nLEFT JOIN cnae_lookup cl ON eb.cnpj = cl.cnpj\\r\\n\\r\\nORDER BY eb.cnpj, eb.dt_referencia DESC;\", \"\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 2: PLANO DE CONTAS COMPLETO\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_plano_contas;\", \"\\r\\nCREATE TABLE teste.ecd_plano_contas AS\\r\\n\\r\\nWITH ecd_mais_recente AS (\\r\\n    SELECT id_ecd\\r\\n    FROM (\\r\\n        SELECT\\r\\n            id_ecd,\\r\\n            ROW_NUMBER() OVER (\\r\\n                PARTITION BY nu_cnpj, dt_referencia \\r\\n                ORDER BY dt_recepcao DESC, dt_criacao DESC\\r\\n            ) AS rn\\r\\n        FROM usr_sat_ecd.ecd_controle\\r\\n        WHERE nu_cnpj IS NOT NULL\\r\\n    ) t\\r\\n    WHERE rn = 1\\r\\n),\\r\\n\\r\\nplano_contas_base AS (\\r\\n    SELECT\\r\\n        ri050.id_ecd,\\r\\n        ri050.dt_referencia,\\r\\n        ri050.cd_conta_anl,\\r\\n        ri050.nm_conta_anl,\\r\\n        ri050.cd_natureza,\\r\\n        ri050.tp_conta,\\r\\n        ri050.nivel,\\r\\n        ri050.cd_conta_sint\\r\\n    FROM usr_sat_ecd.ecd_ri050_plano_contas ri050\\r\\n    INNER JOIN ecd_mais_recente emr ON ri050.id_ecd = emr.id_ecd\\r\\n    WHERE ri050.cd_conta_anl IS NOT NULL\\r\\n),\\r\\n\\r\\nplano_hierarquia AS (\\r\\n    SELECT\\r\\n        a.*,\\r\\n        b.nivel AS nivel_sint1,\\r\\n        b.cd_conta_anl AS cd_conta_sint1,\\r\\n        b.nm_conta_anl AS nm_conta_sint1,\\r\\n        c.nivel AS nivel_sint2,\\r\\n        c.cd_conta_anl AS cd_conta_sint2,\\r\\n        c.nm_conta_anl AS nm_conta_sint2,\\r\\n        d.nivel AS nivel_sint3,\\r\\n        d.cd_conta_anl AS cd_conta_sint3,\\r\\n        d.nm_conta_anl AS nm_conta_sint3\\r\\n    FROM plano_contas_base a\\r\\n    LEFT JOIN usr_sat_ecd.ecd_ri050_plano_contas b \\r\\n        ON b.id_ecd = a.id_ecd \\r\\n        AND b.cd_conta_anl = a.cd_conta_sint \\r\\n        AND b.tp_conta = 'S'\\r\\n    LEFT JOIN usr_sat_ecd.ecd_ri050_plano_contas c \\r\\n        ON c.id_ecd = b.id_ecd \\r\\n        AND c.cd_conta_anl = b.cd_conta_sint\\r\\n        AND c.tp_conta = 'S'\\r\\n    LEFT JOIN usr_sat_ecd.ecd_ri050_plano_contas d \\r\\n        ON d.id_ecd = c.id_ecd \\r\\n        AND d.cd_conta_anl = c.cd_conta_sint\\r\\n        AND d.tp_conta = 'S'\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    ph.id_ecd,\\r\\n    iden.cnpj,\\r\\n    ph.dt_referencia AS ano_referencia,\\r\\n    ph.cd_conta_anl AS cd_conta,\\r\\n    ph.nm_conta_anl AS nm_conta,\\r\\n    ph.cd_natureza AS natureza_conta,\\r\\n    ph.tp_conta AS tipo_conta,\\r\\n    ph.nivel AS nivel_conta,\\r\\n    ph.cd_conta_sint,\\r\\n    \\r\\n    ph.nivel_sint1,\\r\\n    ph.cd_conta_sint1,\\r\\n    ph.nm_conta_sint1,\\r\\n    ph.nivel_sint2,\\r\\n    ph.cd_conta_sint2,\\r\\n    ph.nm_conta_sint2,\\r\\n    ph.nivel_sint3,\\r\\n    ph.cd_conta_sint3,\\r\\n    ph.nm_conta_sint3,\\r\\n    \\r\\n    ri051.cd_conta_plano_contas_ref AS cd_conta_referencial,\\r\\n    rj100.cod_agl AS cod_grupo_balanco,\\r\\n    rj100.descr_cod_agl AS descricao_grupo_balanco\\r\\n\\r\\nFROM plano_hierarquia ph\\r\\n\\r\\nINNER JOIN teste.ecd_empresas_cadastro iden\\r\\n    ON ph.id_ecd = iden.id_ecd\\r\\n    AND ph.dt_referencia = iden.ano_referencia\\r\\n\\r\\nLEFT JOIN (\\r\\n    SELECT id_ecd, cd_conta_plano_contas, cd_conta_plano_contas_ref\\r\\n    FROM usr_sat_ecd.ecd_ri051_plano_contas_referencial\\r\\n    GROUP BY id_ecd, cd_conta_plano_contas, cd_conta_plano_contas_ref\\r\\n) ri051 \\r\\n    ON ri051.id_ecd = ph.id_ecd \\r\\n    AND ri051.cd_conta_plano_contas = ph.cd_conta_anl\\r\\n\\r\\nLEFT JOIN (\\r\\n    SELECT id_ecd, cod_agl, descr_cod_agl\\r\\n    FROM usr_sat_ecd.ecd_rj100_balanco_patrimonial\\r\\n    GROUP BY id_ecd, cod_agl, descr_cod_agl\\r\\n) rj100 \\r\\n    ON rj100.id_ecd = ri051.id_ecd \\r\\n    AND rj100.cod_agl = ri051.cd_conta_plano_contas_ref\\r\\n\\r\\nORDER BY iden.cnpj, ph.dt_referencia, ph.cd_conta_anl;\", \"\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 3: SALDOS PERI\\u00d3DICOS\\r\\n-- ================================================================================\\r\\n\\r\\n-- RODAR NO PYTHON\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 4: BALAN\\u00c7O PATRIMONIAL\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_balanco_patrimonial;\", \"\\r\\nCREATE TABLE teste.ecd_balanco_patrimonial AS\\r\\n\\r\\nWITH saldos_bp AS (\\r\\n    SELECT\\r\\n        sc.id_ecd,\\r\\n        sc.cnpj,\\r\\n        sc.ano_referencia,\\r\\n        sc.data_fim_periodo,\\r\\n        sc.cd_conta_referencial,\\r\\n        sc.saldo_final_contabil\\r\\n    FROM teste.ecd_saldos_contas_v2 sc\\r\\n    WHERE sc.cd_conta_referencial IS NOT NULL\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    s.id_ecd,\\r\\n    s.cnpj,\\r\\n    s.ano_referencia,\\r\\n    s.data_fim_periodo,\\r\\n    \\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '1%' THEN s.saldo_final_contabil ELSE 0 END) AS ativo_total,\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '1.01%' THEN s.saldo_final_contabil ELSE 0 END) AS ativo_circulante,\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '1.02%' THEN s.saldo_final_contabil ELSE 0 END) AS ativo_nao_circulante,\\r\\n    \\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '2%' THEN s.saldo_final_contabil ELSE 0 END) AS passivo_pl_total,\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '2.01%' THEN s.saldo_final_contabil ELSE 0 END) AS passivo_circulante,\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '2.02%' THEN s.saldo_final_contabil ELSE 0 END) AS passivo_nao_circulante,\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '2.03%' THEN s.saldo_final_contabil ELSE 0 END) AS patrimonio_liquido,\\r\\n    \\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '2.01%' OR s.cd_conta_referencial LIKE '2.02%' \\r\\n        THEN s.saldo_final_contabil ELSE 0 END) AS passivo_total,\\r\\n    \\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '1%' THEN s.saldo_final_contabil ELSE 0 END) -\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '2%' THEN s.saldo_final_contabil ELSE 0 END) AS diferenca_bp\\r\\n\\r\\nFROM saldos_bp s\\r\\n\\r\\nGROUP BY s.id_ecd, s.cnpj, s.ano_referencia, s.data_fim_periodo\\r\\n\\r\\nORDER BY s.cnpj, s.ano_referencia, s.data_fim_periodo;\", \"\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 5: DRE\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_dre;\", \"\\r\\nCREATE TABLE teste.ecd_dre AS\\r\\n\\r\\nWITH saldos_dre AS (\\r\\n    SELECT\\r\\n        sc.id_ecd,\\r\\n        sc.cnpj,\\r\\n        sc.ano_referencia,\\r\\n        sc.data_fim_periodo,\\r\\n        sc.cd_conta_referencial,\\r\\n        sc.saldo_final_contabil\\r\\n    FROM teste.ecd_saldos_contas_v2 sc\\r\\n    WHERE sc.cd_conta_referencial IS NOT NULL\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    s.id_ecd,\\r\\n    s.cnpj,\\r\\n    s.ano_referencia,\\r\\n    s.data_fim_periodo,\\r\\n    \\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.01%' THEN s.saldo_final_contabil ELSE 0 END) AS receita_bruta,\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.02%' THEN s.saldo_final_contabil ELSE 0 END) AS deducoes_receita,\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.01%' THEN s.saldo_final_contabil ELSE 0 END) +\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.02%' THEN s.saldo_final_contabil ELSE 0 END) AS receita_liquida,\\r\\n    \\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.03%' THEN s.saldo_final_contabil ELSE 0 END) AS custos_totais,\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.04%' THEN s.saldo_final_contabil ELSE 0 END) AS despesas_totais,\\r\\n    \\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.01%' THEN s.saldo_final_contabil ELSE 0 END) +\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.02%' THEN s.saldo_final_contabil ELSE 0 END) +\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.03%' THEN s.saldo_final_contabil ELSE 0 END) AS lucro_bruto,\\r\\n    \\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3%' THEN s.saldo_final_contabil ELSE 0 END) AS resultado_liquido\\r\\n\\r\\nFROM saldos_dre s\\r\\n\\r\\nGROUP BY s.id_ecd, s.cnpj, s.ano_referencia, s.data_fim_periodo\\r\\n\\r\\nORDER BY s.cnpj, s.ano_referencia, s.data_fim_periodo;\", \"\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- VALIDA\\u00c7\\u00d5ES\\r\\n-- ================================================================================\\r\\n\\r\\nSELECT 'ecd_empresas_cadastro' AS tabela, COUNT(*) AS qtd, COUNT(DISTINCT cnpj) AS empresas\\r\\nFROM teste.ecd_empresas_cadastro\\r\\nUNION ALL\\r\\nSELECT 'ecd_plano_contas', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_plano_contas\\r\\nUNION ALL\\r\\nSELECT 'ecd_saldos_contas_v2', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_saldos_contas_v2\\r\\nUNION ALL\\r\\nSELECT 'ecd_balanco_patrimonial', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_balanco_patrimonial\\r\\nUNION ALL\\r\\nSELECT 'ecd_dre', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_dre;\"], \"aceSize\": 100, \"status\": \"available\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"-- ================================================================================\\r\\n-- ECD ONLINE - PARTE 1 [VERS\\u00c3O DEFINITIVA - 100% FUNCIONAL]\\r\\n-- ================================================================================\\r\\n-- \\u2705 Todos os campos TINYINT corrigidos\\r\\n-- \\u2705 Elimina 11.464 duplicatas\\r\\n-- \\u2705 Plano referencial completo (I051 + J100)\\r\\n-- \\u2705 Hierarquia de 3 n\\u00edveis\\r\\n-- ================================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 1: CADASTRO DE EMPRESAS (COM CNAE INTEGRADO)\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_empresas_cadastro;\\r\\nCREATE TABLE teste.ecd_empresas_cadastro AS\\r\\n\\r\\nWITH ecd_mais_recente AS (\\r\\n    SELECT\\r\\n        id_ecd,\\r\\n        nu_cnpj,\\r\\n        dt_referencia,\\r\\n        dt_recepcao,\\r\\n        ROW_NUMBER() OVER (\\r\\n            PARTITION BY nu_cnpj, dt_referencia \\r\\n            ORDER BY dt_recepcao DESC, dt_criacao DESC\\r\\n        ) AS rn\\r\\n    FROM usr_sat_ecd.ecd_controle\\r\\n    WHERE nu_cnpj IS NOT NULL\\r\\n),\\r\\n\\r\\nempresas_base AS (\\r\\n    SELECT DISTINCT\\r\\n        r0000.id_ecd,\\r\\n        REGEXP_REPLACE(TRIM(r0000.nu_cnpj), '[^0-9]', '') AS cnpj,\\r\\n        r0000.nm_empresarial,\\r\\n        r0000.cd_uf,\\r\\n        r0000.nu_ie,\\r\\n        r0000.cd_municipio,\\r\\n        r0000.nu_im,\\r\\n        r0000.ind_sit_especial,\\r\\n        r0000.ind_sit_inicio_periodo,\\r\\n        r0000.ind_grande_porte,\\r\\n        r0000.tp_ecd,\\r\\n        r0000.dt_inicio,\\r\\n        r0000.dt_fim,\\r\\n        r0000.dt_referencia,\\r\\n        r0000.ano_dt_criacao_ecd_ctrl,\\r\\n        r0000.mes_dt_criacao_ecd_ctrl\\r\\n    FROM usr_sat_ecd.ecd_r0000_identificacao r0000\\r\\n    INNER JOIN ecd_mais_recente emr \\r\\n        ON r0000.id_ecd = emr.id_ecd\\r\\n        AND emr.rn = 1\\r\\n    WHERE r0000.nu_cnpj IS NOT NULL\\r\\n        AND LENGTH(REGEXP_REPLACE(TRIM(r0000.nu_cnpj), '[^0-9]', '')) = 14\\r\\n),\\r\\n\\r\\ncnae_lookup AS (\\r\\n    SELECT DISTINCT\\r\\n        REGEXP_REPLACE(TRIM(contrib.nu_cnpj), '[^0-9]', '') AS cnpj,\\r\\n        contrib.cd_cnae,\\r\\n        contrib.de_cnae,\\r\\n        contrib.cd_secao,\\r\\n        contrib.de_secao,\\r\\n        contrib.cd_divisao,\\r\\n        contrib.de_divisao,\\r\\n        contrib.cd_grupo,\\r\\n        contrib.de_grupo,\\r\\n        contrib.cd_classe,\\r\\n        contrib.de_classe,\\r\\n        contrib.qt_cnae_sec,\\r\\n        contrib.nm_razao_social AS nm_razao_social_sefaz,\\r\\n        contrib.nm_fantasia AS nm_fantasia_sefaz,\\r\\n        contrib.cd_sit_cadastral,\\r\\n        contrib.nm_sit_cadastral,\\r\\n        contrib.dt_constituicao_empresa,\\r\\n        contrib.cd_natureza_juridica,\\r\\n        contrib.nm_natureza_juridica,\\r\\n        contrib.cd_tipo_contribuinte,\\r\\n        contrib.nm_tipo_contribuinte,\\r\\n        contrib.cd_reg_apuracao,\\r\\n        contrib.nm_reg_apuracao,\\r\\n        contrib.sn_simples_nacional_rfb\\r\\n    FROM usr_sat_ods.vw_ods_contrib contrib\\r\\n    WHERE contrib.cd_cnae IS NOT NULL\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    eb.id_ecd,\\r\\n    eb.cnpj,\\r\\n    \\r\\n    -- Raz\\u00e3o social: prioriza SEFAZ se dispon\\u00edvel\\r\\n    COALESCE(cl.nm_razao_social_sefaz, eb.nm_empresarial) AS nm_razao_social,\\r\\n    COALESCE(cl.nm_fantasia_sefaz, eb.nm_empresarial) AS nm_fantasia,\\r\\n    \\r\\n    eb.cd_uf,\\r\\n    eb.nu_ie,\\r\\n    eb.cd_municipio,\\r\\n    eb.nu_im AS inscricao_municipal,\\r\\n    \\r\\n    -- CNAE COMPLETO (do SEFAZ):\\r\\n    CAST(cl.cd_cnae AS STRING) AS cd_cnae,\\r\\n    cl.de_cnae,\\r\\n    cl.cd_secao AS cnae_secao,\\r\\n    cl.de_secao AS cnae_secao_descricao,\\r\\n    cl.cd_divisao AS cnae_divisao,\\r\\n    cl.de_divisao AS cnae_divisao_descricao,\\r\\n    cl.cd_grupo AS cnae_grupo,\\r\\n    cl.de_grupo AS cnae_grupo_descricao,\\r\\n    cl.cd_classe AS cnae_classe,\\r\\n    cl.de_classe AS cnae_classe_descricao,\\r\\n    cl.qt_cnae_sec AS qtd_cnaes_secundarios,\\r\\n    \\r\\n    -- Dados cadastrais SEFAZ:\\r\\n    cl.cd_sit_cadastral AS sit_cadastral_sefaz,\\r\\n    cl.nm_sit_cadastral AS nm_sit_cadastral_sefaz,\\r\\n    cl.dt_constituicao_empresa AS dt_constituicao_sefaz,\\r\\n    cl.cd_natureza_juridica AS natureza_juridica_sefaz,\\r\\n    cl.nm_natureza_juridica AS nm_natureza_juridica_sefaz,\\r\\n    cl.cd_tipo_contribuinte,\\r\\n    cl.nm_tipo_contribuinte,\\r\\n    cl.cd_reg_apuracao,\\r\\n    cl.nm_reg_apuracao,\\r\\n    cl.sn_simples_nacional_rfb,\\r\\n    \\r\\n    -- Situa\\u00e7\\u00e3o ECD:\\r\\n    eb.ind_sit_especial AS situacao_especial_ecd,\\r\\n    eb.ind_sit_inicio_periodo AS situacao_inicio_periodo_ecd,\\r\\n    CASE WHEN eb.ind_grande_porte = 1 THEN 'Sim' ELSE 'N\\u00e3o' END AS empresa_grande_porte,\\r\\n    \\r\\n    CASE eb.tp_ecd\\r\\n        WHEN 1 THEN 'Livro Di\\u00e1rio (Completo)'\\r\\n        WHEN 2 THEN 'Livro Di\\u00e1rio com Redu\\u00e7\\u00e3o'\\r\\n        WHEN 3 THEN 'Livro Balancetes'\\r\\n        WHEN 4 THEN 'Livro Auxiliar'\\r\\n        ELSE 'Outros'\\r\\n    END AS tipo_ecd,\\r\\n    \\r\\n    eb.dt_inicio AS data_inicio_periodo,\\r\\n    eb.dt_fim AS data_fim_periodo,\\r\\n    eb.dt_referencia AS ano_referencia,\\r\\n    \\r\\n    CASE\\r\\n        WHEN eb.dt_inicio IS NOT NULL THEN\\r\\n            CAST(CONCAT(\\r\\n                CAST(YEAR(eb.dt_inicio) AS STRING),\\r\\n                LPAD(CAST(MONTH(eb.dt_inicio) AS STRING), 2, '0')\\r\\n            ) AS INT)\\r\\n        ELSE eb.dt_referencia * 100 + 1\\r\\n    END AS periodo_referencia_aaaamm,\\r\\n    \\r\\n    eb.ano_dt_criacao_ecd_ctrl AS ano_criacao_ecd,\\r\\n    eb.mes_dt_criacao_ecd_ctrl AS mes_criacao_ecd,\\r\\n    \\r\\n    COUNT(*) OVER (PARTITION BY eb.cnpj) AS qtd_ecds_entregues,\\r\\n    MAX(eb.dt_referencia) OVER (PARTITION BY eb.cnpj) AS ultima_ecd_ano\\r\\n\\r\\nFROM empresas_base eb\\r\\nLEFT JOIN cnae_lookup cl ON eb.cnpj = cl.cnpj\\r\\n\\r\\nORDER BY eb.cnpj, eb.dt_referencia DESC;\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 2: PLANO DE CONTAS COMPLETO\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_plano_contas;\\r\\nCREATE TABLE teste.ecd_plano_contas AS\\r\\n\\r\\nWITH ecd_mais_recente AS (\\r\\n    SELECT id_ecd\\r\\n    FROM (\\r\\n        SELECT\\r\\n            id_ecd,\\r\\n            ROW_NUMBER() OVER (\\r\\n                PARTITION BY nu_cnpj, dt_referencia \\r\\n                ORDER BY dt_recepcao DESC, dt_criacao DESC\\r\\n            ) AS rn\\r\\n        FROM usr_sat_ecd.ecd_controle\\r\\n        WHERE nu_cnpj IS NOT NULL\\r\\n    ) t\\r\\n    WHERE rn = 1\\r\\n),\\r\\n\\r\\nplano_contas_base AS (\\r\\n    SELECT\\r\\n        ri050.id_ecd,\\r\\n        ri050.dt_referencia,\\r\\n        ri050.cd_conta_anl,\\r\\n        ri050.nm_conta_anl,\\r\\n        ri050.cd_natureza,\\r\\n        ri050.tp_conta,\\r\\n        ri050.nivel,\\r\\n        ri050.cd_conta_sint\\r\\n    FROM usr_sat_ecd.ecd_ri050_plano_contas ri050\\r\\n    INNER JOIN ecd_mais_recente emr ON ri050.id_ecd = emr.id_ecd\\r\\n    WHERE ri050.cd_conta_anl IS NOT NULL\\r\\n),\\r\\n\\r\\nplano_hierarquia AS (\\r\\n    SELECT\\r\\n        a.*,\\r\\n        b.nivel AS nivel_sint1,\\r\\n        b.cd_conta_anl AS cd_conta_sint1,\\r\\n        b.nm_conta_anl AS nm_conta_sint1,\\r\\n        c.nivel AS nivel_sint2,\\r\\n        c.cd_conta_anl AS cd_conta_sint2,\\r\\n        c.nm_conta_anl AS nm_conta_sint2,\\r\\n        d.nivel AS nivel_sint3,\\r\\n        d.cd_conta_anl AS cd_conta_sint3,\\r\\n        d.nm_conta_anl AS nm_conta_sint3\\r\\n    FROM plano_contas_base a\\r\\n    LEFT JOIN usr_sat_ecd.ecd_ri050_plano_contas b \\r\\n        ON b.id_ecd = a.id_ecd \\r\\n        AND b.cd_conta_anl = a.cd_conta_sint \\r\\n        AND b.tp_conta = 'S'\\r\\n    LEFT JOIN usr_sat_ecd.ecd_ri050_plano_contas c \\r\\n        ON c.id_ecd = b.id_ecd \\r\\n        AND c.cd_conta_anl = b.cd_conta_sint\\r\\n        AND c.tp_conta = 'S'\\r\\n    LEFT JOIN usr_sat_ecd.ecd_ri050_plano_contas d \\r\\n        ON d.id_ecd = c.id_ecd \\r\\n        AND d.cd_conta_anl = c.cd_conta_sint\\r\\n        AND d.tp_conta = 'S'\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    ph.id_ecd,\\r\\n    iden.cnpj,\\r\\n    ph.dt_referencia AS ano_referencia,\\r\\n    ph.cd_conta_anl AS cd_conta,\\r\\n    ph.nm_conta_anl AS nm_conta,\\r\\n    ph.cd_natureza AS natureza_conta,\\r\\n    ph.tp_conta AS tipo_conta,\\r\\n    ph.nivel AS nivel_conta,\\r\\n    ph.cd_conta_sint,\\r\\n    \\r\\n    ph.nivel_sint1,\\r\\n    ph.cd_conta_sint1,\\r\\n    ph.nm_conta_sint1,\\r\\n    ph.nivel_sint2,\\r\\n    ph.cd_conta_sint2,\\r\\n    ph.nm_conta_sint2,\\r\\n    ph.nivel_sint3,\\r\\n    ph.cd_conta_sint3,\\r\\n    ph.nm_conta_sint3,\\r\\n    \\r\\n    ri051.cd_conta_plano_contas_ref AS cd_conta_referencial,\\r\\n    rj100.cod_agl AS cod_grupo_balanco,\\r\\n    rj100.descr_cod_agl AS descricao_grupo_balanco\\r\\n\\r\\nFROM plano_hierarquia ph\\r\\n\\r\\nINNER JOIN teste.ecd_empresas_cadastro iden\\r\\n    ON ph.id_ecd = iden.id_ecd\\r\\n    AND ph.dt_referencia = iden.ano_referencia\\r\\n\\r\\nLEFT JOIN (\\r\\n    SELECT id_ecd, cd_conta_plano_contas, cd_conta_plano_contas_ref\\r\\n    FROM usr_sat_ecd.ecd_ri051_plano_contas_referencial\\r\\n    GROUP BY id_ecd, cd_conta_plano_contas, cd_conta_plano_contas_ref\\r\\n) ri051 \\r\\n    ON ri051.id_ecd = ph.id_ecd \\r\\n    AND ri051.cd_conta_plano_contas = ph.cd_conta_anl\\r\\n\\r\\nLEFT JOIN (\\r\\n    SELECT id_ecd, cod_agl, descr_cod_agl\\r\\n    FROM usr_sat_ecd.ecd_rj100_balanco_patrimonial\\r\\n    GROUP BY id_ecd, cod_agl, descr_cod_agl\\r\\n) rj100 \\r\\n    ON rj100.id_ecd = ri051.id_ecd \\r\\n    AND rj100.cod_agl = ri051.cd_conta_plano_contas_ref\\r\\n\\r\\nORDER BY iden.cnpj, ph.dt_referencia, ph.cd_conta_anl;\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 3: SALDOS PERI\\u00d3DICOS\\r\\n-- ================================================================================\\r\\n\\r\\n-- RODAR NO PYTHON\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 4: BALAN\\u00c7O PATRIMONIAL\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_balanco_patrimonial;\\r\\nCREATE TABLE teste.ecd_balanco_patrimonial AS\\r\\n\\r\\nWITH saldos_bp AS (\\r\\n    SELECT\\r\\n        sc.id_ecd,\\r\\n        sc.cnpj,\\r\\n        sc.ano_referencia,\\r\\n        sc.data_fim_periodo,\\r\\n        sc.cd_conta_referencial,\\r\\n        sc.saldo_final_contabil\\r\\n    FROM teste.ecd_saldos_contas_v2 sc\\r\\n    WHERE sc.cd_conta_referencial IS NOT NULL\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    s.id_ecd,\\r\\n    s.cnpj,\\r\\n    s.ano_referencia,\\r\\n    s.data_fim_periodo,\\r\\n    \\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '1%' THEN s.saldo_final_contabil ELSE 0 END) AS ativo_total,\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '1.01%' THEN s.saldo_final_contabil ELSE 0 END) AS ativo_circulante,\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '1.02%' THEN s.saldo_final_contabil ELSE 0 END) AS ativo_nao_circulante,\\r\\n    \\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '2%' THEN s.saldo_final_contabil ELSE 0 END) AS passivo_pl_total,\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '2.01%' THEN s.saldo_final_contabil ELSE 0 END) AS passivo_circulante,\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '2.02%' THEN s.saldo_final_contabil ELSE 0 END) AS passivo_nao_circulante,\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '2.03%' THEN s.saldo_final_contabil ELSE 0 END) AS patrimonio_liquido,\\r\\n    \\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '2.01%' OR s.cd_conta_referencial LIKE '2.02%' \\r\\n        THEN s.saldo_final_contabil ELSE 0 END) AS passivo_total,\\r\\n    \\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '1%' THEN s.saldo_final_contabil ELSE 0 END) -\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '2%' THEN s.saldo_final_contabil ELSE 0 END) AS diferenca_bp\\r\\n\\r\\nFROM saldos_bp s\\r\\n\\r\\nGROUP BY s.id_ecd, s.cnpj, s.ano_referencia, s.data_fim_periodo\\r\\n\\r\\nORDER BY s.cnpj, s.ano_referencia, s.data_fim_periodo;\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 5: DRE\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_dre;\\r\\nCREATE TABLE teste.ecd_dre AS\\r\\n\\r\\nWITH saldos_dre AS (\\r\\n    SELECT\\r\\n        sc.id_ecd,\\r\\n        sc.cnpj,\\r\\n        sc.ano_referencia,\\r\\n        sc.data_fim_periodo,\\r\\n        sc.cd_conta_referencial,\\r\\n        sc.saldo_final_contabil\\r\\n    FROM teste.ecd_saldos_contas_v2 sc\\r\\n    WHERE sc.cd_conta_referencial IS NOT NULL\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    s.id_ecd,\\r\\n    s.cnpj,\\r\\n    s.ano_referencia,\\r\\n    s.data_fim_periodo,\\r\\n    \\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.01%' THEN s.saldo_final_contabil ELSE 0 END) AS receita_bruta,\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.02%' THEN s.saldo_final_contabil ELSE 0 END) AS deducoes_receita,\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.01%' THEN s.saldo_final_contabil ELSE 0 END) +\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.02%' THEN s.saldo_final_contabil ELSE 0 END) AS receita_liquida,\\r\\n    \\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.03%' THEN s.saldo_final_contabil ELSE 0 END) AS custos_totais,\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.04%' THEN s.saldo_final_contabil ELSE 0 END) AS despesas_totais,\\r\\n    \\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.01%' THEN s.saldo_final_contabil ELSE 0 END) +\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.02%' THEN s.saldo_final_contabil ELSE 0 END) +\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.03%' THEN s.saldo_final_contabil ELSE 0 END) AS lucro_bruto,\\r\\n    \\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3%' THEN s.saldo_final_contabil ELSE 0 END) AS resultado_liquido\\r\\n\\r\\nFROM saldos_dre s\\r\\n\\r\\nGROUP BY s.id_ecd, s.cnpj, s.ano_referencia, s.data_fim_periodo\\r\\n\\r\\nORDER BY s.cnpj, s.ano_referencia, s.data_fim_periodo;\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- VALIDA\\u00c7\\u00d5ES\\r\\n-- ================================================================================\\r\\n\\r\\nSELECT 'ecd_empresas_cadastro' AS tabela, COUNT(*) AS qtd, COUNT(DISTINCT cnpj) AS empresas\\r\\nFROM teste.ecd_empresas_cadastro\\r\\nUNION ALL\\r\\nSELECT 'ecd_plano_contas', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_plano_contas\\r\\nUNION ALL\\r\\nSELECT 'ecd_saldos_contas_v2', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_saldos_contas_v2\\r\\nUNION ALL\\r\\nSELECT 'ecd_balanco_patrimonial', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_balanco_patrimonial\\r\\nUNION ALL\\r\\nSELECT 'ecd_dre', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_dre;\\r\\n\", \"result\": {\"id\": \"1c93eece-3948-4358-9403-c27b2ba08c04\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"ATgKZ4tMQWa2pvH/zsw5KQ==\", \"guid\": \"46yHT90BRFIAAAAAlHDXMA==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"5d41d1e923d68653:194867059c4fa7a4\", \"session_id\": 22657, \"session_type\": \"impala\", \"statement_id\": 9, \"has_more_statements\": false, \"statements_count\": 10, \"previous_statement_hash\": \"3df1fe2af976ca44700b34be1f5daf5328131618c9923ab136d89313\", \"start\": {\"row\": 378, \"column\": 0}, \"end\": {\"row\": 391, \"column\": 67}, \"statement\": \"-- ================================================================================\\n-- VALIDA\\u00c7\\u00d5ES\\n-- ================================================================================\\n\\nSELECT 'ecd_empresas_cadastro' AS tabela, COUNT(*) AS qtd, COUNT(DISTINCT cnpj) AS empresas\\nFROM teste.ecd_empresas_cadastro\\nUNION ALL\\nSELECT 'ecd_plano_contas', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_plano_contas\\nUNION ALL\\nSELECT 'ecd_saldos_contas_v2', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_saldos_contas_v2\\nUNION ALL\\nSELECT 'ecd_balanco_patrimonial', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_balanco_patrimonial\\nUNION ALL\\nSELECT 'ecd_dre', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_dre\"}, \"meta\": [], \"rows\": 5, \"hasMore\": false, \"statement_id\": 9, \"statement_range\": {\"start\": {\"row\": 378, \"column\": 0}, \"end\": {\"row\": 391, \"column\": 67}}, \"statements_count\": 10, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": 3, \"filteredMeta\": [{\"type\": \"int\", \"name\": \"\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 0}, {\"name\": \"tabela\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 1}, {\"name\": \"qtd\", \"type\": \"bigint\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 2}, {\"name\": \"empresas\", \"type\": \"bigint\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 3}], \"fetchedOnce\": false, \"startTime\": \"2025-11-11T21:33:09.418Z\", \"endTime\": \"2025-11-11T21:33:11.343Z\", \"executionTime\": 1925, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 4, \"hasSomeResults\": true}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": 9676, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"tabela\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [\"empresas\"], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": true, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": 9730, \"getLogsTimeout\": 9757, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1762896789165, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"lastExecutedStatements\": \"-- ================================================================================\\r\\n-- ECD ONLINE - PARTE 1 [VERS\\u00c3O DEFINITIVA - 100% FUNCIONAL]\\r\\n-- ================================================================================\\r\\n-- \\u2705 Todos os campos TINYINT corrigidos\\r\\n-- \\u2705 Elimina 11.464 duplicatas\\r\\n-- \\u2705 Plano referencial completo (I051 + J100)\\r\\n-- \\u2705 Hierarquia de 3 n\\u00edveis\\r\\n-- ================================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 1: CADASTRO DE EMPRESAS (COM CNAE INTEGRADO)\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_empresas_cadastro;\\r\\nCREATE TABLE teste.ecd_empresas_cadastro AS\\r\\n\\r\\nWITH ecd_mais_recente AS (\\r\\n    SELECT\\r\\n        id_ecd,\\r\\n        nu_cnpj,\\r\\n        dt_referencia,\\r\\n        dt_recepcao,\\r\\n        ROW_NUMBER() OVER (\\r\\n            PARTITION BY nu_cnpj, dt_referencia \\r\\n            ORDER BY dt_recepcao DESC, dt_criacao DESC\\r\\n        ) AS rn\\r\\n    FROM usr_sat_ecd.ecd_controle\\r\\n    WHERE nu_cnpj IS NOT NULL\\r\\n),\\r\\n\\r\\nempresas_base AS (\\r\\n    SELECT DISTINCT\\r\\n        r0000.id_ecd,\\r\\n        REGEXP_REPLACE(TRIM(r0000.nu_cnpj), '[^0-9]', '') AS cnpj,\\r\\n        r0000.nm_empresarial,\\r\\n        r0000.cd_uf,\\r\\n        r0000.nu_ie,\\r\\n        r0000.cd_municipio,\\r\\n        r0000.nu_im,\\r\\n        r0000.ind_sit_especial,\\r\\n        r0000.ind_sit_inicio_periodo,\\r\\n        r0000.ind_grande_porte,\\r\\n        r0000.tp_ecd,\\r\\n        r0000.dt_inicio,\\r\\n        r0000.dt_fim,\\r\\n        r0000.dt_referencia,\\r\\n        r0000.ano_dt_criacao_ecd_ctrl,\\r\\n        r0000.mes_dt_criacao_ecd_ctrl\\r\\n    FROM usr_sat_ecd.ecd_r0000_identificacao r0000\\r\\n    INNER JOIN ecd_mais_recente emr \\r\\n        ON r0000.id_ecd = emr.id_ecd\\r\\n        AND emr.rn = 1\\r\\n    WHERE r0000.nu_cnpj IS NOT NULL\\r\\n        AND LENGTH(REGEXP_REPLACE(TRIM(r0000.nu_cnpj), '[^0-9]', '')) = 14\\r\\n),\\r\\n\\r\\ncnae_lookup AS (\\r\\n    SELECT DISTINCT\\r\\n        REGEXP_REPLACE(TRIM(contrib.nu_cnpj), '[^0-9]', '') AS cnpj,\\r\\n        contrib.cd_cnae,\\r\\n        contrib.de_cnae,\\r\\n        contrib.cd_secao,\\r\\n        contrib.de_secao,\\r\\n        contrib.cd_divisao,\\r\\n        contrib.de_divisao,\\r\\n        contrib.cd_grupo,\\r\\n        contrib.de_grupo,\\r\\n        contrib.cd_classe,\\r\\n        contrib.de_classe,\\r\\n        contrib.qt_cnae_sec,\\r\\n        contrib.nm_razao_social AS nm_razao_social_sefaz,\\r\\n        contrib.nm_fantasia AS nm_fantasia_sefaz,\\r\\n        contrib.cd_sit_cadastral,\\r\\n        contrib.nm_sit_cadastral,\\r\\n        contrib.dt_constituicao_empresa,\\r\\n        contrib.cd_natureza_juridica,\\r\\n        contrib.nm_natureza_juridica,\\r\\n        contrib.cd_tipo_contribuinte,\\r\\n        contrib.nm_tipo_contribuinte,\\r\\n        contrib.cd_reg_apuracao,\\r\\n        contrib.nm_reg_apuracao,\\r\\n        contrib.sn_simples_nacional_rfb\\r\\n    FROM usr_sat_ods.vw_ods_contrib contrib\\r\\n    WHERE contrib.cd_cnae IS NOT NULL\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    eb.id_ecd,\\r\\n    eb.cnpj,\\r\\n    \\r\\n    -- Raz\\u00e3o social: prioriza SEFAZ se dispon\\u00edvel\\r\\n    COALESCE(cl.nm_razao_social_sefaz, eb.nm_empresarial) AS nm_razao_social,\\r\\n    COALESCE(cl.nm_fantasia_sefaz, eb.nm_empresarial) AS nm_fantasia,\\r\\n    \\r\\n    eb.cd_uf,\\r\\n    eb.nu_ie,\\r\\n    eb.cd_municipio,\\r\\n    eb.nu_im AS inscricao_municipal,\\r\\n    \\r\\n    -- CNAE COMPLETO (do SEFAZ):\\r\\n    CAST(cl.cd_cnae AS STRING) AS cd_cnae,\\r\\n    cl.de_cnae,\\r\\n    cl.cd_secao AS cnae_secao,\\r\\n    cl.de_secao AS cnae_secao_descricao,\\r\\n    cl.cd_divisao AS cnae_divisao,\\r\\n    cl.de_divisao AS cnae_divisao_descricao,\\r\\n    cl.cd_grupo AS cnae_grupo,\\r\\n    cl.de_grupo AS cnae_grupo_descricao,\\r\\n    cl.cd_classe AS cnae_classe,\\r\\n    cl.de_classe AS cnae_classe_descricao,\\r\\n    cl.qt_cnae_sec AS qtd_cnaes_secundarios,\\r\\n    \\r\\n    -- Dados cadastrais SEFAZ:\\r\\n    cl.cd_sit_cadastral AS sit_cadastral_sefaz,\\r\\n    cl.nm_sit_cadastral AS nm_sit_cadastral_sefaz,\\r\\n    cl.dt_constituicao_empresa AS dt_constituicao_sefaz,\\r\\n    cl.cd_natureza_juridica AS natureza_juridica_sefaz,\\r\\n    cl.nm_natureza_juridica AS nm_natureza_juridica_sefaz,\\r\\n    cl.cd_tipo_contribuinte,\\r\\n    cl.nm_tipo_contribuinte,\\r\\n    cl.cd_reg_apuracao,\\r\\n    cl.nm_reg_apuracao,\\r\\n    cl.sn_simples_nacional_rfb,\\r\\n    \\r\\n    -- Situa\\u00e7\\u00e3o ECD:\\r\\n    eb.ind_sit_especial AS situacao_especial_ecd,\\r\\n    eb.ind_sit_inicio_periodo AS situacao_inicio_periodo_ecd,\\r\\n    CASE WHEN eb.ind_grande_porte = 1 THEN 'Sim' ELSE 'N\\u00e3o' END AS empresa_grande_porte,\\r\\n    \\r\\n    CASE eb.tp_ecd\\r\\n        WHEN 1 THEN 'Livro Di\\u00e1rio (Completo)'\\r\\n        WHEN 2 THEN 'Livro Di\\u00e1rio com Redu\\u00e7\\u00e3o'\\r\\n        WHEN 3 THEN 'Livro Balancetes'\\r\\n        WHEN 4 THEN 'Livro Auxiliar'\\r\\n        ELSE 'Outros'\\r\\n    END AS tipo_ecd,\\r\\n    \\r\\n    eb.dt_inicio AS data_inicio_periodo,\\r\\n    eb.dt_fim AS data_fim_periodo,\\r\\n    eb.dt_referencia AS ano_referencia,\\r\\n    \\r\\n    CASE\\r\\n        WHEN eb.dt_inicio IS NOT NULL THEN\\r\\n            CAST(CONCAT(\\r\\n                CAST(YEAR(eb.dt_inicio) AS STRING),\\r\\n                LPAD(CAST(MONTH(eb.dt_inicio) AS STRING), 2, '0')\\r\\n            ) AS INT)\\r\\n        ELSE eb.dt_referencia * 100 + 1\\r\\n    END AS periodo_referencia_aaaamm,\\r\\n    \\r\\n    eb.ano_dt_criacao_ecd_ctrl AS ano_criacao_ecd,\\r\\n    eb.mes_dt_criacao_ecd_ctrl AS mes_criacao_ecd,\\r\\n    \\r\\n    COUNT(*) OVER (PARTITION BY eb.cnpj) AS qtd_ecds_entregues,\\r\\n    MAX(eb.dt_referencia) OVER (PARTITION BY eb.cnpj) AS ultima_ecd_ano\\r\\n\\r\\nFROM empresas_base eb\\r\\nLEFT JOIN cnae_lookup cl ON eb.cnpj = cl.cnpj\\r\\n\\r\\nORDER BY eb.cnpj, eb.dt_referencia DESC;\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 2: PLANO DE CONTAS COMPLETO\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_plano_contas;\\r\\nCREATE TABLE teste.ecd_plano_contas AS\\r\\n\\r\\nWITH ecd_mais_recente AS (\\r\\n    SELECT id_ecd\\r\\n    FROM (\\r\\n        SELECT\\r\\n            id_ecd,\\r\\n            ROW_NUMBER() OVER (\\r\\n                PARTITION BY nu_cnpj, dt_referencia \\r\\n                ORDER BY dt_recepcao DESC, dt_criacao DESC\\r\\n            ) AS rn\\r\\n        FROM usr_sat_ecd.ecd_controle\\r\\n        WHERE nu_cnpj IS NOT NULL\\r\\n    ) t\\r\\n    WHERE rn = 1\\r\\n),\\r\\n\\r\\nplano_contas_base AS (\\r\\n    SELECT\\r\\n        ri050.id_ecd,\\r\\n        ri050.dt_referencia,\\r\\n        ri050.cd_conta_anl,\\r\\n        ri050.nm_conta_anl,\\r\\n        ri050.cd_natureza,\\r\\n        ri050.tp_conta,\\r\\n        ri050.nivel,\\r\\n        ri050.cd_conta_sint\\r\\n    FROM usr_sat_ecd.ecd_ri050_plano_contas ri050\\r\\n    INNER JOIN ecd_mais_recente emr ON ri050.id_ecd = emr.id_ecd\\r\\n    WHERE ri050.cd_conta_anl IS NOT NULL\\r\\n),\\r\\n\\r\\nplano_hierarquia AS (\\r\\n    SELECT\\r\\n        a.*,\\r\\n        b.nivel AS nivel_sint1,\\r\\n        b.cd_conta_anl AS cd_conta_sint1,\\r\\n        b.nm_conta_anl AS nm_conta_sint1,\\r\\n        c.nivel AS nivel_sint2,\\r\\n        c.cd_conta_anl AS cd_conta_sint2,\\r\\n        c.nm_conta_anl AS nm_conta_sint2,\\r\\n        d.nivel AS nivel_sint3,\\r\\n        d.cd_conta_anl AS cd_conta_sint3,\\r\\n        d.nm_conta_anl AS nm_conta_sint3\\r\\n    FROM plano_contas_base a\\r\\n    LEFT JOIN usr_sat_ecd.ecd_ri050_plano_contas b \\r\\n        ON b.id_ecd = a.id_ecd \\r\\n        AND b.cd_conta_anl = a.cd_conta_sint \\r\\n        AND b.tp_conta = 'S'\\r\\n    LEFT JOIN usr_sat_ecd.ecd_ri050_plano_contas c \\r\\n        ON c.id_ecd = b.id_ecd \\r\\n        AND c.cd_conta_anl = b.cd_conta_sint\\r\\n        AND c.tp_conta = 'S'\\r\\n    LEFT JOIN usr_sat_ecd.ecd_ri050_plano_contas d \\r\\n        ON d.id_ecd = c.id_ecd \\r\\n        AND d.cd_conta_anl = c.cd_conta_sint\\r\\n        AND d.tp_conta = 'S'\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    ph.id_ecd,\\r\\n    iden.cnpj,\\r\\n    ph.dt_referencia AS ano_referencia,\\r\\n    ph.cd_conta_anl AS cd_conta,\\r\\n    ph.nm_conta_anl AS nm_conta,\\r\\n    ph.cd_natureza AS natureza_conta,\\r\\n    ph.tp_conta AS tipo_conta,\\r\\n    ph.nivel AS nivel_conta,\\r\\n    ph.cd_conta_sint,\\r\\n    \\r\\n    ph.nivel_sint1,\\r\\n    ph.cd_conta_sint1,\\r\\n    ph.nm_conta_sint1,\\r\\n    ph.nivel_sint2,\\r\\n    ph.cd_conta_sint2,\\r\\n    ph.nm_conta_sint2,\\r\\n    ph.nivel_sint3,\\r\\n    ph.cd_conta_sint3,\\r\\n    ph.nm_conta_sint3,\\r\\n    \\r\\n    ri051.cd_conta_plano_contas_ref AS cd_conta_referencial,\\r\\n    rj100.cod_agl AS cod_grupo_balanco,\\r\\n    rj100.descr_cod_agl AS descricao_grupo_balanco\\r\\n\\r\\nFROM plano_hierarquia ph\\r\\n\\r\\nINNER JOIN teste.ecd_empresas_cadastro iden\\r\\n    ON ph.id_ecd = iden.id_ecd\\r\\n    AND ph.dt_referencia = iden.ano_referencia\\r\\n\\r\\nLEFT JOIN (\\r\\n    SELECT id_ecd, cd_conta_plano_contas, cd_conta_plano_contas_ref\\r\\n    FROM usr_sat_ecd.ecd_ri051_plano_contas_referencial\\r\\n    GROUP BY id_ecd, cd_conta_plano_contas, cd_conta_plano_contas_ref\\r\\n) ri051 \\r\\n    ON ri051.id_ecd = ph.id_ecd \\r\\n    AND ri051.cd_conta_plano_contas = ph.cd_conta_anl\\r\\n\\r\\nLEFT JOIN (\\r\\n    SELECT id_ecd, cod_agl, descr_cod_agl\\r\\n    FROM usr_sat_ecd.ecd_rj100_balanco_patrimonial\\r\\n    GROUP BY id_ecd, cod_agl, descr_cod_agl\\r\\n) rj100 \\r\\n    ON rj100.id_ecd = ri051.id_ecd \\r\\n    AND rj100.cod_agl = ri051.cd_conta_plano_contas_ref\\r\\n\\r\\nORDER BY iden.cnpj, ph.dt_referencia, ph.cd_conta_anl;\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 3: SALDOS PERI\\u00d3DICOS\\r\\n-- ================================================================================\\r\\n\\r\\n-- RODAR NO PYTHON\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 4: BALAN\\u00c7O PATRIMONIAL\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_balanco_patrimonial;\\r\\nCREATE TABLE teste.ecd_balanco_patrimonial AS\\r\\n\\r\\nWITH saldos_bp AS (\\r\\n    SELECT\\r\\n        sc.id_ecd,\\r\\n        sc.cnpj,\\r\\n        sc.ano_referencia,\\r\\n        sc.data_fim_periodo,\\r\\n        sc.cd_conta_referencial,\\r\\n        sc.saldo_final_contabil\\r\\n    FROM teste.ecd_saldos_contas_v2 sc\\r\\n    WHERE sc.cd_conta_referencial IS NOT NULL\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    s.id_ecd,\\r\\n    s.cnpj,\\r\\n    s.ano_referencia,\\r\\n    s.data_fim_periodo,\\r\\n    \\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '1%' THEN s.saldo_final_contabil ELSE 0 END) AS ativo_total,\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '1.01%' THEN s.saldo_final_contabil ELSE 0 END) AS ativo_circulante,\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '1.02%' THEN s.saldo_final_contabil ELSE 0 END) AS ativo_nao_circulante,\\r\\n    \\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '2%' THEN s.saldo_final_contabil ELSE 0 END) AS passivo_pl_total,\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '2.01%' THEN s.saldo_final_contabil ELSE 0 END) AS passivo_circulante,\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '2.02%' THEN s.saldo_final_contabil ELSE 0 END) AS passivo_nao_circulante,\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '2.03%' THEN s.saldo_final_contabil ELSE 0 END) AS patrimonio_liquido,\\r\\n    \\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '2.01%' OR s.cd_conta_referencial LIKE '2.02%' \\r\\n        THEN s.saldo_final_contabil ELSE 0 END) AS passivo_total,\\r\\n    \\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '1%' THEN s.saldo_final_contabil ELSE 0 END) -\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '2%' THEN s.saldo_final_contabil ELSE 0 END) AS diferenca_bp\\r\\n\\r\\nFROM saldos_bp s\\r\\n\\r\\nGROUP BY s.id_ecd, s.cnpj, s.ano_referencia, s.data_fim_periodo\\r\\n\\r\\nORDER BY s.cnpj, s.ano_referencia, s.data_fim_periodo;\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 5: DRE\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_dre;\\r\\nCREATE TABLE teste.ecd_dre AS\\r\\n\\r\\nWITH saldos_dre AS (\\r\\n    SELECT\\r\\n        sc.id_ecd,\\r\\n        sc.cnpj,\\r\\n        sc.ano_referencia,\\r\\n        sc.data_fim_periodo,\\r\\n        sc.cd_conta_referencial,\\r\\n        sc.saldo_final_contabil\\r\\n    FROM teste.ecd_saldos_contas_v2 sc\\r\\n    WHERE sc.cd_conta_referencial IS NOT NULL\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    s.id_ecd,\\r\\n    s.cnpj,\\r\\n    s.ano_referencia,\\r\\n    s.data_fim_periodo,\\r\\n    \\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.01%' THEN s.saldo_final_contabil ELSE 0 END) AS receita_bruta,\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.02%' THEN s.saldo_final_contabil ELSE 0 END) AS deducoes_receita,\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.01%' THEN s.saldo_final_contabil ELSE 0 END) +\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.02%' THEN s.saldo_final_contabil ELSE 0 END) AS receita_liquida,\\r\\n    \\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.03%' THEN s.saldo_final_contabil ELSE 0 END) AS custos_totais,\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.04%' THEN s.saldo_final_contabil ELSE 0 END) AS despesas_totais,\\r\\n    \\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.01%' THEN s.saldo_final_contabil ELSE 0 END) +\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.02%' THEN s.saldo_final_contabil ELSE 0 END) +\\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3.03%' THEN s.saldo_final_contabil ELSE 0 END) AS lucro_bruto,\\r\\n    \\r\\n    SUM(CASE WHEN s.cd_conta_referencial LIKE '3%' THEN s.saldo_final_contabil ELSE 0 END) AS resultado_liquido\\r\\n\\r\\nFROM saldos_dre s\\r\\n\\r\\nGROUP BY s.id_ecd, s.cnpj, s.ano_referencia, s.data_fim_periodo\\r\\n\\r\\nORDER BY s.cnpj, s.ano_referencia, s.data_fim_periodo;\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- VALIDA\\u00c7\\u00d5ES\\r\\n-- ================================================================================\\r\\n\\r\\nSELECT 'ecd_empresas_cadastro' AS tabela, COUNT(*) AS qtd, COUNT(DISTINCT cnpj) AS empresas\\r\\nFROM teste.ecd_empresas_cadastro\\r\\nUNION ALL\\r\\nSELECT 'ecd_plano_contas', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_plano_contas\\r\\nUNION ALL\\r\\nSELECT 'ecd_saldos_contas_v2', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_saldos_contas_v2\\r\\nUNION ALL\\r\\nSELECT 'ecd_balanco_patrimonial', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_balanco_patrimonial\\r\\nUNION ALL\\r\\nSELECT 'ecd_dre', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_dre;\\r\\n\", \"lastExecutedSelectionRange\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 392, \"column\": 0}}, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false, \"lastCheckStatusRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"query_status\\\": {\\\"status\\\": \\\"available\\\"}}\", \"responseJSON\": {\"status\": 0, \"query_status\": {\"status\": \"available\"}}, \"status\": 200, \"statusText\": \"OK\"}, \"lastGetLogsRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"logs\\\": \\\"Query 524401dd4f87ace3:30d7709400000000 100% Complete (913 out of 913)\\\", \\\"progress\\\": 100, \\\"jobs\\\": [{\\\"name\\\": \\\"524401dd4f87ace3:30d7709400000000\\\", \\\"url\\\": \\\"/hue/jobbrowser#!id=524401dd4f87ace3:30d7709400000000\\\", \\\"started\\\": true, \\\"finished\\\": false, \\\"percentJob\\\": 100}], \\\"isFullLogs\\\": false}\", \"responseJSON\": {\"status\": 0, \"logs\": \"Query 524401dd4f87ace3:30d7709400000000 100% Complete (913 out of 913)\", \"progress\": 100, \"jobs\": [{\"name\": \"524401dd4f87ace3:30d7709400000000\", \"url\": \"/hue/jobbrowser#!id=524401dd4f87ace3:30d7709400000000\", \"started\": true, \"finished\": false, \"percentJob\": 100}], \"isFullLogs\": false}, \"status\": 200, \"statusText\": \"OK\"}}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 9830, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 179, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false, \"is_history\": false}",
    "extra": "",
    "search": "-- ================================================================================\r\n-- ECD ONLINE - PARTE 1 [VERSÃO DEFINITIVA - 100% FUNCIONAL]\r\n-- ================================================================================\r\n-- ✅ Todos os campos TINYINT corrigidos\r\n-- ✅ Elimina 11.464 duplicatas\r\n-- ✅ Plano referencial completo (I051 + J100)\r\n-- ✅ Hierarquia de 3 níveis\r\n-- ================================================================================\r\n\r\nSET REQUEST_POOL = 'medium';\r\n\r\n-- ================================================================================\r\n-- TABELA 1: CADASTRO DE EMPRESAS (COM CNAE INTEGRADO)\r\n-- ================================================================================\r\n\r\nDROP TABLE IF EXISTS teste.ecd_empresas_cadastro;\r\nCREATE TABLE teste.ecd_empresas_cadastro AS\r\n\r\nWITH ecd_mais_recente AS (\r\n    SELECT\r\n        id_ecd,\r\n        nu_cnpj,\r\n        dt_referencia,\r\n        dt_recepcao,\r\n        ROW_NUMBER() OVER (\r\n            PARTITION BY nu_cnpj, dt_referencia \r\n            ORDER BY dt_recepcao DESC, dt_criacao DESC\r\n        ) AS rn\r\n    FROM usr_sat_ecd.ecd_controle\r\n    WHERE nu_cnpj IS NOT NULL\r\n),\r\n\r\nempresas_base AS (\r\n    SELECT DISTINCT\r\n        r0000.id_ecd,\r\n        REGEXP_REPLACE(TRIM(r0000.nu_cnpj), '[^0-9]', '') AS cnpj,\r\n        r0000.nm_empresarial,\r\n        r0000.cd_uf,\r\n        r0000.nu_ie,\r\n        r0000.cd_municipio,\r\n        r0000.nu_im,\r\n        r0000.ind_sit_especial,\r\n        r0000.ind_sit_inicio_periodo,\r\n        r0000.ind_grande_porte,\r\n        r0000.tp_ecd,\r\n        r0000.dt_inicio,\r\n        r0000.dt_fim,\r\n        r0000.dt_referencia,\r\n        r0000.ano_dt_criacao_ecd_ctrl,\r\n        r0000.mes_dt_criacao_ecd_ctrl\r\n    FROM usr_sat_ecd.ecd_r0000_identificacao r0000\r\n    INNER JOIN ecd_mais_recente emr \r\n        ON r0000.id_ecd = emr.id_ecd\r\n        AND emr.rn = 1\r\n    WHERE r0000.nu_cnpj IS NOT NULL\r\n        AND LENGTH(REGEXP_REPLACE(TRIM(r0000.nu_cnpj), '[^0-9]', '')) = 14\r\n),\r\n\r\ncnae_lookup AS",
    "last_modified": "2025-11-11T18:36:31.152",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "bb81055a-5ce8-40f4-947b-e794da0b0493",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 167936,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "ECD: 2 Criação tbls",
    "description": "",
    "uuid": "85d661c9-6e75-8053-1dca-0de8e28a2ee2",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 167936, \"uuid\": \"e7a53c8b-aa9a-4008-8189-bab71e8dd35e\", \"name\": \"ECD: 2 Cria\\u00e7\\u00e3o tbls\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": \"85d661c9-6e75-8053-1dca-0de8e28a2ee2\", \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"bdfb30ae-71e2-1e0f-2d04-3fac3eac06cc\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 522, \"column\": 0}, \"errors\": [{\"message\": \"ParseException: Syntax error in line 429:undefined:\\n...==========================\\n                            ^\\nEncountered: EOF\\nExpected: ALTER, COMMENT, COMPUTE, COPY, CREATE, DELETE, DESCRIBE, DROP, EXPLAIN, GRANT, INSERT, INVALIDATE, LOAD, REFRESH, REVOKE, SELECT, SET, SHOW, TRUNCATE, UNSET, UPDATE, UPSERT, USE, VALUES, WITH\\n\\n\\nCAUSED BY: Exception: Syntax error\\n\", \"help\": null, \"line\": 428}], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": false, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"usr_sat_ecd\", \"currentQueryTab\": \"queryHistory\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- ================================================================================\\r\\n-- ECD ONLINE - PARTE 2 [VERS\\u00c3O DEFINITIVA]\\r\\n-- ================================================================================\\r\\n-- Indicadores, Scores, NEAF e An\\u00e1lises\\r\\n-- Compat\\u00edvel com PARTE 1 Definitiva\\r\\n-- ================================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 6: INDICADORES FINANCEIROS E ECON\\u00d4MICOS\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_indicadores_financeiros;\\r\\nCREATE TABLE teste.ecd_indicadores_financeiros AS\\r\\n\\r\\nSELECT\\r\\n    bp.id_ecd,\\r\\n    bp.cnpj,\\r\\n    bp.ano_referencia,\\r\\n    bp.data_fim_periodo,\\r\\n    \\r\\n    -- Valores base\\r\\n    bp.ativo_total,\\r\\n    bp.ativo_circulante,\\r\\n    bp.ativo_nao_circulante,\\r\\n    bp.passivo_total,\\r\\n    bp.passivo_circulante,\\r\\n    bp.passivo_nao_circulante,\\r\\n    bp.patrimonio_liquido,\\r\\n    dre.receita_liquida,\\r\\n    dre.lucro_bruto,\\r\\n    dre.resultado_liquido,\\r\\n    dre.custos_totais,\\r\\n    dre.despesas_totais,\\r\\n    \\r\\n    -- LIQUIDEZ\\r\\n    CASE \\r\\n        WHEN bp.passivo_circulante > 0 \\r\\n        THEN ROUND(bp.ativo_circulante / bp.passivo_circulante, 4)\\r\\n        ELSE NULL\\r\\n    END AS liquidez_corrente,\\r\\n    \\r\\n    CASE \\r\\n        WHEN (bp.passivo_circulante + bp.passivo_nao_circulante) > 0 \\r\\n        THEN ROUND(bp.ativo_total / (bp.passivo_circulante + bp.passivo_nao_circulante), 4)\\r\\n        ELSE NULL\\r\\n    END AS liquidez_geral,\\r\\n    \\r\\n    -- ENDIVIDAMENTO\\r\\n    CASE \\r\\n        WHEN bp.ativo_total > 0 \\r\\n        THEN ROUND((bp.passivo_circulante + bp.passivo_nao_circulante) / bp.ativo_total, 4)\\r\\n        ELSE NULL\\r\\n    END AS endividamento_geral,\\r\\n    \\r\\n    CASE \\r\\n        WHEN bp.patrimonio_liquido > 0 \\r\\n        THEN ROUND((bp.passivo_circulante + bp.passivo_nao_circulante) / bp.patrimonio_liquido, 4)\\r\\n        ELSE NULL\\r\\n    END AS composicao_endividamento,\\r\\n    \\r\\n    -- RENTABILIDADE\\r\\n    CASE \\r\\n        WHEN dre.receita_liquida > 0 \\r\\n        THEN ROUND(dre.resultado_liquido / dre.receita_liquida * 100, 4)\\r\\n        ELSE NULL\\r\\n    END AS margem_liquida_perc,\\r\\n    \\r\\n    CASE \\r\\n        WHEN dre.receita_liquida > 0 \\r\\n        THEN ROUND(dre.lucro_bruto / dre.receita_liquida * 100, 4)\\r\\n        ELSE NULL\\r\\n    END AS margem_bruta_perc,\\r\\n    \\r\\n    CASE \\r\\n        WHEN bp.ativo_total > 0 \\r\\n        THEN ROUND(dre.resultado_liquido / bp.ativo_total * 100, 4)\\r\\n        ELSE NULL\\r\\n    END AS roa_retorno_ativo_perc,\\r\\n    \\r\\n    CASE \\r\\n        WHEN bp.patrimonio_liquido > 0 \\r\\n        THEN ROUND(dre.resultado_liquido / bp.patrimonio_liquido * 100, 4)\\r\\n        ELSE NULL\\r\\n    END AS roe_retorno_patrimonio_perc\\r\\n\\r\\nFROM teste.ecd_balanco_patrimonial bp\\r\\nINNER JOIN teste.ecd_dre dre\\r\\n    ON bp.id_ecd = dre.id_ecd\\r\\n    AND bp.ano_referencia = dre.ano_referencia\\r\\n    AND bp.data_fim_periodo = dre.data_fim_periodo\\r\\n\\r\\nORDER BY bp.cnpj, bp.ano_referencia, bp.data_fim_periodo;\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 7: INTEGRA\\u00c7\\u00c3O COM NEAF - IND\\u00cdCIOS\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_neaf_indicios;\\r\\nCREATE TABLE teste.ecd_neaf_indicios AS\\r\\n\\r\\nWITH indicios_base AS (\\r\\n    SELECT\\r\\n        REGEXP_REPLACE(TRIM(ei.nu_cpf_cnpj), '[^0-9]', '') AS cnpj,\\r\\n        ei.tx_descricao_indicio AS descricao_indicio,\\r\\n        ic.tx_descricao_complemento AS complemento_indicio\\r\\n    FROM neaf.empresa_indicio ei\\r\\n    JOIN ei.indicio_complemento ic\\r\\n    WHERE ei.cd_atual = 1\\r\\n        AND LENGTH(REGEXP_REPLACE(TRIM(ei.nu_cpf_cnpj), '[^0-9]', '')) = 14\\r\\n        AND REGEXP_REPLACE(TRIM(ei.nu_cpf_cnpj), '[^0-9]', '') IN (\\r\\n            SELECT DISTINCT cnpj FROM teste.ecd_empresas_cadastro\\r\\n        )\\r\\n),\\r\\n\\r\\ncontadores AS (\\r\\n    SELECT\\r\\n        cnpj,\\r\\n        COUNT(*) AS qtd_total_indicios,\\r\\n        COUNT(DISTINCT descricao_indicio) AS qtd_tipos_indicios\\r\\n    FROM indicios_base\\r\\n    GROUP BY cnpj\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    ib.cnpj,\\r\\n    ib.descricao_indicio,\\r\\n    ib.complemento_indicio,\\r\\n    c.qtd_total_indicios,\\r\\n    c.qtd_tipos_indicios\\r\\nFROM indicios_base ib\\r\\nINNER JOIN contadores c ON ib.cnpj = c.cnpj\\r\\n\\r\\nORDER BY ib.cnpj, ib.descricao_indicio;\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 8: SCORE DE RISCO NEAF\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_neaf_score_risco;\\r\\nCREATE TABLE teste.ecd_neaf_score_risco AS\\r\\n\\r\\nWITH metricas_indicios AS (\\r\\n    SELECT\\r\\n        cnpj,\\r\\n        COUNT(*) AS qtd_total_indicios,\\r\\n        COUNT(DISTINCT descricao_indicio) AS qtd_tipos_indicios_distintos\\r\\n    FROM teste.ecd_neaf_indicios\\r\\n    GROUP BY cnpj\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    mi.cnpj,\\r\\n    mi.qtd_total_indicios,\\r\\n    mi.qtd_tipos_indicios_distintos,\\r\\n    \\r\\n    LEAST(\\r\\n        ROUND(\\r\\n            (mi.qtd_tipos_indicios_distintos * 2.0) +\\r\\n            (mi.qtd_total_indicios * 0.5), 2)\\r\\n    , 10) AS score_risco_neaf,\\r\\n    \\r\\n    CASE \\r\\n        WHEN LEAST(ROUND((mi.qtd_tipos_indicios_distintos * 2.0) + (mi.qtd_total_indicios * 0.5), 2), 10) >= 8 \\r\\n            THEN 'RISCO CR\\u00cdTICO'\\r\\n        WHEN LEAST(ROUND((mi.qtd_tipos_indicios_distintos * 2.0) + (mi.qtd_total_indicios * 0.5), 2), 10) >= 5 \\r\\n            THEN 'RISCO ALTO'\\r\\n        WHEN LEAST(ROUND((mi.qtd_tipos_indicios_distintos * 2.0) + (mi.qtd_total_indicios * 0.5), 2), 10) >= 3 \\r\\n            THEN 'RISCO MODERADO'\\r\\n        ELSE 'RISCO BAIXO'\\r\\n    END AS classificacao_risco_neaf\\r\\n\\r\\nFROM metricas_indicios mi\\r\\n\\r\\nORDER BY score_risco_neaf DESC, cnpj;\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 9: INCONSIST\\u00caNCIAS - EQUA\\u00c7\\u00c3O CONT\\u00c1BIL\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_inconsistencias_equacao;\\r\\nCREATE TABLE teste.ecd_inconsistencias_equacao AS\\r\\n\\r\\nSELECT\\r\\n    id_ecd,\\r\\n    cnpj,\\r\\n    ano_referencia,\\r\\n    data_fim_periodo,\\r\\n    ativo_total,\\r\\n    passivo_pl_total,\\r\\n    diferenca_bp AS diferenca_absoluta,\\r\\n    \\r\\n    CASE \\r\\n        WHEN ativo_total > 0 \\r\\n        THEN ROUND(ABS(diferenca_bp) / ativo_total * 100, 4)\\r\\n        ELSE NULL\\r\\n    END AS percentual_diferenca,\\r\\n    \\r\\n    CASE \\r\\n        WHEN ABS(diferenca_bp) < 0.01 THEN 'OK'\\r\\n        WHEN ABS(diferenca_bp) < 1 THEN 'Diferen\\u00e7a M\\u00ednima'\\r\\n        WHEN ABS(diferenca_bp) < 1000 THEN 'Diferen\\u00e7a Pequena'\\r\\n        WHEN ABS(diferenca_bp) < 10000 THEN 'Diferen\\u00e7a Moderada'\\r\\n        WHEN ABS(diferenca_bp) < 100000 THEN 'Diferen\\u00e7a Significativa'\\r\\n        ELSE 'Diferen\\u00e7a Cr\\u00edtica'\\r\\n    END AS classificacao_inconsistencia,\\r\\n    \\r\\n    CASE \\r\\n        WHEN ABS(diferenca_bp) < 0.01 THEN 0\\r\\n        WHEN ABS(diferenca_bp) < 1 THEN 1\\r\\n        WHEN ABS(diferenca_bp) < 1000 THEN 3\\r\\n        WHEN ABS(diferenca_bp) < 10000 THEN 5\\r\\n        WHEN ABS(diferenca_bp) < 100000 THEN 7\\r\\n        ELSE 10\\r\\n    END AS score_risco_equacao\\r\\n\\r\\nFROM teste.ecd_balanco_patrimonial\\r\\n\\r\\nWHERE ABS(diferenca_bp) >= 0.01\\r\\n\\r\\nORDER BY ABS(diferenca_bp) DESC, cnpj, ano_referencia;\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 10: INCONSIST\\u00caNCIAS - VARIA\\u00c7\\u00d5ES ANORMAIS (OTIMIZADA)\\r\\n-- ================================================================================\\r\\n-- ESTRAT\\u00c9GIA: Agregar primeiro, depois calcular varia\\u00e7\\u00f5es\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_inconsistencias_variacoes;\\r\\nCREATE TABLE teste.ecd_inconsistencias_variacoes AS\\r\\n\\r\\nWITH saldos_agregados_ano AS (\\r\\n    -- \\u2705 CORRE\\u00c7\\u00c3O: Agregar por ANO COMPLETO (soma de todos os meses)\\r\\n    SELECT\\r\\n        cnpj,\\r\\n        ano_referencia,  -- J\\u00e1 est\\u00e1 em formato YYYY (2024)\\r\\n        cd_conta_referencial,\\r\\n        SUM(saldo_final_contabil) AS saldo_total_ano  -- Soma de todos os meses do ano\\r\\n    FROM teste.ecd_saldos_contas_v2\\r\\n    WHERE cd_conta_referencial IS NOT NULL\\r\\n        AND cd_conta_referencial LIKE '1.%'  -- Apenas ATIVO\\r\\n    GROUP BY cnpj, ano_referencia, cd_conta_referencial\\r\\n),\\r\\n\\r\\nsaldos_comparacao AS (\\r\\n    SELECT\\r\\n        cnpj,\\r\\n        ano_referencia,\\r\\n        cd_conta_referencial,\\r\\n        saldo_total_ano AS saldo_atual,\\r\\n        LAG(saldo_total_ano) OVER (\\r\\n            PARTITION BY cnpj, cd_conta_referencial \\r\\n            ORDER BY ano_referencia  -- Agora vai comparar 2024 com 2023 corretamente\\r\\n        ) AS saldo_anterior\\r\\n    FROM saldos_agregados_ano\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    sc.cnpj,\\r\\n    sc.ano_referencia,\\r\\n    sc.cd_conta_referencial AS cd_conta,\\r\\n    sc.saldo_anterior,\\r\\n    sc.saldo_atual,\\r\\n    sc.saldo_atual - sc.saldo_anterior AS variacao_absoluta,\\r\\n    \\r\\n    CASE \\r\\n        WHEN sc.saldo_anterior != 0 AND ABS(sc.saldo_anterior) >= 100\\r\\n        THEN ROUND(((sc.saldo_atual - sc.saldo_anterior) / ABS(sc.saldo_anterior)) * 100, 2)\\r\\n        ELSE NULL\\r\\n    END AS variacao_percentual,\\r\\n    \\r\\n    CASE \\r\\n        WHEN sc.saldo_anterior = 0 OR ABS(sc.saldo_anterior) < 100 THEN 'Varia\\u00e7\\u00e3o de Saldo Pequeno'\\r\\n        WHEN ABS(ROUND(((sc.saldo_atual - sc.saldo_anterior) / ABS(sc.saldo_anterior)) * 100, 2)) >= 1000 \\r\\n            THEN 'Varia\\u00e7\\u00e3o Extrema'\\r\\n        WHEN ABS(ROUND(((sc.saldo_atual - sc.saldo_anterior) / ABS(sc.saldo_anterior)) * 100, 2)) >= 500 \\r\\n            THEN 'Varia\\u00e7\\u00e3o Muito Alta'\\r\\n        WHEN ABS(ROUND(((sc.saldo_atual - sc.saldo_anterior) / ABS(sc.saldo_anterior)) * 100, 2)) >= 200 \\r\\n            THEN 'Varia\\u00e7\\u00e3o Alta'\\r\\n        WHEN ABS(ROUND(((sc.saldo_atual - sc.saldo_anterior) / ABS(sc.saldo_anterior)) * 100, 2)) >= 100 \\r\\n            THEN 'Varia\\u00e7\\u00e3o Significativa'\\r\\n        ELSE 'Varia\\u00e7\\u00e3o Moderada'\\r\\n    END AS classificacao_variacao,\\r\\n    \\r\\n    CASE \\r\\n        WHEN sc.saldo_anterior = 0 OR ABS(sc.saldo_anterior) < 100 THEN 0\\r\\n        WHEN ABS(ROUND(((sc.saldo_atual - sc.saldo_anterior) / ABS(sc.saldo_anterior)) * 100, 2)) >= 1000 THEN 10\\r\\n        WHEN ABS(ROUND(((sc.saldo_atual - sc.saldo_anterior) / ABS(sc.saldo_anterior)) * 100, 2)) >= 500 THEN 8\\r\\n        WHEN ABS(ROUND(((sc.saldo_atual - sc.saldo_anterior) / ABS(sc.saldo_anterior)) * 100, 2)) >= 200 THEN 6\\r\\n        WHEN ABS(ROUND(((sc.saldo_atual - sc.saldo_anterior) / ABS(sc.saldo_anterior)) * 100, 2)) >= 100 THEN 4\\r\\n        ELSE 2\\r\\n    END AS score_risco_variacao\\r\\n\\r\\nFROM saldos_comparacao sc\\r\\n\\r\\nWHERE sc.saldo_anterior IS NOT NULL\\r\\n    AND ABS(sc.saldo_anterior) >= 100\\r\\n    AND ABS(ROUND(((sc.saldo_atual - sc.saldo_anterior) / ABS(sc.saldo_anterior)) * 100, 2)) >= 100\\r\\n\\r\\nORDER BY score_risco_variacao DESC, ABS(sc.saldo_atual - sc.saldo_anterior) DESC\\r\\nLIMIT 50000;\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 11: BENCHMARK SETORIAL (COM CNAE)\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_benchmark_setorial;\\r\\nCREATE TABLE teste.ecd_benchmark_setorial AS\\r\\n\\r\\nWITH metricas_empresa AS (\\r\\n    SELECT\\r\\n        ec.cnpj,\\r\\n        ec.cd_cnae,\\r\\n        ec.de_cnae,\\r\\n        ec.cnae_secao,\\r\\n        ec.cnae_secao_descricao,\\r\\n        ec.cnae_divisao,\\r\\n        ec.cnae_divisao_descricao,\\r\\n        ec.ano_referencia,\\r\\n        ind.ativo_total,\\r\\n        ind.receita_liquida,\\r\\n        ind.resultado_liquido,\\r\\n        ind.liquidez_corrente,\\r\\n        ind.endividamento_geral,\\r\\n        ind.margem_liquida_perc,\\r\\n        ind.roe_retorno_patrimonio_perc\\r\\n    FROM teste.ecd_empresas_cadastro ec\\r\\n    INNER JOIN teste.ecd_indicadores_financeiros ind\\r\\n        ON ec.cnpj = ind.cnpj\\r\\n        AND ec.ano_referencia = ind.ano_referencia\\r\\n    WHERE ec.cd_cnae IS NOT NULL\\r\\n        AND ind.ativo_total IS NOT NULL\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    me.cd_cnae,\\r\\n    me.de_cnae,\\r\\n    me.cnae_secao,\\r\\n    me.cnae_secao_descricao,\\r\\n    me.cnae_divisao,\\r\\n    me.cnae_divisao_descricao,\\r\\n    me.ano_referencia,\\r\\n    \\r\\n    COUNT(DISTINCT me.cnpj) AS qtd_empresas_setor,\\r\\n    \\r\\n    -- Valores m\\u00e9dios do setor:\\r\\n    ROUND(AVG(me.ativo_total), 2) AS media_ativo_total_setor,\\r\\n    ROUND(AVG(me.receita_liquida), 2) AS media_receita_liquida_setor,\\r\\n    ROUND(AVG(me.resultado_liquido), 2) AS media_resultado_liquido_setor,\\r\\n    \\r\\n    -- Indicadores m\\u00e9dios do setor:\\r\\n    ROUND(AVG(me.liquidez_corrente), 4) AS media_liquidez_corrente_setor,\\r\\n    ROUND(AVG(me.endividamento_geral), 4) AS media_endividamento_setor,\\r\\n    ROUND(AVG(me.margem_liquida_perc), 2) AS media_margem_liquida_setor,\\r\\n    ROUND(AVG(me.roe_retorno_patrimonio_perc), 2) AS media_roe_setor,\\r\\n    \\r\\n    -- Min/Max para compara\\u00e7\\u00e3o:\\r\\n    ROUND(MIN(me.liquidez_corrente), 4) AS min_liquidez_setor,\\r\\n    ROUND(MAX(me.liquidez_corrente), 4) AS max_liquidez_setor,\\r\\n    ROUND(MIN(me.margem_liquida_perc), 2) AS min_margem_liquida_setor,\\r\\n    ROUND(MAX(me.margem_liquida_perc), 2) AS max_margem_liquida_setor\\r\\n\\r\\nFROM metricas_empresa me\\r\\n\\r\\nGROUP BY \\r\\n    me.cd_cnae,\\r\\n    me.de_cnae,\\r\\n    me.cnae_secao,\\r\\n    me.cnae_secao_descricao,\\r\\n    me.cnae_divisao,\\r\\n    me.cnae_divisao_descricao,\\r\\n    me.ano_referencia\\r\\n\\r\\nHAVING COUNT(DISTINCT me.cnpj) >= 3\\r\\n\\r\\nORDER BY me.cnae_secao, me.cd_cnae, me.ano_referencia;\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 12: SCORE CONSOLIDADO DE RISCO (COM CNAE E BENCHMARK)\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_score_risco_consolidado;\\r\\nCREATE TABLE teste.ecd_score_risco_consolidado AS\\r\\n\\r\\nWITH scores_equacao AS (\\r\\n    SELECT cnpj, ano_referencia, AVG(score_risco_equacao) AS score_equacao\\r\\n    FROM teste.ecd_inconsistencias_equacao\\r\\n    GROUP BY cnpj, ano_referencia\\r\\n),\\r\\n\\r\\nindicadores_base AS (\\r\\n    SELECT cnpj, ano_referencia, liquidez_corrente, endividamento_geral, \\r\\n           margem_liquida_perc, roe_retorno_patrimonio_perc\\r\\n    FROM teste.ecd_indicadores_financeiros\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    ec.cnpj,\\r\\n    ec.nm_razao_social AS razao_social,\\r\\n    ec.nm_fantasia,\\r\\n    ec.cd_uf AS uf,\\r\\n    ec.ano_referencia,\\r\\n    ec.empresa_grande_porte,\\r\\n    ec.tipo_ecd,\\r\\n    \\r\\n    -- CNAE:\\r\\n    ec.cd_cnae,\\r\\n    ec.de_cnae,\\r\\n    ec.cnae_secao,\\r\\n    ec.cnae_secao_descricao,\\r\\n    ec.cnae_divisao,\\r\\n    ec.cnae_divisao_descricao,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o fiscal:\\r\\n    ec.nm_tipo_contribuinte,\\r\\n    ec.nm_reg_apuracao,\\r\\n    ec.sn_simples_nacional_rfb,\\r\\n    ec.sit_cadastral_sefaz,\\r\\n    ec.nm_sit_cadastral_sefaz,\\r\\n    \\r\\n    -- Scores:\\r\\n    COALESCE(se.score_equacao, 0) AS score_equacao_contabil,\\r\\n    COALESCE(sn.score_risco_neaf, 0) AS score_neaf,\\r\\n    COALESCE(sn.qtd_total_indicios, 0) AS qtd_indicios_neaf,\\r\\n    \\r\\n    -- Indicadores da empresa:\\r\\n    ib.liquidez_corrente,\\r\\n    ib.endividamento_geral,\\r\\n    ib.margem_liquida_perc,\\r\\n    ib.roe_retorno_patrimonio_perc,\\r\\n    \\r\\n    -- Benchmark do setor (para compara\\u00e7\\u00e3o):\\r\\n    bench.media_liquidez_corrente_setor,\\r\\n    bench.media_margem_liquida_setor,\\r\\n    bench.media_roe_setor,\\r\\n    bench.qtd_empresas_setor,\\r\\n    \\r\\n    -- Score de risco financeiro:\\r\\n    CASE WHEN ib.liquidez_corrente < 1 THEN 3\\r\\n         WHEN ib.liquidez_corrente < 1.5 THEN 1\\r\\n         ELSE 0 END +\\r\\n    CASE WHEN ib.endividamento_geral > 0.8 THEN 3\\r\\n         WHEN ib.endividamento_geral > 0.6 THEN 1\\r\\n         ELSE 0 END +\\r\\n    CASE WHEN ib.margem_liquida_perc < 0 THEN 2\\r\\n         ELSE 0 END AS score_risco_financeiro,\\r\\n    \\r\\n    -- Score total:\\r\\n    ROUND(\\r\\n        (COALESCE(se.score_equacao, 0) * 0.30) +\\r\\n        (COALESCE(sn.score_risco_neaf, 0) * 0.30) +\\r\\n        ((CASE WHEN ib.liquidez_corrente < 1 THEN 3 WHEN ib.liquidez_corrente < 1.5 THEN 1 ELSE 0 END +\\r\\n          CASE WHEN ib.endividamento_geral > 0.8 THEN 3 WHEN ib.endividamento_geral > 0.6 THEN 1 ELSE 0 END +\\r\\n          CASE WHEN ib.margem_liquida_perc < 0 THEN 2 ELSE 0 END) * 0.40)\\r\\n    , 2) AS score_risco_total,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o de risco:\\r\\n    CASE \\r\\n        WHEN ROUND((COALESCE(se.score_equacao, 0) * 0.30) + (COALESCE(sn.score_risco_neaf, 0) * 0.30) +\\r\\n             ((CASE WHEN ib.liquidez_corrente < 1 THEN 3 WHEN ib.liquidez_corrente < 1.5 THEN 1 ELSE 0 END +\\r\\n               CASE WHEN ib.endividamento_geral > 0.8 THEN 3 WHEN ib.endividamento_geral > 0.6 THEN 1 ELSE 0 END +\\r\\n               CASE WHEN ib.margem_liquida_perc < 0 THEN 2 ELSE 0 END) * 0.40), 2) >= 7 THEN 'RISCO CR\\u00cdTICO'\\r\\n        WHEN ROUND((COALESCE(se.score_equacao, 0) * 0.30) + (COALESCE(sn.score_risco_neaf, 0) * 0.30) +\\r\\n             ((CASE WHEN ib.liquidez_corrente < 1 THEN 3 WHEN ib.liquidez_corrente < 1.5 THEN 1 ELSE 0 END +\\r\\n               CASE WHEN ib.endividamento_geral > 0.8 THEN 3 WHEN ib.endividamento_geral > 0.6 THEN 1 ELSE 0 END +\\r\\n               CASE WHEN ib.margem_liquida_perc < 0 THEN 2 ELSE 0 END) * 0.40), 2) >= 5 THEN 'RISCO ALTO'\\r\\n        WHEN ROUND((COALESCE(se.score_equacao, 0) * 0.30) + (COALESCE(sn.score_risco_neaf, 0) * 0.30) +\\r\\n             ((CASE WHEN ib.liquidez_corrente < 1 THEN 3 WHEN ib.liquidez_corrente < 1.5 THEN 1 ELSE 0 END +\\r\\n               CASE WHEN ib.endividamento_geral > 0.8 THEN 3 WHEN ib.endividamento_geral > 0.6 THEN 1 ELSE 0 END +\\r\\n               CASE WHEN ib.margem_liquida_perc < 0 THEN 2 ELSE 0 END) * 0.40), 2) >= 3 THEN 'RISCO MODERADO'\\r\\n        ELSE 'RISCO BAIXO'\\r\\n    END AS classificacao_risco,\\r\\n    \\r\\n    -- Compara\\u00e7\\u00e3o com setor (se empresa est\\u00e1 acima/abaixo da m\\u00e9dia):\\r\\n    CASE \\r\\n        WHEN ib.liquidez_corrente IS NULL OR bench.media_liquidez_corrente_setor IS NULL THEN NULL\\r\\n        WHEN ib.liquidez_corrente > bench.media_liquidez_corrente_setor THEN 'Acima da M\\u00e9dia'\\r\\n        WHEN ib.liquidez_corrente < bench.media_liquidez_corrente_setor THEN 'Abaixo da M\\u00e9dia'\\r\\n        ELSE 'Na M\\u00e9dia'\\r\\n    END AS posicao_liquidez_setor,\\r\\n    \\r\\n    CASE \\r\\n        WHEN ib.margem_liquida_perc IS NULL OR bench.media_margem_liquida_setor IS NULL THEN NULL\\r\\n        WHEN ib.margem_liquida_perc > bench.media_margem_liquida_setor THEN 'Acima da M\\u00e9dia'\\r\\n        WHEN ib.margem_liquida_perc < bench.media_margem_liquida_setor THEN 'Abaixo da M\\u00e9dia'\\r\\n        ELSE 'Na M\\u00e9dia'\\r\\n    END AS posicao_margem_setor\\r\\n\\r\\nFROM teste.ecd_empresas_cadastro ec\\r\\nLEFT JOIN scores_equacao se ON ec.cnpj = se.cnpj AND ec.ano_referencia = se.ano_referencia\\r\\nLEFT JOIN teste.ecd_neaf_score_risco sn ON ec.cnpj = sn.cnpj\\r\\nLEFT JOIN indicadores_base ib ON ec.cnpj = ib.cnpj AND ec.ano_referencia = ib.ano_referencia\\r\\nLEFT JOIN teste.ecd_benchmark_setorial bench \\r\\n    ON ec.cd_cnae = bench.cd_cnae \\r\\n    AND ec.ano_referencia = bench.ano_referencia\\r\\n\\r\\nORDER BY ec.cnpj, ec.ano_referencia;\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- VALIDA\\u00c7\\u00d5ES FINAIS\\r\\n-- ================================================================================\\r\\n\\r\\nSELECT 'ecd_indicadores_financeiros' AS tabela, COUNT(*) AS qtd, COUNT(DISTINCT cnpj) AS empresas FROM teste.ecd_indicadores_financeiros\\r\\nUNION ALL\\r\\nSELECT 'ecd_neaf_indicios', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_neaf_indicios\\r\\nUNION ALL\\r\\nSELECT 'ecd_neaf_score_risco', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_neaf_score_risco\\r\\nUNION ALL\\r\\nSELECT 'ecd_inconsistencias_equacao', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_inconsistencias_equacao\\r\\nUNION ALL\\r\\nSELECT 'ecd_inconsistencias_variacoes', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_inconsistencias_variacoes\\r\\nUNION ALL\\r\\nSELECT 'ecd_benchmark_setorial', COUNT(*), 0 FROM teste.ecd_benchmark_setorial\\r\\nUNION ALL\\r\\nSELECT 'ecd_score_risco_consolidado', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_score_risco_consolidado;\", \"statementsList\": [\"\\r\\nCREATE TABLE teste.ecd_neaf_indicios AS\\r\\n\\r\\nWITH indicios_base AS (\\r\\n    SELECT\\r\\n        REGEXP_REPLACE(TRIM(ei.nu_cpf_cnpj), '[^0-9]', '') AS cnpj,\\r\\n        ei.tx_descricao_indicio AS descricao_indicio,\\r\\n        ic.tx_descricao_complemento AS complemento_indicio\\r\\n    FROM neaf.empresa_indicio ei\\r\\n    JOIN ei.indicio_complemento ic\\r\\n    WHERE ei.cd_atual = 1\\r\\n        AND LENGTH(REGEXP_REPLACE(TRIM(ei.nu_cpf_cnpj), '[^0-9]', '')) = 14\\r\\n        AND REGEXP_REPLACE(TRIM(ei.nu_cpf_cnpj), '[^0-9]', '') IN (\\r\\n            SELECT DISTINCT cnpj FROM teste.ecd_empresas_cadastro\\r\\n        )\\r\\n),\\r\\n\\r\\ncontadores AS (\\r\\n    SELECT\\r\\n        cnpj,\\r\\n        COUNT(*) AS qtd_total_indicios,\\r\\n        COUNT(DISTINCT descricao_indicio) AS qtd_tipos_indicios\\r\\n    FROM indicios_base\\r\\n    GROUP BY cnpj\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    ib.cnpj,\\r\\n    ib.descricao_indicio,\\r\\n    ib.complemento_indicio,\\r\\n    c.qtd_total_indicios,\\r\\n    c.qtd_tipos_indicios\\r\\nFROM indicios_base ib\\r\\nINNER JOIN contadores c ON ib.cnpj = c.cnpj\\r\\n\\r\\nORDER BY ib.cnpj, ib.descricao_indicio;\", \"\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 8: SCORE DE RISCO NEAF\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_neaf_score_risco;\", \"\\r\\nCREATE TABLE teste.ecd_neaf_score_risco AS\\r\\n\\r\\nWITH metricas_indicios AS (\\r\\n    SELECT\\r\\n        cnpj,\\r\\n        COUNT(*) AS qtd_total_indicios,\\r\\n        COUNT(DISTINCT descricao_indicio) AS qtd_tipos_indicios_distintos\\r\\n    FROM teste.ecd_neaf_indicios\\r\\n    GROUP BY cnpj\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    mi.cnpj,\\r\\n    mi.qtd_total_indicios,\\r\\n    mi.qtd_tipos_indicios_distintos,\\r\\n    \\r\\n    LEAST(\\r\\n        ROUND(\\r\\n            (mi.qtd_tipos_indicios_distintos * 2.0) +\\r\\n            (mi.qtd_total_indicios * 0.5), 2)\\r\\n    , 10) AS score_risco_neaf,\\r\\n    \\r\\n    CASE \\r\\n        WHEN LEAST(ROUND((mi.qtd_tipos_indicios_distintos * 2.0) + (mi.qtd_total_indicios * 0.5), 2), 10) >= 8 \\r\\n            THEN 'RISCO CR\\u00cdTICO'\\r\\n        WHEN LEAST(ROUND((mi.qtd_tipos_indicios_distintos * 2.0) + (mi.qtd_total_indicios * 0.5), 2), 10) >= 5 \\r\\n            THEN 'RISCO ALTO'\\r\\n        WHEN LEAST(ROUND((mi.qtd_tipos_indicios_distintos * 2.0) + (mi.qtd_total_indicios * 0.5), 2), 10) >= 3 \\r\\n            THEN 'RISCO MODERADO'\\r\\n        ELSE 'RISCO BAIXO'\\r\\n    END AS classificacao_risco_neaf\\r\\n\\r\\nFROM metricas_indicios mi\\r\\n\\r\\nORDER BY score_risco_neaf DESC, cnpj;\", \"\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 9: INCONSIST\\u00caNCIAS - EQUA\\u00c7\\u00c3O CONT\\u00c1BIL\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_inconsistencias_equacao;\", \"\\r\\nCREATE TABLE teste.ecd_inconsistencias_equacao AS\\r\\n\\r\\nSELECT\\r\\n    id_ecd,\\r\\n    cnpj,\\r\\n    ano_referencia,\\r\\n    data_fim_periodo,\\r\\n    ativo_total,\\r\\n    passivo_pl_total,\\r\\n    diferenca_bp AS diferenca_absoluta,\\r\\n    \\r\\n    CASE \\r\\n        WHEN ativo_total > 0 \\r\\n        THEN ROUND(ABS(diferenca_bp) / ativo_total * 100, 4)\\r\\n        ELSE NULL\\r\\n    END AS percentual_diferenca,\\r\\n    \\r\\n    CASE \\r\\n        WHEN ABS(diferenca_bp) < 0.01 THEN 'OK'\\r\\n        WHEN ABS(diferenca_bp) < 1 THEN 'Diferen\\u00e7a M\\u00ednima'\\r\\n        WHEN ABS(diferenca_bp) < 1000 THEN 'Diferen\\u00e7a Pequena'\\r\\n        WHEN ABS(diferenca_bp) < 10000 THEN 'Diferen\\u00e7a Moderada'\\r\\n        WHEN ABS(diferenca_bp) < 100000 THEN 'Diferen\\u00e7a Significativa'\\r\\n        ELSE 'Diferen\\u00e7a Cr\\u00edtica'\\r\\n    END AS classificacao_inconsistencia,\\r\\n    \\r\\n    CASE \\r\\n        WHEN ABS(diferenca_bp) < 0.01 THEN 0\\r\\n        WHEN ABS(diferenca_bp) < 1 THEN 1\\r\\n        WHEN ABS(diferenca_bp) < 1000 THEN 3\\r\\n        WHEN ABS(diferenca_bp) < 10000 THEN 5\\r\\n        WHEN ABS(diferenca_bp) < 100000 THEN 7\\r\\n        ELSE 10\\r\\n    END AS score_risco_equacao\\r\\n\\r\\nFROM teste.ecd_balanco_patrimonial\\r\\n\\r\\nWHERE ABS(diferenca_bp) >= 0.01\\r\\n\\r\\nORDER BY ABS(diferenca_bp) DESC, cnpj, ano_referencia;\", \"\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 10: INCONSIST\\u00caNCIAS - VARIA\\u00c7\\u00d5ES ANORMAIS (OTIMIZADA)\\r\\n-- ================================================================================\\r\\n-- ESTRAT\\u00c9GIA: Agregar primeiro, depois calcular varia\\u00e7\\u00f5es\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_inconsistencias_variacoes;\", \"\\r\\nCREATE TABLE teste.ecd_inconsistencias_variacoes AS\\r\\n\\r\\nWITH saldos_agregados_ano AS (\\r\\n    -- \\u2705 CORRE\\u00c7\\u00c3O: Agregar por ANO COMPLETO (soma de todos os meses)\\r\\n    SELECT\\r\\n        cnpj,\\r\\n        ano_referencia,  -- J\\u00e1 est\\u00e1 em formato YYYY (2024)\\r\\n        cd_conta_referencial,\\r\\n        SUM(saldo_final_contabil) AS saldo_total_ano  -- Soma de todos os meses do ano\\r\\n    FROM teste.ecd_saldos_contas_v2\\r\\n    WHERE cd_conta_referencial IS NOT NULL\\r\\n        AND cd_conta_referencial LIKE '1.%'  -- Apenas ATIVO\\r\\n    GROUP BY cnpj, ano_referencia, cd_conta_referencial\\r\\n),\\r\\n\\r\\nsaldos_comparacao AS (\\r\\n    SELECT\\r\\n        cnpj,\\r\\n        ano_referencia,\\r\\n        cd_conta_referencial,\\r\\n        saldo_total_ano AS saldo_atual,\\r\\n        LAG(saldo_total_ano) OVER (\\r\\n            PARTITION BY cnpj, cd_conta_referencial \\r\\n            ORDER BY ano_referencia  -- Agora vai comparar 2024 com 2023 corretamente\\r\\n        ) AS saldo_anterior\\r\\n    FROM saldos_agregados_ano\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    sc.cnpj,\\r\\n    sc.ano_referencia,\\r\\n    sc.cd_conta_referencial AS cd_conta,\\r\\n    sc.saldo_anterior,\\r\\n    sc.saldo_atual,\\r\\n    sc.saldo_atual - sc.saldo_anterior AS variacao_absoluta,\\r\\n    \\r\\n    CASE \\r\\n        WHEN sc.saldo_anterior != 0 AND ABS(sc.saldo_anterior) >= 100\\r\\n        THEN ROUND(((sc.saldo_atual - sc.saldo_anterior) / ABS(sc.saldo_anterior)) * 100, 2)\\r\\n        ELSE NULL\\r\\n    END AS variacao_percentual,\\r\\n    \\r\\n    CASE \\r\\n        WHEN sc.saldo_anterior = 0 OR ABS(sc.saldo_anterior) < 100 THEN 'Varia\\u00e7\\u00e3o de Saldo Pequeno'\\r\\n        WHEN ABS(ROUND(((sc.saldo_atual - sc.saldo_anterior) / ABS(sc.saldo_anterior)) * 100, 2)) >= 1000 \\r\\n            THEN 'Varia\\u00e7\\u00e3o Extrema'\\r\\n        WHEN ABS(ROUND(((sc.saldo_atual - sc.saldo_anterior) / ABS(sc.saldo_anterior)) * 100, 2)) >= 500 \\r\\n            THEN 'Varia\\u00e7\\u00e3o Muito Alta'\\r\\n        WHEN ABS(ROUND(((sc.saldo_atual - sc.saldo_anterior) / ABS(sc.saldo_anterior)) * 100, 2)) >= 200 \\r\\n            THEN 'Varia\\u00e7\\u00e3o Alta'\\r\\n        WHEN ABS(ROUND(((sc.saldo_atual - sc.saldo_anterior) / ABS(sc.saldo_anterior)) * 100, 2)) >= 100 \\r\\n            THEN 'Varia\\u00e7\\u00e3o Significativa'\\r\\n        ELSE 'Varia\\u00e7\\u00e3o Moderada'\\r\\n    END AS classificacao_variacao,\\r\\n    \\r\\n    CASE \\r\\n        WHEN sc.saldo_anterior = 0 OR ABS(sc.saldo_anterior) < 100 THEN 0\\r\\n        WHEN ABS(ROUND(((sc.saldo_atual - sc.saldo_anterior) / ABS(sc.saldo_anterior)) * 100, 2)) >= 1000 THEN 10\\r\\n        WHEN ABS(ROUND(((sc.saldo_atual - sc.saldo_anterior) / ABS(sc.saldo_anterior)) * 100, 2)) >= 500 THEN 8\\r\\n        WHEN ABS(ROUND(((sc.saldo_atual - sc.saldo_anterior) / ABS(sc.saldo_anterior)) * 100, 2)) >= 200 THEN 6\\r\\n        WHEN ABS(ROUND(((sc.saldo_atual - sc.saldo_anterior) / ABS(sc.saldo_anterior)) * 100, 2)) >= 100 THEN 4\\r\\n        ELSE 2\\r\\n    END AS score_risco_variacao\\r\\n\\r\\nFROM saldos_comparacao sc\\r\\n\\r\\nWHERE sc.saldo_anterior IS NOT NULL\\r\\n    AND ABS(sc.saldo_anterior) >= 100\\r\\n    AND ABS(ROUND(((sc.saldo_atual - sc.saldo_anterior) / ABS(sc.saldo_anterior)) * 100, 2)) >= 100\\r\\n\\r\\nORDER BY score_risco_variacao DESC, ABS(sc.saldo_atual - sc.saldo_anterior) DESC\\r\\nLIMIT 50000;\", \"\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 11: BENCHMARK SETORIAL (COM CNAE)\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_benchmark_setorial;\", \"\\r\\nCREATE TABLE teste.ecd_benchmark_setorial AS\\r\\n\\r\\nWITH metricas_empresa AS (\\r\\n    SELECT\\r\\n        ec.cnpj,\\r\\n        ec.cd_cnae,\\r\\n        ec.de_cnae,\\r\\n        ec.cnae_secao,\\r\\n        ec.cnae_secao_descricao,\\r\\n        ec.cnae_divisao,\\r\\n        ec.cnae_divisao_descricao,\\r\\n        ec.ano_referencia,\\r\\n        ind.ativo_total,\\r\\n        ind.receita_liquida,\\r\\n        ind.resultado_liquido,\\r\\n        ind.liquidez_corrente,\\r\\n        ind.endividamento_geral,\\r\\n        ind.margem_liquida_perc,\\r\\n        ind.roe_retorno_patrimonio_perc\\r\\n    FROM teste.ecd_empresas_cadastro ec\\r\\n    INNER JOIN teste.ecd_indicadores_financeiros ind\\r\\n        ON ec.cnpj = ind.cnpj\\r\\n        AND ec.ano_referencia = ind.ano_referencia\\r\\n    WHERE ec.cd_cnae IS NOT NULL\\r\\n        AND ind.ativo_total IS NOT NULL\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    me.cd_cnae,\\r\\n    me.de_cnae,\\r\\n    me.cnae_secao,\\r\\n    me.cnae_secao_descricao,\\r\\n    me.cnae_divisao,\\r\\n    me.cnae_divisao_descricao,\\r\\n    me.ano_referencia,\\r\\n    \\r\\n    COUNT(DISTINCT me.cnpj) AS qtd_empresas_setor,\\r\\n    \\r\\n    -- Valores m\\u00e9dios do setor:\\r\\n    ROUND(AVG(me.ativo_total), 2) AS media_ativo_total_setor,\\r\\n    ROUND(AVG(me.receita_liquida), 2) AS media_receita_liquida_setor,\\r\\n    ROUND(AVG(me.resultado_liquido), 2) AS media_resultado_liquido_setor,\\r\\n    \\r\\n    -- Indicadores m\\u00e9dios do setor:\\r\\n    ROUND(AVG(me.liquidez_corrente), 4) AS media_liquidez_corrente_setor,\\r\\n    ROUND(AVG(me.endividamento_geral), 4) AS media_endividamento_setor,\\r\\n    ROUND(AVG(me.margem_liquida_perc), 2) AS media_margem_liquida_setor,\\r\\n    ROUND(AVG(me.roe_retorno_patrimonio_perc), 2) AS media_roe_setor,\\r\\n    \\r\\n    -- Min/Max para compara\\u00e7\\u00e3o:\\r\\n    ROUND(MIN(me.liquidez_corrente), 4) AS min_liquidez_setor,\\r\\n    ROUND(MAX(me.liquidez_corrente), 4) AS max_liquidez_setor,\\r\\n    ROUND(MIN(me.margem_liquida_perc), 2) AS min_margem_liquida_setor,\\r\\n    ROUND(MAX(me.margem_liquida_perc), 2) AS max_margem_liquida_setor\\r\\n\\r\\nFROM metricas_empresa me\\r\\n\\r\\nGROUP BY \\r\\n    me.cd_cnae,\\r\\n    me.de_cnae,\\r\\n    me.cnae_secao,\\r\\n    me.cnae_secao_descricao,\\r\\n    me.cnae_divisao,\\r\\n    me.cnae_divisao_descricao,\\r\\n    me.ano_referencia\\r\\n\\r\\nHAVING COUNT(DISTINCT me.cnpj) >= 3\\r\\n\\r\\nORDER BY me.cnae_secao, me.cd_cnae, me.ano_referencia;\", \"\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 12: SCORE CONSOLIDADO DE RISCO (COM CNAE E BENCHMARK)\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_score_risco_consolidado;\", \"\\r\\nCREATE TABLE teste.ecd_score_risco_consolidado AS\\r\\n\\r\\nWITH scores_equacao AS (\\r\\n    SELECT cnpj, ano_referencia, AVG(score_risco_equacao) AS score_equacao\\r\\n    FROM teste.ecd_inconsistencias_equacao\\r\\n    GROUP BY cnpj, ano_referencia\\r\\n),\\r\\n\\r\\nindicadores_base AS (\\r\\n    SELECT cnpj, ano_referencia, liquidez_corrente, endividamento_geral, \\r\\n           margem_liquida_perc, roe_retorno_patrimonio_perc\\r\\n    FROM teste.ecd_indicadores_financeiros\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    ec.cnpj,\\r\\n    ec.nm_razao_social AS razao_social,\\r\\n    ec.nm_fantasia,\\r\\n    ec.cd_uf AS uf,\\r\\n    ec.ano_referencia,\\r\\n    ec.empresa_grande_porte,\\r\\n    ec.tipo_ecd,\\r\\n    \\r\\n    -- CNAE:\\r\\n    ec.cd_cnae,\\r\\n    ec.de_cnae,\\r\\n    ec.cnae_secao,\\r\\n    ec.cnae_secao_descricao,\\r\\n    ec.cnae_divisao,\\r\\n    ec.cnae_divisao_descricao,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o fiscal:\\r\\n    ec.nm_tipo_contribuinte,\\r\\n    ec.nm_reg_apuracao,\\r\\n    ec.sn_simples_nacional_rfb,\\r\\n    ec.sit_cadastral_sefaz,\\r\\n    ec.nm_sit_cadastral_sefaz,\\r\\n    \\r\\n    -- Scores:\\r\\n    COALESCE(se.score_equacao, 0) AS score_equacao_contabil,\\r\\n    COALESCE(sn.score_risco_neaf, 0) AS score_neaf,\\r\\n    COALESCE(sn.qtd_total_indicios, 0) AS qtd_indicios_neaf,\\r\\n    \\r\\n    -- Indicadores da empresa:\\r\\n    ib.liquidez_corrente,\\r\\n    ib.endividamento_geral,\\r\\n    ib.margem_liquida_perc,\\r\\n    ib.roe_retorno_patrimonio_perc,\\r\\n    \\r\\n    -- Benchmark do setor (para compara\\u00e7\\u00e3o):\\r\\n    bench.media_liquidez_corrente_setor,\\r\\n    bench.media_margem_liquida_setor,\\r\\n    bench.media_roe_setor,\\r\\n    bench.qtd_empresas_setor,\\r\\n    \\r\\n    -- Score de risco financeiro:\\r\\n    CASE WHEN ib.liquidez_corrente < 1 THEN 3\\r\\n         WHEN ib.liquidez_corrente < 1.5 THEN 1\\r\\n         ELSE 0 END +\\r\\n    CASE WHEN ib.endividamento_geral > 0.8 THEN 3\\r\\n         WHEN ib.endividamento_geral > 0.6 THEN 1\\r\\n         ELSE 0 END +\\r\\n    CASE WHEN ib.margem_liquida_perc < 0 THEN 2\\r\\n         ELSE 0 END AS score_risco_financeiro,\\r\\n    \\r\\n    -- Score total:\\r\\n    ROUND(\\r\\n        (COALESCE(se.score_equacao, 0) * 0.30) +\\r\\n        (COALESCE(sn.score_risco_neaf, 0) * 0.30) +\\r\\n        ((CASE WHEN ib.liquidez_corrente < 1 THEN 3 WHEN ib.liquidez_corrente < 1.5 THEN 1 ELSE 0 END +\\r\\n          CASE WHEN ib.endividamento_geral > 0.8 THEN 3 WHEN ib.endividamento_geral > 0.6 THEN 1 ELSE 0 END +\\r\\n          CASE WHEN ib.margem_liquida_perc < 0 THEN 2 ELSE 0 END) * 0.40)\\r\\n    , 2) AS score_risco_total,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o de risco:\\r\\n    CASE \\r\\n        WHEN ROUND((COALESCE(se.score_equacao, 0) * 0.30) + (COALESCE(sn.score_risco_neaf, 0) * 0.30) +\\r\\n             ((CASE WHEN ib.liquidez_corrente < 1 THEN 3 WHEN ib.liquidez_corrente < 1.5 THEN 1 ELSE 0 END +\\r\\n               CASE WHEN ib.endividamento_geral > 0.8 THEN 3 WHEN ib.endividamento_geral > 0.6 THEN 1 ELSE 0 END +\\r\\n               CASE WHEN ib.margem_liquida_perc < 0 THEN 2 ELSE 0 END) * 0.40), 2) >= 7 THEN 'RISCO CR\\u00cdTICO'\\r\\n        WHEN ROUND((COALESCE(se.score_equacao, 0) * 0.30) + (COALESCE(sn.score_risco_neaf, 0) * 0.30) +\\r\\n             ((CASE WHEN ib.liquidez_corrente < 1 THEN 3 WHEN ib.liquidez_corrente < 1.5 THEN 1 ELSE 0 END +\\r\\n               CASE WHEN ib.endividamento_geral > 0.8 THEN 3 WHEN ib.endividamento_geral > 0.6 THEN 1 ELSE 0 END +\\r\\n               CASE WHEN ib.margem_liquida_perc < 0 THEN 2 ELSE 0 END) * 0.40), 2) >= 5 THEN 'RISCO ALTO'\\r\\n        WHEN ROUND((COALESCE(se.score_equacao, 0) * 0.30) + (COALESCE(sn.score_risco_neaf, 0) * 0.30) +\\r\\n             ((CASE WHEN ib.liquidez_corrente < 1 THEN 3 WHEN ib.liquidez_corrente < 1.5 THEN 1 ELSE 0 END +\\r\\n               CASE WHEN ib.endividamento_geral > 0.8 THEN 3 WHEN ib.endividamento_geral > 0.6 THEN 1 ELSE 0 END +\\r\\n               CASE WHEN ib.margem_liquida_perc < 0 THEN 2 ELSE 0 END) * 0.40), 2) >= 3 THEN 'RISCO MODERADO'\\r\\n        ELSE 'RISCO BAIXO'\\r\\n    END AS classificacao_risco,\\r\\n    \\r\\n    -- Compara\\u00e7\\u00e3o com setor (se empresa est\\u00e1 acima/abaixo da m\\u00e9dia):\\r\\n    CASE \\r\\n        WHEN ib.liquidez_corrente IS NULL OR bench.media_liquidez_corrente_setor IS NULL THEN NULL\\r\\n        WHEN ib.liquidez_corrente > bench.media_liquidez_corrente_setor THEN 'Acima da M\\u00e9dia'\\r\\n        WHEN ib.liquidez_corrente < bench.media_liquidez_corrente_setor THEN 'Abaixo da M\\u00e9dia'\\r\\n        ELSE 'Na M\\u00e9dia'\\r\\n    END AS posicao_liquidez_setor,\\r\\n    \\r\\n    CASE \\r\\n        WHEN ib.margem_liquida_perc IS NULL OR bench.media_margem_liquida_setor IS NULL THEN NULL\\r\\n        WHEN ib.margem_liquida_perc > bench.media_margem_liquida_setor THEN 'Acima da M\\u00e9dia'\\r\\n        WHEN ib.margem_liquida_perc < bench.media_margem_liquida_setor THEN 'Abaixo da M\\u00e9dia'\\r\\n        ELSE 'Na M\\u00e9dia'\\r\\n    END AS posicao_margem_setor\\r\\n\\r\\nFROM teste.ecd_empresas_cadastro ec\\r\\nLEFT JOIN scores_equacao se ON ec.cnpj = se.cnpj AND ec.ano_referencia = se.ano_referencia\\r\\nLEFT JOIN teste.ecd_neaf_score_risco sn ON ec.cnpj = sn.cnpj\\r\\nLEFT JOIN indicadores_base ib ON ec.cnpj = ib.cnpj AND ec.ano_referencia = ib.ano_referencia\\r\\nLEFT JOIN teste.ecd_benchmark_setorial bench \\r\\n    ON ec.cd_cnae = bench.cd_cnae \\r\\n    AND ec.ano_referencia = bench.ano_referencia\\r\\n\\r\\nORDER BY ec.cnpj, ec.ano_referencia;\", \"\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- VALIDA\\u00c7\\u00d5ES FINAIS\\r\\n-- ================================================================================\\r\\n\\r\\nSELECT 'ecd_indicadores_financeiros' AS tabela, COUNT(*) AS qtd, COUNT(DISTINCT cnpj) AS empresas FROM teste.ecd_indicadores_financeiros\\r\\nUNION ALL\\r\\nSELECT 'ecd_neaf_indicios', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_neaf_indicios\\r\\nUNION ALL\\r\\nSELECT 'ecd_neaf_score_risco', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_neaf_score_risco\\r\\nUNION ALL\\r\\nSELECT 'ecd_inconsistencias_equacao', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_inconsistencias_equacao\\r\\nUNION ALL\\r\\nSELECT 'ecd_inconsistencias_variacoes', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_inconsistencias_variacoes\\r\\nUNION ALL\\r\\nSELECT 'ecd_benchmark_setorial', COUNT(*), 0 FROM teste.ecd_benchmark_setorial\\r\\nUNION ALL\\r\\nSELECT 'ecd_score_risco_consolidado', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_score_risco_consolidado;\"], \"aceSize\": 100, \"status\": \"failed\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"\\r\\nCREATE TABLE teste.ecd_score_risco_consolidado AS\\r\\n\\r\\nWITH scores_equacao AS (\\r\\n    SELECT cnpj, ano_referencia, AVG(score_risco_equacao) AS score_equacao\\r\\n    FROM teste.ecd_inconsistencias_equacao\\r\\n    GROUP BY cnpj, ano_referencia\\r\\n),\\r\\n\\r\\nindicadores_base AS (\\r\\n    SELECT cnpj, ano_referencia, liquidez_corrente, endividamento_geral, \\r\\n           margem_liquida_perc, roe_retorno_patrimonio_perc\\r\\n    FROM teste.ecd_indicadores_financeiros\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    ec.cnpj,\\r\\n    ec.nm_razao_social AS razao_social,\\r\\n    ec.nm_fantasia,\\r\\n    ec.cd_uf AS uf,\\r\\n    ec.ano_referencia,\\r\\n    ec.empresa_grande_porte,\\r\\n    ec.tipo_ecd,\\r\\n    \\r\\n    -- CNAE:\\r\\n    ec.cd_cnae,\\r\\n    ec.de_cnae,\\r\\n    ec.cnae_secao,\\r\\n    ec.cnae_secao_descricao,\\r\\n    ec.cnae_divisao,\\r\\n    ec.cnae_divisao_descricao,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o fiscal:\\r\\n    ec.nm_tipo_contribuinte,\\r\\n    ec.nm_reg_apuracao,\\r\\n    ec.sn_simples_nacional_rfb,\\r\\n    ec.sit_cadastral_sefaz,\\r\\n    ec.nm_sit_cadastral_sefaz,\\r\\n    \\r\\n    -- Scores:\\r\\n    COALESCE(se.score_equacao, 0) AS score_equacao_contabil,\\r\\n    COALESCE(sn.score_risco_neaf, 0) AS score_neaf,\\r\\n    COALESCE(sn.qtd_total_indicios, 0) AS qtd_indicios_neaf,\\r\\n    \\r\\n    -- Indicadores da empresa:\\r\\n    ib.liquidez_corrente,\\r\\n    ib.endividamento_geral,\\r\\n    ib.margem_liquida_perc,\\r\\n    ib.roe_retorno_patrimonio_perc,\\r\\n    \\r\\n    -- Benchmark do setor (para compara\\u00e7\\u00e3o):\\r\\n    bench.media_liquidez_corrente_setor,\\r\\n    bench.media_margem_liquida_setor,\\r\\n    bench.media_roe_setor,\\r\\n    bench.qtd_empresas_setor,\\r\\n    \\r\\n    -- Score de risco financeiro:\\r\\n    CASE WHEN ib.liquidez_corrente < 1 THEN 3\\r\\n         WHEN ib.liquidez_corrente < 1.5 THEN 1\\r\\n         ELSE 0 END +\\r\\n    CASE WHEN ib.endividamento_geral > 0.8 THEN 3\\r\\n         WHEN ib.endividamento_geral > 0.6 THEN 1\\r\\n         ELSE 0 END +\\r\\n    CASE WHEN ib.margem_liquida_perc < 0 THEN 2\\r\\n         ELSE 0 END AS score_risco_financeiro,\\r\\n    \\r\\n    -- Score total:\\r\\n    ROUND(\\r\\n        (COALESCE(se.score_equacao, 0) * 0.30) +\\r\\n        (COALESCE(sn.score_risco_neaf, 0) * 0.30) +\\r\\n        ((CASE WHEN ib.liquidez_corrente < 1 THEN 3 WHEN ib.liquidez_corrente < 1.5 THEN 1 ELSE 0 END +\\r\\n          CASE WHEN ib.endividamento_geral > 0.8 THEN 3 WHEN ib.endividamento_geral > 0.6 THEN 1 ELSE 0 END +\\r\\n          CASE WHEN ib.margem_liquida_perc < 0 THEN 2 ELSE 0 END) * 0.40)\\r\\n    , 2) AS score_risco_total,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o de risco:\\r\\n    CASE \\r\\n        WHEN ROUND((COALESCE(se.score_equacao, 0) * 0.30) + (COALESCE(sn.score_risco_neaf, 0) * 0.30) +\\r\\n             ((CASE WHEN ib.liquidez_corrente < 1 THEN 3 WHEN ib.liquidez_corrente < 1.5 THEN 1 ELSE 0 END +\\r\\n               CASE WHEN ib.endividamento_geral > 0.8 THEN 3 WHEN ib.endividamento_geral > 0.6 THEN 1 ELSE 0 END +\\r\\n               CASE WHEN ib.margem_liquida_perc < 0 THEN 2 ELSE 0 END) * 0.40), 2) >= 7 THEN 'RISCO CR\\u00cdTICO'\\r\\n        WHEN ROUND((COALESCE(se.score_equacao, 0) * 0.30) + (COALESCE(sn.score_risco_neaf, 0) * 0.30) +\\r\\n             ((CASE WHEN ib.liquidez_corrente < 1 THEN 3 WHEN ib.liquidez_corrente < 1.5 THEN 1 ELSE 0 END +\\r\\n               CASE WHEN ib.endividamento_geral > 0.8 THEN 3 WHEN ib.endividamento_geral > 0.6 THEN 1 ELSE 0 END +\\r\\n               CASE WHEN ib.margem_liquida_perc < 0 THEN 2 ELSE 0 END) * 0.40), 2) >= 5 THEN 'RISCO ALTO'\\r\\n        WHEN ROUND((COALESCE(se.score_equacao, 0) * 0.30) + (COALESCE(sn.score_risco_neaf, 0) * 0.30) +\\r\\n             ((CASE WHEN ib.liquidez_corrente < 1 THEN 3 WHEN ib.liquidez_corrente < 1.5 THEN 1 ELSE 0 END +\\r\\n               CASE WHEN ib.endividamento_geral > 0.8 THEN 3 WHEN ib.endividamento_geral > 0.6 THEN 1 ELSE 0 END +\\r\\n               CASE WHEN ib.margem_liquida_perc < 0 THEN 2 ELSE 0 END) * 0.40), 2) >= 3 THEN 'RISCO MODERADO'\\r\\n        ELSE 'RISCO BAIXO'\\r\\n    END AS classificacao_risco,\\r\\n    \\r\\n    -- Compara\\u00e7\\u00e3o com setor (se empresa est\\u00e1 acima/abaixo da m\\u00e9dia):\\r\\n    CASE \\r\\n        WHEN ib.liquidez_corrente IS NULL OR bench.media_liquidez_corrente_setor IS NULL THEN NULL\\r\\n        WHEN ib.liquidez_corrente > bench.media_liquidez_corrente_setor THEN 'Acima da M\\u00e9dia'\\r\\n        WHEN ib.liquidez_corrente < bench.media_liquidez_corrente_setor THEN 'Abaixo da M\\u00e9dia'\\r\\n        ELSE 'Na M\\u00e9dia'\\r\\n    END AS posicao_liquidez_setor,\\r\\n    \\r\\n    CASE \\r\\n        WHEN ib.margem_liquida_perc IS NULL OR bench.media_margem_liquida_setor IS NULL THEN NULL\\r\\n        WHEN ib.margem_liquida_perc > bench.media_margem_liquida_setor THEN 'Acima da M\\u00e9dia'\\r\\n        WHEN ib.margem_liquida_perc < bench.media_margem_liquida_setor THEN 'Abaixo da M\\u00e9dia'\\r\\n        ELSE 'Na M\\u00e9dia'\\r\\n    END AS posicao_margem_setor\\r\\n\\r\\nFROM teste.ecd_empresas_cadastro ec\\r\\nLEFT JOIN scores_equacao se ON ec.cnpj = se.cnpj AND ec.ano_referencia = se.ano_referencia\\r\\nLEFT JOIN teste.ecd_neaf_score_risco sn ON ec.cnpj = sn.cnpj\\r\\nLEFT JOIN indicadores_base ib ON ec.cnpj = ib.cnpj AND ec.ano_referencia = ib.ano_referencia\\r\\nLEFT JOIN teste.ecd_benchmark_setorial bench \\r\\n    ON ec.cd_cnae = bench.cd_cnae \\r\\n    AND ec.ano_referencia = bench.ano_referencia\\r\\n\\r\\nORDER BY ec.cnpj, ec.ano_referencia;\", \"result\": {\"id\": \"05eaecc0-116e-3e60-fdfc-a3351bb8919a\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"has_more_statements\": true, \"statement_id\": 15, \"statements_count\": 17, \"previous_statement_hash\": \"36117a5db8cd0324206424f644390c0b9da2b2f7a6e9bd5e4b8dcdf6\"}, \"meta\": [], \"rows\": null, \"hasMore\": false, \"statement_id\": 15, \"statement_range\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 0, \"column\": 0}}, \"statements_count\": 17, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": -1, \"filteredMeta\": [], \"fetchedOnce\": false, \"startTime\": \"2025-11-11T21:36:18.087Z\", \"endTime\": \"2025-11-11T21:36:18.087Z\", \"executionTime\": 0, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 0, \"hasSomeResults\": false}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": 3984, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": null, \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"tabela\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [\"empresas\"], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": null, \"getLogsTimeout\": null, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1762896978073, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"lastExecutedStatements\": \"-- ================================================================================\\r\\n-- ECD ONLINE - PARTE 2 [VERS\\u00c3O DEFINITIVA]\\r\\n-- ================================================================================\\r\\n-- Indicadores, Scores, NEAF e An\\u00e1lises\\r\\n-- Compat\\u00edvel com PARTE 1 Definitiva\\r\\n-- ================================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 6: INDICADORES FINANCEIROS E ECON\\u00d4MICOS\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_indicadores_financeiros;\\r\\nCREATE TABLE teste.ecd_indicadores_financeiros AS\\r\\n\\r\\nSELECT\\r\\n    bp.id_ecd,\\r\\n    bp.cnpj,\\r\\n    bp.ano_referencia,\\r\\n    bp.data_fim_periodo,\\r\\n    \\r\\n    -- Valores base\\r\\n    bp.ativo_total,\\r\\n    bp.ativo_circulante,\\r\\n    bp.ativo_nao_circulante,\\r\\n    bp.passivo_total,\\r\\n    bp.passivo_circulante,\\r\\n    bp.passivo_nao_circulante,\\r\\n    bp.patrimonio_liquido,\\r\\n    dre.receita_liquida,\\r\\n    dre.lucro_bruto,\\r\\n    dre.resultado_liquido,\\r\\n    dre.custos_totais,\\r\\n    dre.despesas_totais,\\r\\n    \\r\\n    -- LIQUIDEZ\\r\\n    CASE \\r\\n        WHEN bp.passivo_circulante > 0 \\r\\n        THEN ROUND(bp.ativo_circulante / bp.passivo_circulante, 4)\\r\\n        ELSE NULL\\r\\n    END AS liquidez_corrente,\\r\\n    \\r\\n    CASE \\r\\n        WHEN (bp.passivo_circulante + bp.passivo_nao_circulante) > 0 \\r\\n        THEN ROUND(bp.ativo_total / (bp.passivo_circulante + bp.passivo_nao_circulante), 4)\\r\\n        ELSE NULL\\r\\n    END AS liquidez_geral,\\r\\n    \\r\\n    -- ENDIVIDAMENTO\\r\\n    CASE \\r\\n        WHEN bp.ativo_total > 0 \\r\\n        THEN ROUND((bp.passivo_circulante + bp.passivo_nao_circulante) / bp.ativo_total, 4)\\r\\n        ELSE NULL\\r\\n    END AS endividamento_geral,\\r\\n    \\r\\n    CASE \\r\\n        WHEN bp.patrimonio_liquido > 0 \\r\\n        THEN ROUND((bp.passivo_circulante + bp.passivo_nao_circulante) / bp.patrimonio_liquido, 4)\\r\\n        ELSE NULL\\r\\n    END AS composicao_endividamento,\\r\\n    \\r\\n    -- RENTABILIDADE\\r\\n    CASE \\r\\n        WHEN dre.receita_liquida > 0 \\r\\n        THEN ROUND(dre.resultado_liquido / dre.receita_liquida * 100, 4)\\r\\n        ELSE NULL\\r\\n    END AS margem_liquida_perc,\\r\\n    \\r\\n    CASE \\r\\n        WHEN dre.receita_liquida > 0 \\r\\n        THEN ROUND(dre.lucro_bruto / dre.receita_liquida * 100, 4)\\r\\n        ELSE NULL\\r\\n    END AS margem_bruta_perc,\\r\\n    \\r\\n    CASE \\r\\n        WHEN bp.ativo_total > 0 \\r\\n        THEN ROUND(dre.resultado_liquido / bp.ativo_total * 100, 4)\\r\\n        ELSE NULL\\r\\n    END AS roa_retorno_ativo_perc,\\r\\n    \\r\\n    CASE \\r\\n        WHEN bp.patrimonio_liquido > 0 \\r\\n        THEN ROUND(dre.resultado_liquido / bp.patrimonio_liquido * 100, 4)\\r\\n        ELSE NULL\\r\\n    END AS roe_retorno_patrimonio_perc\\r\\n\\r\\nFROM teste.ecd_balanco_patrimonial bp\\r\\nINNER JOIN teste.ecd_dre dre\\r\\n    ON bp.id_ecd = dre.id_ecd\\r\\n    AND bp.ano_referencia = dre.ano_referencia\\r\\n    AND bp.data_fim_periodo = dre.data_fim_periodo\\r\\n\\r\\nORDER BY bp.cnpj, bp.ano_referencia, bp.data_fim_periodo;\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 7: INTEGRA\\u00c7\\u00c3O COM NEAF - IND\\u00cdCIOS\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_neaf_indicios;\\r\\nCREATE TABLE teste.ecd_neaf_indicios AS\\r\\n\\r\\nWITH indicios_base AS (\\r\\n    SELECT\\r\\n        REGEXP_REPLACE(TRIM(ei.nu_cpf_cnpj), '[^0-9]', '') AS cnpj,\\r\\n        ei.tx_descricao_indicio AS descricao_indicio,\\r\\n        ic.tx_descricao_complemento AS complemento_indicio\\r\\n    FROM neaf.empresa_indicio ei\\r\\n    JOIN ei.indicio_complemento ic\\r\\n    WHERE ei.cd_atual = 1\\r\\n        AND LENGTH(REGEXP_REPLACE(TRIM(ei.nu_cpf_cnpj), '[^0-9]', '')) = 14\\r\\n        AND REGEXP_REPLACE(TRIM(ei.nu_cpf_cnpj), '[^0-9]', '') IN (\\r\\n            SELECT DISTINCT cnpj FROM teste.ecd_empresas_cadastro\\r\\n        )\\r\\n),\\r\\n\\r\\ncontadores AS (\\r\\n    SELECT\\r\\n        cnpj,\\r\\n        COUNT(*) AS qtd_total_indicios,\\r\\n        COUNT(DISTINCT descricao_indicio) AS qtd_tipos_indicios\\r\\n    FROM indicios_base\\r\\n    GROUP BY cnpj\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    ib.cnpj,\\r\\n    ib.descricao_indicio,\\r\\n    ib.complemento_indicio,\\r\\n    c.qtd_total_indicios,\\r\\n    c.qtd_tipos_indicios\\r\\nFROM indicios_base ib\\r\\nINNER JOIN contadores c ON ib.cnpj = c.cnpj\\r\\n\\r\\nORDER BY ib.cnpj, ib.descricao_indicio;\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 8: SCORE DE RISCO NEAF\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_neaf_score_risco;\\r\\nCREATE TABLE teste.ecd_neaf_score_risco AS\\r\\n\\r\\nWITH metricas_indicios AS (\\r\\n    SELECT\\r\\n        cnpj,\\r\\n        COUNT(*) AS qtd_total_indicios,\\r\\n        COUNT(DISTINCT descricao_indicio) AS qtd_tipos_indicios_distintos\\r\\n    FROM teste.ecd_neaf_indicios\\r\\n    GROUP BY cnpj\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    mi.cnpj,\\r\\n    mi.qtd_total_indicios,\\r\\n    mi.qtd_tipos_indicios_distintos,\\r\\n    \\r\\n    LEAST(\\r\\n        ROUND(\\r\\n            (mi.qtd_tipos_indicios_distintos * 2.0) +\\r\\n            (mi.qtd_total_indicios * 0.5), 2)\\r\\n    , 10) AS score_risco_neaf,\\r\\n    \\r\\n    CASE \\r\\n        WHEN LEAST(ROUND((mi.qtd_tipos_indicios_distintos * 2.0) + (mi.qtd_total_indicios * 0.5), 2), 10) >= 8 \\r\\n            THEN 'RISCO CR\\u00cdTICO'\\r\\n        WHEN LEAST(ROUND((mi.qtd_tipos_indicios_distintos * 2.0) + (mi.qtd_total_indicios * 0.5), 2), 10) >= 5 \\r\\n            THEN 'RISCO ALTO'\\r\\n        WHEN LEAST(ROUND((mi.qtd_tipos_indicios_distintos * 2.0) + (mi.qtd_total_indicios * 0.5), 2), 10) >= 3 \\r\\n            THEN 'RISCO MODERADO'\\r\\n        ELSE 'RISCO BAIXO'\\r\\n    END AS classificacao_risco_neaf\\r\\n\\r\\nFROM metricas_indicios mi\\r\\n\\r\\nORDER BY score_risco_neaf DESC, cnpj;\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 9: INCONSIST\\u00caNCIAS - EQUA\\u00c7\\u00c3O CONT\\u00c1BIL\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_inconsistencias_equacao;\\r\\nCREATE TABLE teste.ecd_inconsistencias_equacao AS\\r\\n\\r\\nSELECT\\r\\n    id_ecd,\\r\\n    cnpj,\\r\\n    ano_referencia,\\r\\n    data_fim_periodo,\\r\\n    ativo_total,\\r\\n    passivo_pl_total,\\r\\n    diferenca_bp AS diferenca_absoluta,\\r\\n    \\r\\n    CASE \\r\\n        WHEN ativo_total > 0 \\r\\n        THEN ROUND(ABS(diferenca_bp) / ativo_total * 100, 4)\\r\\n        ELSE NULL\\r\\n    END AS percentual_diferenca,\\r\\n    \\r\\n    CASE \\r\\n        WHEN ABS(diferenca_bp) < 0.01 THEN 'OK'\\r\\n        WHEN ABS(diferenca_bp) < 1 THEN 'Diferen\\u00e7a M\\u00ednima'\\r\\n        WHEN ABS(diferenca_bp) < 1000 THEN 'Diferen\\u00e7a Pequena'\\r\\n        WHEN ABS(diferenca_bp) < 10000 THEN 'Diferen\\u00e7a Moderada'\\r\\n        WHEN ABS(diferenca_bp) < 100000 THEN 'Diferen\\u00e7a Significativa'\\r\\n        ELSE 'Diferen\\u00e7a Cr\\u00edtica'\\r\\n    END AS classificacao_inconsistencia,\\r\\n    \\r\\n    CASE \\r\\n        WHEN ABS(diferenca_bp) < 0.01 THEN 0\\r\\n        WHEN ABS(diferenca_bp) < 1 THEN 1\\r\\n        WHEN ABS(diferenca_bp) < 1000 THEN 3\\r\\n        WHEN ABS(diferenca_bp) < 10000 THEN 5\\r\\n        WHEN ABS(diferenca_bp) < 100000 THEN 7\\r\\n        ELSE 10\\r\\n    END AS score_risco_equacao\\r\\n\\r\\nFROM teste.ecd_balanco_patrimonial\\r\\n\\r\\nWHERE ABS(diferenca_bp) >= 0.01\\r\\n\\r\\nORDER BY ABS(diferenca_bp) DESC, cnpj, ano_referencia;\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 10: INCONSIST\\u00caNCIAS - VARIA\\u00c7\\u00d5ES ANORMAIS (OTIMIZADA)\\r\\n-- ================================================================================\\r\\n-- ESTRAT\\u00c9GIA: Agregar primeiro, depois calcular varia\\u00e7\\u00f5es\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_inconsistencias_variacoes;\\r\\nCREATE TABLE teste.ecd_inconsistencias_variacoes AS\\r\\n\\r\\nWITH saldos_agregados_ano AS (\\r\\n    -- \\u2705 CORRE\\u00c7\\u00c3O: Agregar por ANO COMPLETO (soma de todos os meses)\\r\\n    SELECT\\r\\n        cnpj,\\r\\n        ano_referencia,  -- J\\u00e1 est\\u00e1 em formato YYYY (2024)\\r\\n        cd_conta_referencial,\\r\\n        SUM(saldo_final_contabil) AS saldo_total_ano  -- Soma de todos os meses do ano\\r\\n    FROM teste.ecd_saldos_contas_v2\\r\\n    WHERE cd_conta_referencial IS NOT NULL\\r\\n        AND cd_conta_referencial LIKE '1.%'  -- Apenas ATIVO\\r\\n    GROUP BY cnpj, ano_referencia, cd_conta_referencial\\r\\n),\\r\\n\\r\\nsaldos_comparacao AS (\\r\\n    SELECT\\r\\n        cnpj,\\r\\n        ano_referencia,\\r\\n        cd_conta_referencial,\\r\\n        saldo_total_ano AS saldo_atual,\\r\\n        LAG(saldo_total_ano) OVER (\\r\\n            PARTITION BY cnpj, cd_conta_referencial \\r\\n            ORDER BY ano_referencia  -- Agora vai comparar 2024 com 2023 corretamente\\r\\n        ) AS saldo_anterior\\r\\n    FROM saldos_agregados_ano\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    sc.cnpj,\\r\\n    sc.ano_referencia,\\r\\n    sc.cd_conta_referencial AS cd_conta,\\r\\n    sc.saldo_anterior,\\r\\n    sc.saldo_atual,\\r\\n    sc.saldo_atual - sc.saldo_anterior AS variacao_absoluta,\\r\\n    \\r\\n    CASE \\r\\n        WHEN sc.saldo_anterior != 0 AND ABS(sc.saldo_anterior) >= 100\\r\\n        THEN ROUND(((sc.saldo_atual - sc.saldo_anterior) / ABS(sc.saldo_anterior)) * 100, 2)\\r\\n        ELSE NULL\\r\\n    END AS variacao_percentual,\\r\\n    \\r\\n    CASE \\r\\n        WHEN sc.saldo_anterior = 0 OR ABS(sc.saldo_anterior) < 100 THEN 'Varia\\u00e7\\u00e3o de Saldo Pequeno'\\r\\n        WHEN ABS(ROUND(((sc.saldo_atual - sc.saldo_anterior) / ABS(sc.saldo_anterior)) * 100, 2)) >= 1000 \\r\\n            THEN 'Varia\\u00e7\\u00e3o Extrema'\\r\\n        WHEN ABS(ROUND(((sc.saldo_atual - sc.saldo_anterior) / ABS(sc.saldo_anterior)) * 100, 2)) >= 500 \\r\\n            THEN 'Varia\\u00e7\\u00e3o Muito Alta'\\r\\n        WHEN ABS(ROUND(((sc.saldo_atual - sc.saldo_anterior) / ABS(sc.saldo_anterior)) * 100, 2)) >= 200 \\r\\n            THEN 'Varia\\u00e7\\u00e3o Alta'\\r\\n        WHEN ABS(ROUND(((sc.saldo_atual - sc.saldo_anterior) / ABS(sc.saldo_anterior)) * 100, 2)) >= 100 \\r\\n            THEN 'Varia\\u00e7\\u00e3o Significativa'\\r\\n        ELSE 'Varia\\u00e7\\u00e3o Moderada'\\r\\n    END AS classificacao_variacao,\\r\\n    \\r\\n    CASE \\r\\n        WHEN sc.saldo_anterior = 0 OR ABS(sc.saldo_anterior) < 100 THEN 0\\r\\n        WHEN ABS(ROUND(((sc.saldo_atual - sc.saldo_anterior) / ABS(sc.saldo_anterior)) * 100, 2)) >= 1000 THEN 10\\r\\n        WHEN ABS(ROUND(((sc.saldo_atual - sc.saldo_anterior) / ABS(sc.saldo_anterior)) * 100, 2)) >= 500 THEN 8\\r\\n        WHEN ABS(ROUND(((sc.saldo_atual - sc.saldo_anterior) / ABS(sc.saldo_anterior)) * 100, 2)) >= 200 THEN 6\\r\\n        WHEN ABS(ROUND(((sc.saldo_atual - sc.saldo_anterior) / ABS(sc.saldo_anterior)) * 100, 2)) >= 100 THEN 4\\r\\n        ELSE 2\\r\\n    END AS score_risco_variacao\\r\\n\\r\\nFROM saldos_comparacao sc\\r\\n\\r\\nWHERE sc.saldo_anterior IS NOT NULL\\r\\n    AND ABS(sc.saldo_anterior) >= 100\\r\\n    AND ABS(ROUND(((sc.saldo_atual - sc.saldo_anterior) / ABS(sc.saldo_anterior)) * 100, 2)) >= 100\\r\\n\\r\\nORDER BY score_risco_variacao DESC, ABS(sc.saldo_atual - sc.saldo_anterior) DESC\\r\\nLIMIT 50000;\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 11: BENCHMARK SETORIAL (COM CNAE)\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_benchmark_setorial;\\r\\nCREATE TABLE teste.ecd_benchmark_setorial AS\\r\\n\\r\\nWITH metricas_empresa AS (\\r\\n    SELECT\\r\\n        ec.cnpj,\\r\\n        ec.cd_cnae,\\r\\n        ec.de_cnae,\\r\\n        ec.cnae_secao,\\r\\n        ec.cnae_secao_descricao,\\r\\n        ec.cnae_divisao,\\r\\n        ec.cnae_divisao_descricao,\\r\\n        ec.ano_referencia,\\r\\n        ind.ativo_total,\\r\\n        ind.receita_liquida,\\r\\n        ind.resultado_liquido,\\r\\n        ind.liquidez_corrente,\\r\\n        ind.endividamento_geral,\\r\\n        ind.margem_liquida_perc,\\r\\n        ind.roe_retorno_patrimonio_perc\\r\\n    FROM teste.ecd_empresas_cadastro ec\\r\\n    INNER JOIN teste.ecd_indicadores_financeiros ind\\r\\n        ON ec.cnpj = ind.cnpj\\r\\n        AND ec.ano_referencia = ind.ano_referencia\\r\\n    WHERE ec.cd_cnae IS NOT NULL\\r\\n        AND ind.ativo_total IS NOT NULL\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    me.cd_cnae,\\r\\n    me.de_cnae,\\r\\n    me.cnae_secao,\\r\\n    me.cnae_secao_descricao,\\r\\n    me.cnae_divisao,\\r\\n    me.cnae_divisao_descricao,\\r\\n    me.ano_referencia,\\r\\n    \\r\\n    COUNT(DISTINCT me.cnpj) AS qtd_empresas_setor,\\r\\n    \\r\\n    -- Valores m\\u00e9dios do setor:\\r\\n    ROUND(AVG(me.ativo_total), 2) AS media_ativo_total_setor,\\r\\n    ROUND(AVG(me.receita_liquida), 2) AS media_receita_liquida_setor,\\r\\n    ROUND(AVG(me.resultado_liquido), 2) AS media_resultado_liquido_setor,\\r\\n    \\r\\n    -- Indicadores m\\u00e9dios do setor:\\r\\n    ROUND(AVG(me.liquidez_corrente), 4) AS media_liquidez_corrente_setor,\\r\\n    ROUND(AVG(me.endividamento_geral), 4) AS media_endividamento_setor,\\r\\n    ROUND(AVG(me.margem_liquida_perc), 2) AS media_margem_liquida_setor,\\r\\n    ROUND(AVG(me.roe_retorno_patrimonio_perc), 2) AS media_roe_setor,\\r\\n    \\r\\n    -- Min/Max para compara\\u00e7\\u00e3o:\\r\\n    ROUND(MIN(me.liquidez_corrente), 4) AS min_liquidez_setor,\\r\\n    ROUND(MAX(me.liquidez_corrente), 4) AS max_liquidez_setor,\\r\\n    ROUND(MIN(me.margem_liquida_perc), 2) AS min_margem_liquida_setor,\\r\\n    ROUND(MAX(me.margem_liquida_perc), 2) AS max_margem_liquida_setor\\r\\n\\r\\nFROM metricas_empresa me\\r\\n\\r\\nGROUP BY \\r\\n    me.cd_cnae,\\r\\n    me.de_cnae,\\r\\n    me.cnae_secao,\\r\\n    me.cnae_secao_descricao,\\r\\n    me.cnae_divisao,\\r\\n    me.cnae_divisao_descricao,\\r\\n    me.ano_referencia\\r\\n\\r\\nHAVING COUNT(DISTINCT me.cnpj) >= 3\\r\\n\\r\\nORDER BY me.cnae_secao, me.cd_cnae, me.ano_referencia;\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- TABELA 12: SCORE CONSOLIDADO DE RISCO (COM CNAE E BENCHMARK)\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.ecd_score_risco_consolidado;\\r\\nCREATE TABLE teste.ecd_score_risco_consolidado AS\\r\\n\\r\\nWITH scores_equacao AS (\\r\\n    SELECT cnpj, ano_referencia, AVG(score_risco_equacao) AS score_equacao\\r\\n    FROM teste.ecd_inconsistencias_equacao\\r\\n    GROUP BY cnpj, ano_referencia\\r\\n),\\r\\n\\r\\nindicadores_base AS (\\r\\n    SELECT cnpj, ano_referencia, liquidez_corrente, endividamento_geral, \\r\\n           margem_liquida_perc, roe_retorno_patrimonio_perc\\r\\n    FROM teste.ecd_indicadores_financeiros\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    ec.cnpj,\\r\\n    ec.nm_razao_social AS razao_social,\\r\\n    ec.nm_fantasia,\\r\\n    ec.cd_uf AS uf,\\r\\n    ec.ano_referencia,\\r\\n    ec.empresa_grande_porte,\\r\\n    ec.tipo_ecd,\\r\\n    \\r\\n    -- CNAE:\\r\\n    ec.cd_cnae,\\r\\n    ec.de_cnae,\\r\\n    ec.cnae_secao,\\r\\n    ec.cnae_secao_descricao,\\r\\n    ec.cnae_divisao,\\r\\n    ec.cnae_divisao_descricao,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o fiscal:\\r\\n    ec.nm_tipo_contribuinte,\\r\\n    ec.nm_reg_apuracao,\\r\\n    ec.sn_simples_nacional_rfb,\\r\\n    ec.sit_cadastral_sefaz,\\r\\n    ec.nm_sit_cadastral_sefaz,\\r\\n    \\r\\n    -- Scores:\\r\\n    COALESCE(se.score_equacao, 0) AS score_equacao_contabil,\\r\\n    COALESCE(sn.score_risco_neaf, 0) AS score_neaf,\\r\\n    COALESCE(sn.qtd_total_indicios, 0) AS qtd_indicios_neaf,\\r\\n    \\r\\n    -- Indicadores da empresa:\\r\\n    ib.liquidez_corrente,\\r\\n    ib.endividamento_geral,\\r\\n    ib.margem_liquida_perc,\\r\\n    ib.roe_retorno_patrimonio_perc,\\r\\n    \\r\\n    -- Benchmark do setor (para compara\\u00e7\\u00e3o):\\r\\n    bench.media_liquidez_corrente_setor,\\r\\n    bench.media_margem_liquida_setor,\\r\\n    bench.media_roe_setor,\\r\\n    bench.qtd_empresas_setor,\\r\\n    \\r\\n    -- Score de risco financeiro:\\r\\n    CASE WHEN ib.liquidez_corrente < 1 THEN 3\\r\\n         WHEN ib.liquidez_corrente < 1.5 THEN 1\\r\\n         ELSE 0 END +\\r\\n    CASE WHEN ib.endividamento_geral > 0.8 THEN 3\\r\\n         WHEN ib.endividamento_geral > 0.6 THEN 1\\r\\n         ELSE 0 END +\\r\\n    CASE WHEN ib.margem_liquida_perc < 0 THEN 2\\r\\n         ELSE 0 END AS score_risco_financeiro,\\r\\n    \\r\\n    -- Score total:\\r\\n    ROUND(\\r\\n        (COALESCE(se.score_equacao, 0) * 0.30) +\\r\\n        (COALESCE(sn.score_risco_neaf, 0) * 0.30) +\\r\\n        ((CASE WHEN ib.liquidez_corrente < 1 THEN 3 WHEN ib.liquidez_corrente < 1.5 THEN 1 ELSE 0 END +\\r\\n          CASE WHEN ib.endividamento_geral > 0.8 THEN 3 WHEN ib.endividamento_geral > 0.6 THEN 1 ELSE 0 END +\\r\\n          CASE WHEN ib.margem_liquida_perc < 0 THEN 2 ELSE 0 END) * 0.40)\\r\\n    , 2) AS score_risco_total,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o de risco:\\r\\n    CASE \\r\\n        WHEN ROUND((COALESCE(se.score_equacao, 0) * 0.30) + (COALESCE(sn.score_risco_neaf, 0) * 0.30) +\\r\\n             ((CASE WHEN ib.liquidez_corrente < 1 THEN 3 WHEN ib.liquidez_corrente < 1.5 THEN 1 ELSE 0 END +\\r\\n               CASE WHEN ib.endividamento_geral > 0.8 THEN 3 WHEN ib.endividamento_geral > 0.6 THEN 1 ELSE 0 END +\\r\\n               CASE WHEN ib.margem_liquida_perc < 0 THEN 2 ELSE 0 END) * 0.40), 2) >= 7 THEN 'RISCO CR\\u00cdTICO'\\r\\n        WHEN ROUND((COALESCE(se.score_equacao, 0) * 0.30) + (COALESCE(sn.score_risco_neaf, 0) * 0.30) +\\r\\n             ((CASE WHEN ib.liquidez_corrente < 1 THEN 3 WHEN ib.liquidez_corrente < 1.5 THEN 1 ELSE 0 END +\\r\\n               CASE WHEN ib.endividamento_geral > 0.8 THEN 3 WHEN ib.endividamento_geral > 0.6 THEN 1 ELSE 0 END +\\r\\n               CASE WHEN ib.margem_liquida_perc < 0 THEN 2 ELSE 0 END) * 0.40), 2) >= 5 THEN 'RISCO ALTO'\\r\\n        WHEN ROUND((COALESCE(se.score_equacao, 0) * 0.30) + (COALESCE(sn.score_risco_neaf, 0) * 0.30) +\\r\\n             ((CASE WHEN ib.liquidez_corrente < 1 THEN 3 WHEN ib.liquidez_corrente < 1.5 THEN 1 ELSE 0 END +\\r\\n               CASE WHEN ib.endividamento_geral > 0.8 THEN 3 WHEN ib.endividamento_geral > 0.6 THEN 1 ELSE 0 END +\\r\\n               CASE WHEN ib.margem_liquida_perc < 0 THEN 2 ELSE 0 END) * 0.40), 2) >= 3 THEN 'RISCO MODERADO'\\r\\n        ELSE 'RISCO BAIXO'\\r\\n    END AS classificacao_risco,\\r\\n    \\r\\n    -- Compara\\u00e7\\u00e3o com setor (se empresa est\\u00e1 acima/abaixo da m\\u00e9dia):\\r\\n    CASE \\r\\n        WHEN ib.liquidez_corrente IS NULL OR bench.media_liquidez_corrente_setor IS NULL THEN NULL\\r\\n        WHEN ib.liquidez_corrente > bench.media_liquidez_corrente_setor THEN 'Acima da M\\u00e9dia'\\r\\n        WHEN ib.liquidez_corrente < bench.media_liquidez_corrente_setor THEN 'Abaixo da M\\u00e9dia'\\r\\n        ELSE 'Na M\\u00e9dia'\\r\\n    END AS posicao_liquidez_setor,\\r\\n    \\r\\n    CASE \\r\\n        WHEN ib.margem_liquida_perc IS NULL OR bench.media_margem_liquida_setor IS NULL THEN NULL\\r\\n        WHEN ib.margem_liquida_perc > bench.media_margem_liquida_setor THEN 'Acima da M\\u00e9dia'\\r\\n        WHEN ib.margem_liquida_perc < bench.media_margem_liquida_setor THEN 'Abaixo da M\\u00e9dia'\\r\\n        ELSE 'Na M\\u00e9dia'\\r\\n    END AS posicao_margem_setor\\r\\n\\r\\nFROM teste.ecd_empresas_cadastro ec\\r\\nLEFT JOIN scores_equacao se ON ec.cnpj = se.cnpj AND ec.ano_referencia = se.ano_referencia\\r\\nLEFT JOIN teste.ecd_neaf_score_risco sn ON ec.cnpj = sn.cnpj\\r\\nLEFT JOIN indicadores_base ib ON ec.cnpj = ib.cnpj AND ec.ano_referencia = ib.ano_referencia\\r\\nLEFT JOIN teste.ecd_benchmark_setorial bench \\r\\n    ON ec.cd_cnae = bench.cd_cnae \\r\\n    AND ec.ano_referencia = bench.ano_referencia\\r\\n\\r\\nORDER BY ec.cnpj, ec.ano_referencia;\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- VALIDA\\u00c7\\u00d5ES FINAIS\\r\\n-- ================================================================================\\r\\n\\r\\nSELECT 'ecd_indicadores_financeiros' AS tabela, COUNT(*) AS qtd, COUNT(DISTINCT cnpj) AS empresas FROM teste.ecd_indicadores_financeiros\\r\\nUNION ALL\\r\\nSELECT 'ecd_neaf_indicios', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_neaf_indicios\\r\\nUNION ALL\\r\\nSELECT 'ecd_neaf_score_risco', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_neaf_score_risco\\r\\nUNION ALL\\r\\nSELECT 'ecd_inconsistencias_equacao', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_inconsistencias_equacao\\r\\nUNION ALL\\r\\nSELECT 'ecd_inconsistencias_variacoes', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_inconsistencias_variacoes\\r\\nUNION ALL\\r\\nSELECT 'ecd_benchmark_setorial', COUNT(*), 0 FROM teste.ecd_benchmark_setorial\\r\\nUNION ALL\\r\\nSELECT 'ecd_score_risco_consolidado', COUNT(*), COUNT(DISTINCT cnpj) FROM teste.ecd_score_risco_consolidado;\\r\\n\\r\\n-- ================================================================================\\r\\n-- FIM DA PARTE 2 DEFINITIVA!\\r\\n-- ================================================================================\", \"lastExecutedSelectionRange\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 524, \"column\": 83}}, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false, \"lastCheckStatusRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"query_status\\\": {\\\"status\\\": \\\"available\\\"}}\", \"responseJSON\": {\"status\": 0, \"query_status\": {\"status\": \"available\"}}, \"status\": 200, \"statusText\": \"OK\"}, \"lastGetLogsRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"logs\\\": \\\"Query a84a9503750a7111:4451b67400000000 100% Complete (32 out of 32)\\\", \\\"progress\\\": 100, \\\"jobs\\\": [{\\\"name\\\": \\\"a84a9503750a7111:4451b67400000000\\\", \\\"url\\\": \\\"/hue/jobbrowser#!id=a84a9503750a7111:4451b67400000000\\\", \\\"started\\\": true, \\\"finished\\\": false, \\\"percentJob\\\": 100}], \\\"isFullLogs\\\": false}\", \"responseJSON\": {\"status\": 0, \"logs\": \"Query a84a9503750a7111:4451b67400000000 100% Complete (32 out of 32)\", \"progress\": 100, \"jobs\": [{\"name\": \"a84a9503750a7111:4451b67400000000\", \"url\": \"/hue/jobbrowser#!id=a84a9503750a7111:4451b67400000000\", \"started\": true, \"finished\": false, \"percentJob\": 100}], \"isFullLogs\": false}, \"status\": 200, \"statusText\": \"OK\"}}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 10437, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 179, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- ================================================================================\r\n-- ECD ONLINE - PARTE 2 [VERSÃO DEFINITIVA]\r\n-- ================================================================================\r\n-- Indicadores, Scores, NEAF e Análises\r\n-- Compatível com PARTE 1 Definitiva\r\n-- ================================================================================\r\n\r\nSET REQUEST_POOL = 'medium';\r\n\r\n-- ================================================================================\r\n-- TABELA 6: INDICADORES FINANCEIROS E ECONÔMICOS\r\n-- ================================================================================\r\n\r\nDROP TABLE IF EXISTS teste.ecd_indicadores_financeiros;\r\nCREATE TABLE teste.ecd_indicadores_financeiros AS\r\n\r\nSELECT\r\n    bp.id_ecd,\r\n    bp.cnpj,\r\n    bp.ano_referencia,\r\n    bp.data_fim_periodo,\r\n    \r\n    -- Valores base\r\n    bp.ativo_total,\r\n    bp.ativo_circulante,\r\n    bp.ativo_nao_circulante,\r\n    bp.passivo_total,\r\n    bp.passivo_circulante,\r\n    bp.passivo_nao_circulante,\r\n    bp.patrimonio_liquido,\r\n    dre.receita_liquida,\r\n    dre.lucro_bruto,\r\n    dre.resultado_liquido,\r\n    dre.custos_totais,\r\n    dre.despesas_totais,\r\n    \r\n    -- LIQUIDEZ\r\n    CASE \r\n        WHEN bp.passivo_circulante > 0 \r\n        THEN ROUND(bp.ativo_circulante / bp.passivo_circulante, 4)\r\n        ELSE NULL\r\n    END AS liquidez_corrente,\r\n    \r\n    CASE \r\n        WHEN (bp.passivo_circulante + bp.passivo_nao_circulante) > 0 \r\n        THEN ROUND(bp.ativo_total / (bp.passivo_circulante + bp.passivo_nao_circulante), 4)\r\n        ELSE NULL\r\n    END AS liquidez_geral,\r\n    \r\n    -- ENDIVIDAMENTO\r\n    CASE \r\n        WHEN bp.ativo_total > 0 \r\n        THEN ROUND((bp.passivo_circulante + bp.passivo_nao_circulante) / bp.ativo_total, 4)\r\n        ELSE NULL\r\n    END AS endividamento_geral,\r\n    \r\n    CASE \r\n        WHEN bp.patrimonio_liquido > 0 \r\n        THEN ROUND((bp.passivo_circulante + bp.passivo_nao_circulante) / bp.patrimonio_liquido, 4)\r\n        ELSE NULL\r\n    END A",
    "last_modified": "2025-11-11T18:36:26.473",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "bb81055a-5ce8-40f4-947b-e794da0b0493",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 167977,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "ECD",
    "description": "",
    "uuid": "bb81055a-5ce8-40f4-947b-e794da0b0493",
    "type": "directory",
    "connector": null,
    "data": "{}",
    "extra": "",
    "search": null,
    "last_modified": "2025-10-26T19:22:06.348",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "a8280168-7cf2-40b1-bc5d-733014ae6ba9",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 168050,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "ECD: 3 Analises",
    "description": "",
    "uuid": "b77e1879-8b0e-109c-0fa4-de36d9e3d96c",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 168050, \"uuid\": \"b77e1879-8b0e-109c-0fa4-de36d9e3d96c\", \"name\": \"ECD: 3 Analises\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": null, \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"372beaa9-797a-61aa-b2c0-9aa2bfa08b20\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 255, \"column\": 0}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": false, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"savedQueries\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- ============================================================================\\r\\n-- CONSULTAS ANAL\\u00cdTICAS ECD ONLINE - VERS\\u00c3O 3.2 FINAL\\r\\n-- CORRIGIDO: Anos no formato AAAAMM (202401, 202301, etc.)\\r\\n-- ============================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\n-- ============================================================================\\r\\n-- 0. VALIDA\\u00c7\\u00c3O PR\\u00c9VIA - ENTENDA SEUS DADOS\\r\\n-- ============================================================================\\r\\n\\r\\n-- Ver distribui\\u00e7\\u00e3o de anos/meses\\r\\nSELECT \\r\\n    'Distribui\\u00e7\\u00e3o Ano/M\\u00eas' AS info,\\r\\n    CAST(ano_referencia / 100 AS INT) AS ano,\\r\\n    ano_referencia % 100 AS mes,\\r\\n    ano_referencia AS ano_mes_completo,\\r\\n    COUNT(DISTINCT cnpj) AS qtd_empresas,\\r\\n    COUNT(DISTINCT id_ecd) AS qtd_ecds\\r\\nFROM teste.ecd_empresas_cadastro\\r\\nWHERE ano_referencia > 0  -- Ignorar registros sem data\\r\\nGROUP BY ano_referencia\\r\\nORDER BY ano_referencia DESC\\r\\nLIMIT 20;\\r\\n\\r\\n-- Ver apenas anos (ignorando m\\u00eas)\\r\\nSELECT \\r\\n    'Por Ano Fiscal' AS info,\\r\\n    CAST(ano_referencia / 100 AS INT) AS ano_fiscal,\\r\\n    COUNT(DISTINCT cnpj) AS qtd_empresas_distintas,\\r\\n    COUNT(DISTINCT id_ecd) AS qtd_ecds_total\\r\\nFROM teste.ecd_empresas_cadastro\\r\\nWHERE ano_referencia > 0\\r\\nGROUP BY CAST(ano_referencia / 100 AS INT)\\r\\nORDER BY ano_fiscal DESC;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- 1.1. PANORAMA GERAL V3.2 (CORRIGIDO PARA AAAAMM)\\r\\n-- ============================================================================\\r\\n\\r\\nWITH periodos AS (\\r\\n    SELECT \\r\\n        MAX(ano_referencia) AS periodo_mais_recente,\\r\\n        CAST(MAX(ano_referencia) / 100 AS INT) AS ano_mais_recente\\r\\n    FROM teste.ecd_empresas_cadastro\\r\\n    WHERE ano_referencia > 0\\r\\n)\\r\\nSELECT\\r\\n    '1.1. PANORAMA GERAL ECD ONLINE V3.2' AS consulta,\\r\\n    \\r\\n    -- Anos detectados\\r\\n    p.periodo_mais_recente,\\r\\n    p.ano_mais_recente,\\r\\n    \\r\\n    -- M\\u00e9tricas de Volume\\r\\n    COUNT(DISTINCT ec.cnpj) AS total_empresas_base,\\r\\n    COUNT(DISTINCT ec.id_ecd) AS total_ecds_entregues,\\r\\n    \\r\\n    -- Por ano fiscal (\\u00faltimos 3 anos)\\r\\n    COUNT(DISTINCT CASE \\r\\n        WHEN CAST(ec.ano_referencia / 100 AS INT) = p.ano_mais_recente\\r\\n        THEN ec.id_ecd END) AS qtd_ecds_ano_atual,\\r\\n    COUNT(DISTINCT CASE \\r\\n        WHEN CAST(ec.ano_referencia / 100 AS INT) = p.ano_mais_recente - 1 \\r\\n        THEN ec.id_ecd END) AS qtd_ecds_ano_anterior,\\r\\n    COUNT(DISTINCT CASE \\r\\n        WHEN CAST(ec.ano_referencia / 100 AS INT) = p.ano_mais_recente - 2 \\r\\n        THEN ec.id_ecd END) AS qtd_ecds_ano_retrasado,\\r\\n        \\r\\n    COUNT(DISTINCT CASE \\r\\n        WHEN CAST(ec.ano_referencia / 100 AS INT) = p.ano_mais_recente\\r\\n        THEN ec.cnpj END) AS empresas_ano_atual,\\r\\n    COUNT(DISTINCT CASE \\r\\n        WHEN CAST(ec.ano_referencia / 100 AS INT) = p.ano_mais_recente - 1 \\r\\n        THEN ec.cnpj END) AS empresas_ano_anterior,\\r\\n    COUNT(DISTINCT CASE \\r\\n        WHEN CAST(ec.ano_referencia / 100 AS INT) = p.ano_mais_recente - 2 \\r\\n        THEN ec.cnpj END) AS empresas_ano_retrasado,\\r\\n    \\r\\n    -- Tipos de ECD\\r\\n    COUNT(DISTINCT CASE WHEN ec.tipo_ecd = 'Livro Di\\u00e1rio (Completo)' THEN ec.cnpj END) AS empresas_diario_completo,\\r\\n    COUNT(DISTINCT CASE WHEN ec.tipo_ecd = 'Livro Di\\u00e1rio com Redu\\u00e7\\u00e3o' THEN ec.cnpj END) AS empresas_diario_reducao,\\r\\n    COUNT(DISTINCT CASE WHEN ec.tipo_ecd = 'Livro Balancetes' THEN ec.cnpj END) AS empresas_balancetes,\\r\\n    \\r\\n    -- Grande Porte\\r\\n    COUNT(DISTINCT CASE WHEN ec.empresa_grande_porte = 'Sim' THEN ec.cnpj END) AS empresas_grande_porte,\\r\\n    ROUND(COUNT(DISTINCT CASE WHEN ec.empresa_grande_porte = 'Sim' THEN ec.cnpj END) * 100.0 / \\r\\n          NULLIF(COUNT(DISTINCT ec.cnpj), 0), 2) AS perc_grande_porte,\\r\\n    \\r\\n    -- Situa\\u00e7\\u00e3o Cadastral SEFAZ\\r\\n    COUNT(DISTINCT CASE WHEN ec.sit_cadastral_sefaz = 1 THEN ec.cnpj END) AS empresas_ativas_sefaz,\\r\\n    COUNT(DISTINCT CASE WHEN ec.sit_cadastral_sefaz != 1 OR ec.sit_cadastral_sefaz IS NULL THEN ec.cnpj END) AS empresas_inativas_sefaz,\\r\\n    \\r\\n    -- Simples Nacional\\r\\n    COUNT(DISTINCT CASE WHEN ec.sn_simples_nacional_rfb = 1 THEN ec.cnpj END) AS empresas_simples_nacional,\\r\\n    COUNT(DISTINCT CASE WHEN ec.sn_simples_nacional_rfb = 0 THEN ec.cnpj END) AS empresas_lucro_real_presumido,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS data_consulta\\r\\n    \\r\\nFROM teste.ecd_empresas_cadastro ec, periodos p\\r\\nWHERE ec.ano_referencia > 0\\r\\nGROUP BY p.periodo_mais_recente, p.ano_mais_recente;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- 1.2. ESTAT\\u00cdSTICAS POR ANO FISCAL\\r\\n-- ============================================================================\\r\\n\\r\\nSELECT\\r\\n    '1.2. ESTAT\\u00cdSTICAS POR ANO FISCAL' AS consulta,\\r\\n    \\r\\n    CAST(ano_referencia / 100 AS INT) AS ano_fiscal,\\r\\n    COUNT(DISTINCT cnpj) AS empresas,\\r\\n    COUNT(DISTINCT id_ecd) AS total_ecds,\\r\\n    \\r\\n    -- Tipos de ECD\\r\\n    COUNT(DISTINCT CASE WHEN tipo_ecd = 'Livro Di\\u00e1rio (Completo)' THEN cnpj END) AS diario_completo,\\r\\n    COUNT(DISTINCT CASE WHEN tipo_ecd = 'Livro Di\\u00e1rio com Redu\\u00e7\\u00e3o' THEN cnpj END) AS diario_reducao,\\r\\n    COUNT(DISTINCT CASE WHEN tipo_ecd = 'Livro Balancetes' THEN cnpj END) AS balancetes,\\r\\n    \\r\\n    -- Grande Porte\\r\\n    COUNT(DISTINCT CASE WHEN empresa_grande_porte = 'Sim' THEN cnpj END) AS grande_porte,\\r\\n    \\r\\n    -- Simples Nacional\\r\\n    COUNT(DISTINCT CASE WHEN sn_simples_nacional_rfb = 1 THEN cnpj END) AS simples_nacional,\\r\\n    COUNT(DISTINCT CASE WHEN sn_simples_nacional_rfb = 0 THEN cnpj END) AS lucro_real_presumido\\r\\n    \\r\\nFROM teste.ecd_empresas_cadastro\\r\\nWHERE ano_referencia > 0\\r\\nGROUP BY CAST(ano_referencia / 100 AS INT)\\r\\nORDER BY ano_fiscal DESC;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- 1.3. DISTRIBUI\\u00c7\\u00c3O POR UF (ANO MAIS RECENTE)\\r\\n-- ============================================================================\\r\\n\\r\\nWITH ano_atual AS (\\r\\n    SELECT CAST(MAX(ano_referencia) / 100 AS INT) AS ano \\r\\n    FROM teste.ecd_empresas_cadastro\\r\\n    WHERE ano_referencia > 0\\r\\n)\\r\\nSELECT\\r\\n    '1.3. DISTRIBUI\\u00c7\\u00c3O POR UF' AS consulta,\\r\\n    \\r\\n    ec.cd_uf AS uf,\\r\\n    COUNT(DISTINCT ec.cnpj) AS total_empresas,\\r\\n    COUNT(DISTINCT ec.id_ecd) AS total_ecds,\\r\\n    ROUND(COUNT(DISTINCT ec.cnpj) * 100.0 / SUM(COUNT(DISTINCT ec.cnpj)) OVER(), 2) AS percentual,\\r\\n    \\r\\n    -- Grande Porte\\r\\n    COUNT(DISTINCT CASE WHEN ec.empresa_grande_porte = 'Sim' THEN ec.cnpj END) AS grande_porte,\\r\\n    \\r\\n    -- Simples Nacional\\r\\n    COUNT(DISTINCT CASE WHEN ec.sn_simples_nacional_rfb = 1 THEN ec.cnpj END) AS simples_nacional\\r\\n    \\r\\nFROM teste.ecd_empresas_cadastro ec, ano_atual aa\\r\\nWHERE ec.cd_uf IS NOT NULL\\r\\n    AND CAST(ec.ano_referencia / 100 AS INT) = aa.ano\\r\\nGROUP BY ec.cd_uf\\r\\nORDER BY total_empresas DESC;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- 1.4. TOP 30 SETORES (ANO MAIS RECENTE)\\r\\n-- ============================================================================\\r\\n\\r\\nWITH ano_atual AS (\\r\\n    SELECT CAST(MAX(ano_referencia) / 100 AS INT) AS ano \\r\\n    FROM teste.ecd_empresas_cadastro\\r\\n    WHERE ano_referencia > 0\\r\\n)\\r\\nSELECT\\r\\n    '1.4. TOP 30 SETORES DETALHADO' AS consulta,\\r\\n    \\r\\n    ec.cnae_secao,\\r\\n    ec.cnae_secao_descricao,\\r\\n    ec.cnae_divisao,\\r\\n    ec.cnae_divisao_descricao,\\r\\n    COUNT(DISTINCT ec.cnpj) AS total_empresas,\\r\\n    COUNT(DISTINCT ec.id_ecd) AS total_ecds,\\r\\n    ROUND(COUNT(DISTINCT ec.cnpj) * 100.0 / SUM(COUNT(DISTINCT ec.cnpj)) OVER(), 2) AS percentual,\\r\\n    \\r\\n    -- Grande Porte\\r\\n    COUNT(DISTINCT CASE WHEN ec.empresa_grande_porte = 'Sim' THEN ec.cnpj END) AS grande_porte,\\r\\n    \\r\\n    -- M\\u00e9tricas Financeiras M\\u00e9dias\\r\\n    ROUND(AVG(ind.ativo_total) / 1000000, 2) AS media_ativo_milhoes,\\r\\n    ROUND(AVG(ind.receita_liquida) / 1000000, 2) AS media_receita_milhoes,\\r\\n    ROUND(AVG(ind.margem_liquida_perc), 2) AS media_margem_liquida,\\r\\n    ROUND(AVG(ind.roe_retorno_patrimonio_perc), 2) AS media_roe,\\r\\n    \\r\\n    -- Score de Risco M\\u00e9dio\\r\\n    ROUND(AVG(sr.score_risco_total), 2) AS score_risco_medio\\r\\n    \\r\\nFROM teste.ecd_empresas_cadastro ec, ano_atual aa\\r\\nLEFT JOIN teste.ecd_indicadores_financeiros ind \\r\\n    ON ec.cnpj = ind.cnpj \\r\\n    AND CAST(ec.ano_referencia / 100 AS INT) = CAST(ind.ano_referencia / 100 AS INT)\\r\\nLEFT JOIN teste.ecd_score_risco_consolidado sr \\r\\n    ON ec.cnpj = sr.cnpj \\r\\n    AND CAST(ec.ano_referencia / 100 AS INT) = CAST(sr.ano_referencia / 100 AS INT)\\r\\nWHERE ec.cnae_secao IS NOT NULL\\r\\n    AND CAST(ec.ano_referencia / 100 AS INT) = aa.ano\\r\\nGROUP BY ec.cnae_secao, ec.cnae_secao_descricao, ec.cnae_divisao, ec.cnae_divisao_descricao\\r\\nORDER BY total_empresas DESC\\r\\nLIMIT 30;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- 2.1. INDICADORES FINANCEIROS - RESUMO GERAL (ANO MAIS RECENTE)\\r\\n-- ============================================================================\\r\\n\\r\\nWITH ano_atual AS (\\r\\n    SELECT CAST(MAX(ano_referencia) / 100 AS INT) AS ano \\r\\n    FROM teste.ecd_indicadores_financeiros\\r\\n    WHERE ano_referencia > 0\\r\\n)\\r\\nSELECT\\r\\n    '2.1. RESUMO INDICADORES FINANCEIROS' AS consulta,\\r\\n    \\r\\n    aa.ano AS ano_fiscal,\\r\\n    COUNT(DISTINCT ind.cnpj) AS qtd_empresas,\\r\\n    \\r\\n    -- Valores totais\\r\\n    ROUND(SUM(ind.ativo_total) / 1000000000, 2) AS ativo_total_bilhoes,\\r\\n    ROUND(SUM(ind.receita_liquida) / 1000000000, 2) AS receita_total_bilhoes,\\r\\n    ROUND(SUM(ind.resultado_liquido) / 1000000000, 2) AS resultado_total_bilhoes,\\r\\n    \\r\\n    -- M\\u00e9dias\\r\\n    ROUND(AVG(ind.ativo_total) / 1000000, 2) AS media_ativo_milhoes,\\r\\n    ROUND(AVG(ind.receita_liquida) / 1000000, 2) AS media_receita_milhoes,\\r\\n    ROUND(AVG(ind.liquidez_corrente), 4) AS media_liquidez_corrente,\\r\\n    ROUND(AVG(ind.endividamento_geral), 4) AS media_endividamento,\\r\\n    ROUND(AVG(ind.margem_liquida_perc), 2) AS media_margem_liquida,\\r\\n    ROUND(AVG(ind.roe_retorno_patrimonio_perc), 2) AS media_roe,\\r\\n    \\r\\n    -- Contadores de situa\\u00e7\\u00e3o\\r\\n    COUNT(CASE WHEN ind.liquidez_corrente < 1 THEN 1 END) AS empresas_baixa_liquidez,\\r\\n    COUNT(CASE WHEN ind.endividamento_geral > 0.7 THEN 1 END) AS empresas_alto_endividamento,\\r\\n    COUNT(CASE WHEN ind.resultado_liquido < 0 THEN 1 END) AS empresas_prejuizo\\r\\n    \\r\\nFROM teste.ecd_indicadores_financeiros ind, ano_atual aa\\r\\nWHERE CAST(ind.ano_referencia / 100 AS INT) = aa.ano\\r\\nGROUP BY aa.ano;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- 3.1. PANORAMA DE INCONSIST\\u00caNCIAS\\r\\n-- ============================================================================\\r\\n\\r\\nWITH ano_atual AS (\\r\\n    SELECT CAST(MAX(ano_referencia) / 100 AS INT) AS ano \\r\\n    FROM teste.ecd_inconsistencias_equacao\\r\\n    WHERE ano_referencia > 0\\r\\n),\\r\\nscores_risco AS (\\r\\n    SELECT \\r\\n        CAST(ano_referencia / 100 AS INT) AS ano,\\r\\n        COUNT(DISTINCT CASE WHEN classificacao_risco = 'RISCO CR\\u00cdTICO' THEN cnpj END) AS cnt_critico,\\r\\n        COUNT(DISTINCT CASE WHEN classificacao_risco = 'RISCO ALTO' THEN cnpj END) AS cnt_alto,\\r\\n        ROUND(AVG(score_risco_total), 2) AS score_medio\\r\\n    FROM teste.ecd_score_risco_consolidado\\r\\n    WHERE ano_referencia > 0\\r\\n    GROUP BY CAST(ano_referencia / 100 AS INT)\\r\\n)\\r\\nSELECT\\r\\n    '3.1. PANORAMA INCONSIST\\u00caNCIAS' AS consulta,\\r\\n    \\r\\n    aa.ano AS ano_fiscal,\\r\\n    \\r\\n    -- Inconsist\\u00eancias de Equa\\u00e7\\u00e3o\\r\\n    COUNT(DISTINCT ie.cnpj) AS total_empresas_analisadas,\\r\\n    COUNT(DISTINCT CASE WHEN ie.classificacao_inconsistencia != 'OK' THEN ie.cnpj END) AS empresas_com_inconsistencia,\\r\\n    ROUND(COUNT(DISTINCT CASE WHEN ie.classificacao_inconsistencia != 'OK' THEN ie.cnpj END) * 100.0 / \\r\\n          NULLIF(COUNT(DISTINCT ie.cnpj), 0), 2) AS perc_com_inconsistencia,\\r\\n    \\r\\n    ROUND(AVG(CASE WHEN ie.classificacao_inconsistencia != 'OK' THEN ie.percentual_diferenca END), 4) AS media_perc_diferenca,\\r\\n    \\r\\n    -- Por Gravidade\\r\\n    COUNT(DISTINCT CASE WHEN ie.classificacao_inconsistencia = 'Diferen\\u00e7a Cr\\u00edtica' THEN ie.cnpj END) AS criticas,\\r\\n    COUNT(DISTINCT CASE WHEN ie.classificacao_inconsistencia = 'Diferen\\u00e7a Significativa' THEN ie.cnpj END) AS significativas,\\r\\n    COUNT(DISTINCT CASE WHEN ie.classificacao_inconsistencia = 'Diferen\\u00e7a Moderada' THEN ie.cnpj END) AS moderadas,\\r\\n    \\r\\n    -- Score de Risco (de CTE)\\r\\n    sr.cnt_critico AS empresas_risco_critico,\\r\\n    sr.cnt_alto AS empresas_risco_alto,\\r\\n    sr.score_medio AS score_risco_medio_geral\\r\\n     \\r\\nFROM teste.ecd_inconsistencias_equacao ie, ano_atual aa\\r\\nLEFT JOIN scores_risco sr ON sr.ano = aa.ano\\r\\nWHERE CAST(ie.ano_referencia / 100 AS INT) = aa.ano\\r\\nGROUP BY aa.ano, sr.cnt_critico, sr.cnt_alto, sr.score_medio;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- 3.2. DISTRIBUI\\u00c7\\u00c3O DE SCORES DE RISCO\\r\\n-- ============================================================================\\r\\n\\r\\nWITH ano_atual AS (\\r\\n    SELECT CAST(MAX(ano_referencia) / 100 AS INT) AS ano \\r\\n    FROM teste.ecd_score_risco_consolidado\\r\\n    WHERE ano_referencia > 0\\r\\n)\\r\\nSELECT\\r\\n    '3.2. DISTRIBUI\\u00c7\\u00c3O SCORE RISCO' AS consulta,\\r\\n    \\r\\n    aa.ano AS ano_fiscal,\\r\\n    sr.classificacao_risco,\\r\\n    COUNT(DISTINCT sr.cnpj) AS qtd_empresas,\\r\\n    ROUND(COUNT(DISTINCT sr.cnpj) * 100.0 / SUM(COUNT(DISTINCT sr.cnpj)) OVER(), 2) AS percentual,\\r\\n    \\r\\n    -- Scores M\\u00e9dios\\r\\n    ROUND(AVG(sr.score_equacao_contabil), 2) AS media_score_equacao,\\r\\n    ROUND(AVG(sr.score_neaf), 2) AS media_score_neaf,\\r\\n    ROUND(AVG(sr.score_risco_financeiro), 2) AS media_score_financeiro,\\r\\n    ROUND(AVG(sr.score_risco_total), 2) AS media_score_total,\\r\\n    \\r\\n    -- Contadores\\r\\n    ROUND(AVG(sr.qtd_indicios_neaf), 2) AS media_indicios_neaf,\\r\\n    \\r\\n    -- Indicadores Financeiros\\r\\n    ROUND(AVG(sr.liquidez_corrente), 4) AS media_liquidez,\\r\\n    ROUND(AVG(sr.endividamento_geral), 4) AS media_endividamento,\\r\\n    ROUND(AVG(sr.margem_liquida_perc), 2) AS media_margem_liquida\\r\\n    \\r\\nFROM teste.ecd_score_risco_consolidado sr, ano_atual aa\\r\\nWHERE CAST(sr.ano_referencia / 100 AS INT) = aa.ano\\r\\nGROUP BY aa.ano, sr.classificacao_risco\\r\\nORDER BY \\r\\n    CASE sr.classificacao_risco\\r\\n        WHEN 'RISCO CR\\u00cdTICO' THEN 1\\r\\n        WHEN 'RISCO ALTO' THEN 2\\r\\n        WHEN 'RISCO MODERADO' THEN 3\\r\\n        ELSE 4\\r\\n    END;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- 4.1. TOP 100 EMPRESAS COM IND\\u00cdCIOS NEAF (ANO MAIS RECENTE)\\r\\n-- ============================================================================\\r\\n\\r\\nWITH ano_atual AS (\\r\\n    SELECT CAST(MAX(ano_referencia) / 100 AS INT) AS ano \\r\\n    FROM teste.ecd_empresas_cadastro\\r\\n    WHERE ano_referencia > 0\\r\\n)\\r\\nSELECT\\r\\n    '4.1. TOP 100 EMPRESAS COM MAIS IND\\u00cdCIOS NEAF' AS consulta,\\r\\n    \\r\\n    ni.cnpj,\\r\\n    ec.nm_razao_social AS razao_social,\\r\\n    ec.nm_fantasia,\\r\\n    ec.cd_uf,\\r\\n    ec.cd_cnae,\\r\\n    ec.de_cnae,\\r\\n    \\r\\n    ni.qtd_total_indicios,\\r\\n    ni.qtd_tipos_indicios,\\r\\n    \\r\\n    -- Score de risco\\r\\n    sr.score_risco_total,\\r\\n    sr.classificacao_risco,\\r\\n    \\r\\n    -- Indicadores financeiros\\r\\n    ROUND(ind.ativo_total / 1000000, 2) AS ativo_milhoes,\\r\\n    ROUND(ind.receita_liquida / 1000000, 2) AS receita_milhoes\\r\\n    \\r\\nFROM teste.ecd_neaf_indicios ni\\r\\nINNER JOIN teste.ecd_empresas_cadastro ec ON ni.cnpj = ec.cnpj\\r\\nINNER JOIN ano_atual aa ON CAST(ec.ano_referencia / 100 AS INT) = aa.ano\\r\\nLEFT JOIN teste.ecd_score_risco_consolidado sr \\r\\n    ON ni.cnpj = sr.cnpj \\r\\n    AND CAST(ec.ano_referencia / 100 AS INT) = CAST(sr.ano_referencia / 100 AS INT)\\r\\nLEFT JOIN teste.ecd_indicadores_financeiros ind \\r\\n    ON ni.cnpj = ind.cnpj \\r\\n    AND CAST(ec.ano_referencia / 100 AS INT) = CAST(ind.ano_referencia / 100 AS INT)\\r\\nORDER BY ni.qtd_total_indicios DESC, ni.qtd_tipos_indicios DESC\\r\\nLIMIT 100;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- 5.1. BENCHMARK SETORIAL (TOP 100)\\r\\n-- ============================================================================\\r\\n\\r\\nWITH ano_atual AS (\\r\\n    SELECT CAST(MAX(ano_referencia) / 100 AS INT) AS ano \\r\\n    FROM teste.ecd_indicadores_financeiros\\r\\n    WHERE ano_referencia > 0\\r\\n)\\r\\nSELECT\\r\\n    '5.1. EMPRESAS vs BENCHMARK SETORIAL (TOP 100)' AS consulta,\\r\\n    \\r\\n    ec.cnpj,\\r\\n    ec.nm_razao_social AS razao_social,\\r\\n    ec.nm_fantasia,\\r\\n    ec.cd_cnae,\\r\\n    ec.de_cnae,\\r\\n    ec.cnae_divisao,\\r\\n    \\r\\n    -- Indicadores da Empresa\\r\\n    ROUND(ind.liquidez_corrente, 4) AS liquidez_empresa,\\r\\n    ROUND(ind.margem_liquida_perc, 2) AS margem_liquida_empresa,\\r\\n    ROUND(ind.roe_retorno_patrimonio_perc, 2) AS roe_empresa,\\r\\n    \\r\\n    -- Benchmark do Setor\\r\\n    ROUND(sr.media_liquidez_corrente_setor, 4) AS liquidez_setor,\\r\\n    ROUND(sr.media_margem_liquida_setor, 2) AS margem_liquida_setor,\\r\\n    ROUND(sr.media_roe_setor, 2) AS roe_setor,\\r\\n    sr.qtd_empresas_setor,\\r\\n    \\r\\n    -- Posicionamento no Setor\\r\\n    sr.posicao_liquidez_setor,\\r\\n    sr.posicao_margem_setor,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(ind.ativo_total / 1000000, 2) AS ativo_milhoes,\\r\\n    ROUND(ind.receita_liquida / 1000000, 2) AS receita_milhoes\\r\\n    \\r\\nFROM teste.ecd_indicadores_financeiros ind\\r\\nINNER JOIN ano_atual aa ON CAST(ind.ano_referencia / 100 AS INT) = aa.ano\\r\\nINNER JOIN teste.ecd_empresas_cadastro ec \\r\\n    ON ind.cnpj = ec.cnpj \\r\\n    AND CAST(ind.ano_referencia / 100 AS INT) = CAST(ec.ano_referencia / 100 AS INT)\\r\\nLEFT JOIN teste.ecd_score_risco_consolidado sr \\r\\n    ON ec.cnpj = sr.cnpj \\r\\n    AND CAST(ec.ano_referencia / 100 AS INT) = CAST(sr.ano_referencia / 100 AS INT)\\r\\nWHERE sr.qtd_empresas_setor >= 10\\r\\n    AND sr.posicao_liquidez_setor IS NOT NULL\\r\\nORDER BY ind.ativo_total DESC\\r\\nLIMIT 100;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- 6.1. TOP 50 CONTAS MAIS UTILIZADAS\\r\\n-- ============================================================================\\r\\n\\r\\nWITH ano_atual AS (\\r\\n    SELECT CAST(MAX(ano_referencia) / 100 AS INT) AS ano \\r\\n    FROM teste.ecd_plano_contas\\r\\n    WHERE ano_referencia > 0\\r\\n),\\r\\ntotal_empresas AS (\\r\\n    SELECT \\r\\n        CAST(ano_referencia / 100 AS INT) AS ano,\\r\\n        COUNT(DISTINCT cnpj) AS total_cnpj\\r\\n    FROM teste.ecd_plano_contas\\r\\n    WHERE ano_referencia > 0\\r\\n    GROUP BY CAST(ano_referencia / 100 AS INT)\\r\\n)\\r\\nSELECT\\r\\n    '6.1. TOP 50 CONTAS MAIS UTILIZADAS' AS consulta,\\r\\n    \\r\\n    pc.cd_conta,\\r\\n    pc.nm_conta,\\r\\n    pc.cd_conta_referencial,\\r\\n    pc.descricao_grupo_balanco,\\r\\n    \\r\\n    -- Hierarquia\\r\\n    pc.cd_conta_sint1,\\r\\n    pc.nm_conta_sint1,\\r\\n    pc.nivel_conta,\\r\\n    pc.tipo_conta,\\r\\n    \\r\\n    COUNT(DISTINCT pc.cnpj) AS qtd_empresas_usam,\\r\\n    ROUND(COUNT(DISTINCT pc.cnpj) * 100.0 / NULLIF(te.total_cnpj, 0), 2) AS perc_empresas,\\r\\n    \\r\\n    -- Valores M\\u00e9dios dos Saldos\\r\\n    ROUND(AVG(ABS(sc.saldo_final_contabil)) / 1000000, 2) AS media_saldo_milhoes,\\r\\n    ROUND(SUM(ABS(sc.saldo_final_contabil)) / 1000000000, 2) AS total_saldo_bilhoes\\r\\n    \\r\\nFROM teste.ecd_plano_contas pc\\r\\nINNER JOIN ano_atual aa ON CAST(pc.ano_referencia / 100 AS INT) = aa.ano\\r\\nINNER JOIN total_empresas te ON te.ano = aa.ano\\r\\nLEFT JOIN teste.ecd_saldos_contas sc \\r\\n    ON pc.cnpj = sc.cnpj \\r\\n    AND pc.cd_conta = sc.cd_conta \\r\\n    AND CAST(pc.ano_referencia / 100 AS INT) = CAST(sc.ano_referencia / 100 AS INT)\\r\\nWHERE pc.tipo_conta = 'A'  -- Apenas contas anal\\u00edticas\\r\\nGROUP BY pc.cd_conta, pc.nm_conta, pc.cd_conta_referencial, pc.descricao_grupo_balanco,\\r\\n         pc.cd_conta_sint1, pc.nm_conta_sint1, pc.nivel_conta, pc.tipo_conta, aa.ano, te.total_cnpj\\r\\nORDER BY qtd_empresas_usam DESC\\r\\nLIMIT 50;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- 7.1. RELAT\\u00d3RIO EXECUTIVO - TOP 200 PRIORIDADES\\r\\n-- ============================================================================\\r\\n\\r\\nWITH ano_atual AS (\\r\\n    SELECT CAST(MAX(ano_referencia) / 100 AS INT) AS ano \\r\\n    FROM teste.ecd_score_risco_consolidado\\r\\n    WHERE ano_referencia > 0\\r\\n)\\r\\nSELECT\\r\\n    '7.1. RELAT\\u00d3RIO EXECUTIVO - TOP 200 PRIORIDADES' AS consulta,\\r\\n    \\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    ec.cnpj,\\r\\n    ec.nm_razao_social AS razao_social,\\r\\n    ec.nm_fantasia,\\r\\n    ec.cd_uf,\\r\\n    ec.cd_cnae,\\r\\n    ec.de_cnae,\\r\\n    ec.cnae_secao,\\r\\n    ec.cnae_divisao,\\r\\n    ec.cnae_divisao_descricao,\\r\\n    ec.empresa_grande_porte,\\r\\n    ec.nm_reg_apuracao AS regime_apuracao,\\r\\n    ec.nm_tipo_contribuinte,\\r\\n    \\r\\n    -- Situa\\u00e7\\u00e3o Cadastral\\r\\n    ec.sit_cadastral_sefaz,\\r\\n    ec.nm_sit_cadastral_sefaz,\\r\\n    ec.natureza_juridica_sefaz,\\r\\n    ec.nm_natureza_juridica_sefaz,\\r\\n    \\r\\n    CASE \\r\\n        WHEN ec.sn_simples_nacional_rfb = 1 THEN 'Sim'\\r\\n        WHEN ec.sn_simples_nacional_rfb = 0 THEN 'N\\u00e3o'\\r\\n        ELSE 'N\\u00e3o Informado'\\r\\n    END AS simples_nacional,\\r\\n    \\r\\n    -- Scores de Risco\\r\\n    sr.score_risco_total,\\r\\n    sr.classificacao_risco,\\r\\n    sr.score_equacao_contabil,\\r\\n    sr.score_neaf,\\r\\n    sr.score_risco_financeiro,\\r\\n    sr.qtd_indicios_neaf,\\r\\n    \\r\\n    -- Valores Financeiros\\r\\n    ROUND(ind.ativo_total / 1000000, 2) AS ativo_milhoes,\\r\\n    ROUND(ind.ativo_circulante / 1000000, 2) AS ativo_circulante_milhoes,\\r\\n    ROUND(ind.passivo_total / 1000000, 2) AS passivo_milhoes,\\r\\n    ROUND(ind.patrimonio_liquido / 1000000, 2) AS pl_milhoes,\\r\\n    ROUND(ind.receita_liquida / 1000000, 2) AS receita_milhoes,\\r\\n    ROUND(ind.resultado_liquido / 1000000, 2) AS resultado_milhoes,\\r\\n    \\r\\n    -- Indicadores Financeiros\\r\\n    ROUND(ind.liquidez_corrente, 4) AS liquidez_corrente,\\r\\n    ROUND(ind.liquidez_geral, 4) AS liquidez_geral,\\r\\n    ROUND(ind.endividamento_geral, 4) AS endividamento_geral,\\r\\n    ROUND(ind.margem_liquida_perc, 2) AS margem_liquida_perc,\\r\\n    ROUND(ind.margem_bruta_perc, 2) AS margem_bruta_perc,\\r\\n    ROUND(ind.roa_retorno_ativo_perc, 2) AS roa_perc,\\r\\n    ROUND(ind.roe_retorno_patrimonio_perc, 2) AS roe_perc,\\r\\n    \\r\\n    -- Benchmark Setorial\\r\\n    sr.media_liquidez_corrente_setor,\\r\\n    sr.media_margem_liquida_setor,\\r\\n    sr.media_roe_setor,\\r\\n    sr.qtd_empresas_setor,\\r\\n    sr.posicao_liquidez_setor,\\r\\n    sr.posicao_margem_setor,\\r\\n    \\r\\n    -- Alertas\\r\\n    CASE WHEN ind.liquidez_corrente < 1 THEN 'SIM' ELSE 'N\\u00c3O' END AS alerta_baixa_liquidez,\\r\\n    CASE WHEN ind.endividamento_geral > 0.8 THEN 'SIM' ELSE 'N\\u00c3O' END AS alerta_alto_endividamento,\\r\\n    CASE WHEN ind.resultado_liquido < 0 THEN 'SIM' ELSE 'N\\u00c3O' END AS alerta_prejuizo,\\r\\n    CASE WHEN sr.qtd_indicios_neaf > 0 THEN 'SIM' ELSE 'N\\u00c3O' END AS alerta_indicios_neaf,\\r\\n    \\r\\n    -- Inconsist\\u00eancias\\r\\n    COALESCE(ie.classificacao_inconsistencia, 'OK') AS status_equacao_contabil,\\r\\n    ROUND(ie.percentual_diferenca, 4) AS perc_diferenca_bp,\\r\\n    \\r\\n    -- Prioridade de A\\u00e7\\u00e3o (1 a 5)\\r\\n    CASE \\r\\n        WHEN sr.score_risco_total >= 7 AND ind.ativo_total >= 100000000 THEN 1\\r\\n        WHEN sr.score_risco_total >= 7 OR ind.ativo_total >= 100000000 THEN 2\\r\\n        WHEN sr.score_risco_total >= 5 THEN 3\\r\\n        WHEN sr.score_risco_total >= 3 THEN 4\\r\\n        ELSE 5\\r\\n    END AS prioridade_fiscalizacao,\\r\\n    \\r\\n    aa.ano AS ano_fiscal,\\r\\n    CURRENT_TIMESTAMP() AS data_relatorio\\r\\n    \\r\\nFROM teste.ecd_score_risco_consolidado sr\\r\\nINNER JOIN ano_atual aa ON CAST(sr.ano_referencia / 100 AS INT) = aa.ano\\r\\nINNER JOIN teste.ecd_empresas_cadastro ec \\r\\n    ON sr.cnpj = ec.cnpj \\r\\n    AND CAST(sr.ano_referencia / 100 AS INT) = CAST(ec.ano_referencia / 100 AS INT)\\r\\nINNER JOIN teste.ecd_indicadores_financeiros ind \\r\\n    ON sr.cnpj = ind.cnpj \\r\\n    AND CAST(sr.ano_referencia / 100 AS INT) = CAST(ind.ano_referencia / 100 AS INT)\\r\\nLEFT JOIN teste.ecd_inconsistencias_equacao ie \\r\\n    ON sr.cnpj = ie.cnpj \\r\\n    AND CAST(sr.ano_referencia / 100 AS INT) = CAST(ie.ano_referencia / 100 AS INT)\\r\\nWHERE sr.score_risco_total >= 5 \\r\\n    OR ind.ativo_total >= 50000000\\r\\n    OR sr.qtd_indicios_neaf >= 3\\r\\nORDER BY \\r\\n    prioridade_fiscalizacao ASC,\\r\\n    sr.score_risco_total DESC,\\r\\n    ind.ativo_total DESC\\r\\nLIMIT 200;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- 8. AN\\u00c1LISE POR NATUREZA JUR\\u00cdDICA (ANO MAIS RECENTE)\\r\\n-- ============================================================================\\r\\n\\r\\nWITH ano_atual AS (\\r\\n    SELECT CAST(MAX(ano_referencia) / 100 AS INT) AS ano \\r\\n    FROM teste.ecd_empresas_cadastro\\r\\n    WHERE ano_referencia > 0\\r\\n)\\r\\nSELECT\\r\\n    'AN\\u00c1LISE POR NATUREZA JUR\\u00cdDICA' AS consulta,\\r\\n    \\r\\n    aa.ano AS ano_fiscal,\\r\\n    ec.natureza_juridica_sefaz,\\r\\n    ec.nm_natureza_juridica_sefaz,\\r\\n    COUNT(DISTINCT ec.cnpj) AS qtd_empresas,\\r\\n    ROUND(COUNT(DISTINCT ec.cnpj) * 100.0 / SUM(COUNT(DISTINCT ec.cnpj)) OVER(), 2) AS percentual,\\r\\n    \\r\\n    -- Grande Porte\\r\\n    COUNT(DISTINCT CASE WHEN ec.empresa_grande_porte = 'Sim' THEN ec.cnpj END) AS grande_porte,\\r\\n    \\r\\n    -- Indicadores Financeiros M\\u00e9dios\\r\\n    ROUND(AVG(ind.ativo_total) / 1000000, 2) AS media_ativo_milhoes,\\r\\n    ROUND(AVG(ind.receita_liquida) / 1000000, 2) AS media_receita_milhoes,\\r\\n    ROUND(AVG(ind.liquidez_corrente), 4) AS media_liquidez,\\r\\n    ROUND(AVG(ind.margem_liquida_perc), 2) AS media_margem_liquida,\\r\\n    \\r\\n    -- Score de Risco M\\u00e9dio\\r\\n    ROUND(AVG(sr.score_risco_total), 2) AS score_risco_medio\\r\\n    \\r\\nFROM teste.ecd_empresas_cadastro ec\\r\\nINNER JOIN ano_atual aa ON CAST(ec.ano_referencia / 100 AS INT) = aa.ano\\r\\nLEFT JOIN teste.ecd_indicadores_financeiros ind \\r\\n    ON ec.cnpj = ind.cnpj \\r\\n    AND CAST(ec.ano_referencia / 100 AS INT) = CAST(ind.ano_referencia / 100 AS INT)\\r\\nLEFT JOIN teste.ecd_score_risco_consolidado sr \\r\\n    ON ec.cnpj = sr.cnpj \\r\\n    AND CAST(ec.ano_referencia / 100 AS INT) = CAST(sr.ano_referencia / 100 AS INT)\\r\\nWHERE ec.natureza_juridica_sefaz IS NOT NULL\\r\\nGROUP BY aa.ano, ec.natureza_juridica_sefaz, ec.nm_natureza_juridica_sefaz\\r\\nORDER BY qtd_empresas DESC\\r\\nLIMIT 20;\", \"statementsList\": [\"\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- 1.1. PANORAMA GERAL V3.2 (CORRIGIDO PARA AAAAMM)\\r\\n-- ============================================================================\\r\\n\\r\\nWITH periodos AS (\\r\\n    SELECT \\r\\n        MAX(ano_referencia) AS periodo_mais_recente,\\r\\n        CAST(MAX(ano_referencia) / 100 AS INT) AS ano_mais_recente\\r\\n    FROM teste.ecd_empresas_cadastro\\r\\n    WHERE ano_referencia > 0\\r\\n)\\r\\nSELECT\\r\\n    '1.1. PANORAMA GERAL ECD ONLINE V3.2' AS consulta,\\r\\n    \\r\\n    -- Anos detectados\\r\\n    p.periodo_mais_recente,\\r\\n    p.ano_mais_recente,\\r\\n    \\r\\n    -- M\\u00e9tricas de Volume\\r\\n    COUNT(DISTINCT ec.cnpj) AS total_empresas_base,\\r\\n    COUNT(DISTINCT ec.id_ecd) AS total_ecds_entregues,\\r\\n    \\r\\n    -- Por ano fiscal (\\u00faltimos 3 anos)\\r\\n    COUNT(DISTINCT CASE \\r\\n        WHEN CAST(ec.ano_referencia / 100 AS INT) = p.ano_mais_recente\\r\\n        THEN ec.id_ecd END) AS qtd_ecds_ano_atual,\\r\\n    COUNT(DISTINCT CASE \\r\\n        WHEN CAST(ec.ano_referencia / 100 AS INT) = p.ano_mais_recente - 1 \\r\\n        THEN ec.id_ecd END) AS qtd_ecds_ano_anterior,\\r\\n    COUNT(DISTINCT CASE \\r\\n        WHEN CAST(ec.ano_referencia / 100 AS INT) = p.ano_mais_recente - 2 \\r\\n        THEN ec.id_ecd END) AS qtd_ecds_ano_retrasado,\\r\\n        \\r\\n    COUNT(DISTINCT CASE \\r\\n        WHEN CAST(ec.ano_referencia / 100 AS INT) = p.ano_mais_recente\\r\\n        THEN ec.cnpj END) AS empresas_ano_atual,\\r\\n    COUNT(DISTINCT CASE \\r\\n        WHEN CAST(ec.ano_referencia / 100 AS INT) = p.ano_mais_recente - 1 \\r\\n        THEN ec.cnpj END) AS empresas_ano_anterior,\\r\\n    COUNT(DISTINCT CASE \\r\\n        WHEN CAST(ec.ano_referencia / 100 AS INT) = p.ano_mais_recente - 2 \\r\\n        THEN ec.cnpj END) AS empresas_ano_retrasado,\\r\\n    \\r\\n    -- Tipos de ECD\\r\\n    COUNT(DISTINCT CASE WHEN ec.tipo_ecd = 'Livro Di\\u00e1rio (Completo)' THEN ec.cnpj END) AS empresas_diario_completo,\\r\\n    COUNT(DISTINCT CASE WHEN ec.tipo_ecd = 'Livro Di\\u00e1rio com Redu\\u00e7\\u00e3o' THEN ec.cnpj END) AS empresas_diario_reducao,\\r\\n    COUNT(DISTINCT CASE WHEN ec.tipo_ecd = 'Livro Balancetes' THEN ec.cnpj END) AS empresas_balancetes,\\r\\n    \\r\\n    -- Grande Porte\\r\\n    COUNT(DISTINCT CASE WHEN ec.empresa_grande_porte = 'Sim' THEN ec.cnpj END) AS empresas_grande_porte,\\r\\n    ROUND(COUNT(DISTINCT CASE WHEN ec.empresa_grande_porte = 'Sim' THEN ec.cnpj END) * 100.0 / \\r\\n          NULLIF(COUNT(DISTINCT ec.cnpj), 0), 2) AS perc_grande_porte,\\r\\n    \\r\\n    -- Situa\\u00e7\\u00e3o Cadastral SEFAZ\\r\\n    COUNT(DISTINCT CASE WHEN ec.sit_cadastral_sefaz = 1 THEN ec.cnpj END) AS empresas_ativas_sefaz,\\r\\n    COUNT(DISTINCT CASE WHEN ec.sit_cadastral_sefaz != 1 OR ec.sit_cadastral_sefaz IS NULL THEN ec.cnpj END) AS empresas_inativas_sefaz,\\r\\n    \\r\\n    -- Simples Nacional\\r\\n    COUNT(DISTINCT CASE WHEN ec.sn_simples_nacional_rfb = 1 THEN ec.cnpj END) AS empresas_simples_nacional,\\r\\n    COUNT(DISTINCT CASE WHEN ec.sn_simples_nacional_rfb = 0 THEN ec.cnpj END) AS empresas_lucro_real_presumido,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS data_consulta\\r\\n    \\r\\nFROM teste.ecd_empresas_cadastro ec, periodos p\\r\\nWHERE ec.ano_referencia > 0\\r\\nGROUP BY p.periodo_mais_recente, p.ano_mais_recente;\", \"\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- 1.2. ESTAT\\u00cdSTICAS POR ANO FISCAL\\r\\n-- ============================================================================\\r\\n\\r\\nSELECT\\r\\n    '1.2. ESTAT\\u00cdSTICAS POR ANO FISCAL' AS consulta,\\r\\n    \\r\\n    CAST(ano_referencia / 100 AS INT) AS ano_fiscal,\\r\\n    COUNT(DISTINCT cnpj) AS empresas,\\r\\n    COUNT(DISTINCT id_ecd) AS total_ecds,\\r\\n    \\r\\n    -- Tipos de ECD\\r\\n    COUNT(DISTINCT CASE WHEN tipo_ecd = 'Livro Di\\u00e1rio (Completo)' THEN cnpj END) AS diario_completo,\\r\\n    COUNT(DISTINCT CASE WHEN tipo_ecd = 'Livro Di\\u00e1rio com Redu\\u00e7\\u00e3o' THEN cnpj END) AS diario_reducao,\\r\\n    COUNT(DISTINCT CASE WHEN tipo_ecd = 'Livro Balancetes' THEN cnpj END) AS balancetes,\\r\\n    \\r\\n    -- Grande Porte\\r\\n    COUNT(DISTINCT CASE WHEN empresa_grande_porte = 'Sim' THEN cnpj END) AS grande_porte,\\r\\n    \\r\\n    -- Simples Nacional\\r\\n    COUNT(DISTINCT CASE WHEN sn_simples_nacional_rfb = 1 THEN cnpj END) AS simples_nacional,\\r\\n    COUNT(DISTINCT CASE WHEN sn_simples_nacional_rfb = 0 THEN cnpj END) AS lucro_real_presumido\\r\\n    \\r\\nFROM teste.ecd_empresas_cadastro\\r\\nWHERE ano_referencia > 0\\r\\nGROUP BY CAST(ano_referencia / 100 AS INT)\\r\\nORDER BY ano_fiscal DESC;\", \"\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- 1.3. DISTRIBUI\\u00c7\\u00c3O POR UF (ANO MAIS RECENTE)\\r\\n-- ============================================================================\\r\\n\\r\\nWITH ano_atual AS (\\r\\n    SELECT CAST(MAX(ano_referencia) / 100 AS INT) AS ano \\r\\n    FROM teste.ecd_empresas_cadastro\\r\\n    WHERE ano_referencia > 0\\r\\n)\\r\\nSELECT\\r\\n    '1.3. DISTRIBUI\\u00c7\\u00c3O POR UF' AS consulta,\\r\\n    \\r\\n    ec.cd_uf AS uf,\\r\\n    COUNT(DISTINCT ec.cnpj) AS total_empresas,\\r\\n    COUNT(DISTINCT ec.id_ecd) AS total_ecds,\\r\\n    ROUND(COUNT(DISTINCT ec.cnpj) * 100.0 / SUM(COUNT(DISTINCT ec.cnpj)) OVER(), 2) AS percentual,\\r\\n    \\r\\n    -- Grande Porte\\r\\n    COUNT(DISTINCT CASE WHEN ec.empresa_grande_porte = 'Sim' THEN ec.cnpj END) AS grande_porte,\\r\\n    \\r\\n    -- Simples Nacional\\r\\n    COUNT(DISTINCT CASE WHEN ec.sn_simples_nacional_rfb = 1 THEN ec.cnpj END) AS simples_nacional\\r\\n    \\r\\nFROM teste.ecd_empresas_cadastro ec, ano_atual aa\\r\\nWHERE ec.cd_uf IS NOT NULL\\r\\n    AND CAST(ec.ano_referencia / 100 AS INT) = aa.ano\\r\\nGROUP BY ec.cd_uf\\r\\nORDER BY total_empresas DESC;\", \"\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- 1.4. TOP 30 SETORES (ANO MAIS RECENTE)\\r\\n-- ============================================================================\\r\\n\\r\\nWITH ano_atual AS (\\r\\n    SELECT CAST(MAX(ano_referencia) / 100 AS INT) AS ano \\r\\n    FROM teste.ecd_empresas_cadastro\\r\\n    WHERE ano_referencia > 0\\r\\n)\\r\\nSELECT\\r\\n    '1.4. TOP 30 SETORES DETALHADO' AS consulta,\\r\\n    \\r\\n    ec.cnae_secao,\\r\\n    ec.cnae_secao_descricao,\\r\\n    ec.cnae_divisao,\\r\\n    ec.cnae_divisao_descricao,\\r\\n    COUNT(DISTINCT ec.cnpj) AS total_empresas,\\r\\n    COUNT(DISTINCT ec.id_ecd) AS total_ecds,\\r\\n    ROUND(COUNT(DISTINCT ec.cnpj) * 100.0 / SUM(COUNT(DISTINCT ec.cnpj)) OVER(), 2) AS percentual,\\r\\n    \\r\\n    -- Grande Porte\\r\\n    COUNT(DISTINCT CASE WHEN ec.empresa_grande_porte = 'Sim' THEN ec.cnpj END) AS grande_porte,\\r\\n    \\r\\n    -- M\\u00e9tricas Financeiras M\\u00e9dias\\r\\n    ROUND(AVG(ind.ativo_total) / 1000000, 2) AS media_ativo_milhoes,\\r\\n    ROUND(AVG(ind.receita_liquida) / 1000000, 2) AS media_receita_milhoes,\\r\\n    ROUND(AVG(ind.margem_liquida_perc), 2) AS media_margem_liquida,\\r\\n    ROUND(AVG(ind.roe_retorno_patrimonio_perc), 2) AS media_roe,\\r\\n    \\r\\n    -- Score de Risco M\\u00e9dio\\r\\n    ROUND(AVG(sr.score_risco_total), 2) AS score_risco_medio\\r\\n    \\r\\nFROM teste.ecd_empresas_cadastro ec, ano_atual aa\\r\\nLEFT JOIN teste.ecd_indicadores_financeiros ind \\r\\n    ON ec.cnpj = ind.cnpj \\r\\n    AND CAST(ec.ano_referencia / 100 AS INT) = CAST(ind.ano_referencia / 100 AS INT)\\r\\nLEFT JOIN teste.ecd_score_risco_consolidado sr \\r\\n    ON ec.cnpj = sr.cnpj \\r\\n    AND CAST(ec.ano_referencia / 100 AS INT) = CAST(sr.ano_referencia / 100 AS INT)\\r\\nWHERE ec.cnae_secao IS NOT NULL\\r\\n    AND CAST(ec.ano_referencia / 100 AS INT) = aa.ano\\r\\nGROUP BY ec.cnae_secao, ec.cnae_secao_descricao, ec.cnae_divisao, ec.cnae_divisao_descricao\\r\\nORDER BY total_empresas DESC\\r\\nLIMIT 30;\", \"\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- 2.1. INDICADORES FINANCEIROS - RESUMO GERAL (ANO MAIS RECENTE)\\r\\n-- ============================================================================\\r\\n\\r\\nWITH ano_atual AS (\\r\\n    SELECT CAST(MAX(ano_referencia) / 100 AS INT) AS ano \\r\\n    FROM teste.ecd_indicadores_financeiros\\r\\n    WHERE ano_referencia > 0\\r\\n)\\r\\nSELECT\\r\\n    '2.1. RESUMO INDICADORES FINANCEIROS' AS consulta,\\r\\n    \\r\\n    aa.ano AS ano_fiscal,\\r\\n    COUNT(DISTINCT ind.cnpj) AS qtd_empresas,\\r\\n    \\r\\n    -- Valores totais\\r\\n    ROUND(SUM(ind.ativo_total) / 1000000000, 2) AS ativo_total_bilhoes,\\r\\n    ROUND(SUM(ind.receita_liquida) / 1000000000, 2) AS receita_total_bilhoes,\\r\\n    ROUND(SUM(ind.resultado_liquido) / 1000000000, 2) AS resultado_total_bilhoes,\\r\\n    \\r\\n    -- M\\u00e9dias\\r\\n    ROUND(AVG(ind.ativo_total) / 1000000, 2) AS media_ativo_milhoes,\\r\\n    ROUND(AVG(ind.receita_liquida) / 1000000, 2) AS media_receita_milhoes,\\r\\n    ROUND(AVG(ind.liquidez_corrente), 4) AS media_liquidez_corrente,\\r\\n    ROUND(AVG(ind.endividamento_geral), 4) AS media_endividamento,\\r\\n    ROUND(AVG(ind.margem_liquida_perc), 2) AS media_margem_liquida,\\r\\n    ROUND(AVG(ind.roe_retorno_patrimonio_perc), 2) AS media_roe,\\r\\n    \\r\\n    -- Contadores de situa\\u00e7\\u00e3o\\r\\n    COUNT(CASE WHEN ind.liquidez_corrente < 1 THEN 1 END) AS empresas_baixa_liquidez,\\r\\n    COUNT(CASE WHEN ind.endividamento_geral > 0.7 THEN 1 END) AS empresas_alto_endividamento,\\r\\n    COUNT(CASE WHEN ind.resultado_liquido < 0 THEN 1 END) AS empresas_prejuizo\\r\\n    \\r\\nFROM teste.ecd_indicadores_financeiros ind, ano_atual aa\\r\\nWHERE CAST(ind.ano_referencia / 100 AS INT) = aa.ano\\r\\nGROUP BY aa.ano;\", \"\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- 3.1. PANORAMA DE INCONSIST\\u00caNCIAS\\r\\n-- ============================================================================\\r\\n\\r\\nWITH ano_atual AS (\\r\\n    SELECT CAST(MAX(ano_referencia) / 100 AS INT) AS ano \\r\\n    FROM teste.ecd_inconsistencias_equacao\\r\\n    WHERE ano_referencia > 0\\r\\n),\\r\\nscores_risco AS (\\r\\n    SELECT \\r\\n        CAST(ano_referencia / 100 AS INT) AS ano,\\r\\n        COUNT(DISTINCT CASE WHEN classificacao_risco = 'RISCO CR\\u00cdTICO' THEN cnpj END) AS cnt_critico,\\r\\n        COUNT(DISTINCT CASE WHEN classificacao_risco = 'RISCO ALTO' THEN cnpj END) AS cnt_alto,\\r\\n        ROUND(AVG(score_risco_total), 2) AS score_medio\\r\\n    FROM teste.ecd_score_risco_consolidado\\r\\n    WHERE ano_referencia > 0\\r\\n    GROUP BY CAST(ano_referencia / 100 AS INT)\\r\\n)\\r\\nSELECT\\r\\n    '3.1. PANORAMA INCONSIST\\u00caNCIAS' AS consulta,\\r\\n    \\r\\n    aa.ano AS ano_fiscal,\\r\\n    \\r\\n    -- Inconsist\\u00eancias de Equa\\u00e7\\u00e3o\\r\\n    COUNT(DISTINCT ie.cnpj) AS total_empresas_analisadas,\\r\\n    COUNT(DISTINCT CASE WHEN ie.classificacao_inconsistencia != 'OK' THEN ie.cnpj END) AS empresas_com_inconsistencia,\\r\\n    ROUND(COUNT(DISTINCT CASE WHEN ie.classificacao_inconsistencia != 'OK' THEN ie.cnpj END) * 100.0 / \\r\\n          NULLIF(COUNT(DISTINCT ie.cnpj), 0), 2) AS perc_com_inconsistencia,\\r\\n    \\r\\n    ROUND(AVG(CASE WHEN ie.classificacao_inconsistencia != 'OK' THEN ie.percentual_diferenca END), 4) AS media_perc_diferenca,\\r\\n    \\r\\n    -- Por Gravidade\\r\\n    COUNT(DISTINCT CASE WHEN ie.classificacao_inconsistencia = 'Diferen\\u00e7a Cr\\u00edtica' THEN ie.cnpj END) AS criticas,\\r\\n    COUNT(DISTINCT CASE WHEN ie.classificacao_inconsistencia = 'Diferen\\u00e7a Significativa' THEN ie.cnpj END) AS significativas,\\r\\n    COUNT(DISTINCT CASE WHEN ie.classificacao_inconsistencia = 'Diferen\\u00e7a Moderada' THEN ie.cnpj END) AS moderadas,\\r\\n    \\r\\n    -- Score de Risco (de CTE)\\r\\n    sr.cnt_critico AS empresas_risco_critico,\\r\\n    sr.cnt_alto AS empresas_risco_alto,\\r\\n    sr.score_medio AS score_risco_medio_geral\\r\\n     \\r\\nFROM teste.ecd_inconsistencias_equacao ie, ano_atual aa\\r\\nLEFT JOIN scores_risco sr ON sr.ano = aa.ano\\r\\nWHERE CAST(ie.ano_referencia / 100 AS INT) = aa.ano\\r\\nGROUP BY aa.ano, sr.cnt_critico, sr.cnt_alto, sr.score_medio;\", \"\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- 3.2. DISTRIBUI\\u00c7\\u00c3O DE SCORES DE RISCO\\r\\n-- ============================================================================\\r\\n\\r\\nWITH ano_atual AS (\\r\\n    SELECT CAST(MAX(ano_referencia) / 100 AS INT) AS ano \\r\\n    FROM teste.ecd_score_risco_consolidado\\r\\n    WHERE ano_referencia > 0\\r\\n)\\r\\nSELECT\\r\\n    '3.2. DISTRIBUI\\u00c7\\u00c3O SCORE RISCO' AS consulta,\\r\\n    \\r\\n    aa.ano AS ano_fiscal,\\r\\n    sr.classificacao_risco,\\r\\n    COUNT(DISTINCT sr.cnpj) AS qtd_empresas,\\r\\n    ROUND(COUNT(DISTINCT sr.cnpj) * 100.0 / SUM(COUNT(DISTINCT sr.cnpj)) OVER(), 2) AS percentual,\\r\\n    \\r\\n    -- Scores M\\u00e9dios\\r\\n    ROUND(AVG(sr.score_equacao_contabil), 2) AS media_score_equacao,\\r\\n    ROUND(AVG(sr.score_neaf), 2) AS media_score_neaf,\\r\\n    ROUND(AVG(sr.score_risco_financeiro), 2) AS media_score_financeiro,\\r\\n    ROUND(AVG(sr.score_risco_total), 2) AS media_score_total,\\r\\n    \\r\\n    -- Contadores\\r\\n    ROUND(AVG(sr.qtd_indicios_neaf), 2) AS media_indicios_neaf,\\r\\n    \\r\\n    -- Indicadores Financeiros\\r\\n    ROUND(AVG(sr.liquidez_corrente), 4) AS media_liquidez,\\r\\n    ROUND(AVG(sr.endividamento_geral), 4) AS media_endividamento,\\r\\n    ROUND(AVG(sr.margem_liquida_perc), 2) AS media_margem_liquida\\r\\n    \\r\\nFROM teste.ecd_score_risco_consolidado sr, ano_atual aa\\r\\nWHERE CAST(sr.ano_referencia / 100 AS INT) = aa.ano\\r\\nGROUP BY aa.ano, sr.classificacao_risco\\r\\nORDER BY \\r\\n    CASE sr.classificacao_risco\\r\\n        WHEN 'RISCO CR\\u00cdTICO' THEN 1\\r\\n        WHEN 'RISCO ALTO' THEN 2\\r\\n        WHEN 'RISCO MODERADO' THEN 3\\r\\n        ELSE 4\\r\\n    END;\", \"\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- 4.1. TOP 100 EMPRESAS COM IND\\u00cdCIOS NEAF (ANO MAIS RECENTE)\\r\\n-- ============================================================================\\r\\n\\r\\nWITH ano_atual AS (\\r\\n    SELECT CAST(MAX(ano_referencia) / 100 AS INT) AS ano \\r\\n    FROM teste.ecd_empresas_cadastro\\r\\n    WHERE ano_referencia > 0\\r\\n)\\r\\nSELECT\\r\\n    '4.1. TOP 100 EMPRESAS COM MAIS IND\\u00cdCIOS NEAF' AS consulta,\\r\\n    \\r\\n    ni.cnpj,\\r\\n    ec.nm_razao_social AS razao_social,\\r\\n    ec.nm_fantasia,\\r\\n    ec.cd_uf,\\r\\n    ec.cd_cnae,\\r\\n    ec.de_cnae,\\r\\n    \\r\\n    ni.qtd_total_indicios,\\r\\n    ni.qtd_tipos_indicios,\\r\\n    \\r\\n    -- Score de risco\\r\\n    sr.score_risco_total,\\r\\n    sr.classificacao_risco,\\r\\n    \\r\\n    -- Indicadores financeiros\\r\\n    ROUND(ind.ativo_total / 1000000, 2) AS ativo_milhoes,\\r\\n    ROUND(ind.receita_liquida / 1000000, 2) AS receita_milhoes\\r\\n    \\r\\nFROM teste.ecd_neaf_indicios ni\\r\\nINNER JOIN teste.ecd_empresas_cadastro ec ON ni.cnpj = ec.cnpj\\r\\nINNER JOIN ano_atual aa ON CAST(ec.ano_referencia / 100 AS INT) = aa.ano\\r\\nLEFT JOIN teste.ecd_score_risco_consolidado sr \\r\\n    ON ni.cnpj = sr.cnpj \\r\\n    AND CAST(ec.ano_referencia / 100 AS INT) = CAST(sr.ano_referencia / 100 AS INT)\\r\\nLEFT JOIN teste.ecd_indicadores_financeiros ind \\r\\n    ON ni.cnpj = ind.cnpj \\r\\n    AND CAST(ec.ano_referencia / 100 AS INT) = CAST(ind.ano_referencia / 100 AS INT)\\r\\nORDER BY ni.qtd_total_indicios DESC, ni.qtd_tipos_indicios DESC\\r\\nLIMIT 100;\", \"\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- 5.1. BENCHMARK SETORIAL (TOP 100)\\r\\n-- ============================================================================\\r\\n\\r\\nWITH ano_atual AS (\\r\\n    SELECT CAST(MAX(ano_referencia) / 100 AS INT) AS ano \\r\\n    FROM teste.ecd_indicadores_financeiros\\r\\n    WHERE ano_referencia > 0\\r\\n)\\r\\nSELECT\\r\\n    '5.1. EMPRESAS vs BENCHMARK SETORIAL (TOP 100)' AS consulta,\\r\\n    \\r\\n    ec.cnpj,\\r\\n    ec.nm_razao_social AS razao_social,\\r\\n    ec.nm_fantasia,\\r\\n    ec.cd_cnae,\\r\\n    ec.de_cnae,\\r\\n    ec.cnae_divisao,\\r\\n    \\r\\n    -- Indicadores da Empresa\\r\\n    ROUND(ind.liquidez_corrente, 4) AS liquidez_empresa,\\r\\n    ROUND(ind.margem_liquida_perc, 2) AS margem_liquida_empresa,\\r\\n    ROUND(ind.roe_retorno_patrimonio_perc, 2) AS roe_empresa,\\r\\n    \\r\\n    -- Benchmark do Setor\\r\\n    ROUND(sr.media_liquidez_corrente_setor, 4) AS liquidez_setor,\\r\\n    ROUND(sr.media_margem_liquida_setor, 2) AS margem_liquida_setor,\\r\\n    ROUND(sr.media_roe_setor, 2) AS roe_setor,\\r\\n    sr.qtd_empresas_setor,\\r\\n    \\r\\n    -- Posicionamento no Setor\\r\\n    sr.posicao_liquidez_setor,\\r\\n    sr.posicao_margem_setor,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(ind.ativo_total / 1000000, 2) AS ativo_milhoes,\\r\\n    ROUND(ind.receita_liquida / 1000000, 2) AS receita_milhoes\\r\\n    \\r\\nFROM teste.ecd_indicadores_financeiros ind\\r\\nINNER JOIN ano_atual aa ON CAST(ind.ano_referencia / 100 AS INT) = aa.ano\\r\\nINNER JOIN teste.ecd_empresas_cadastro ec \\r\\n    ON ind.cnpj = ec.cnpj \\r\\n    AND CAST(ind.ano_referencia / 100 AS INT) = CAST(ec.ano_referencia / 100 AS INT)\\r\\nLEFT JOIN teste.ecd_score_risco_consolidado sr \\r\\n    ON ec.cnpj = sr.cnpj \\r\\n    AND CAST(ec.ano_referencia / 100 AS INT) = CAST(sr.ano_referencia / 100 AS INT)\\r\\nWHERE sr.qtd_empresas_setor >= 10\\r\\n    AND sr.posicao_liquidez_setor IS NOT NULL\\r\\nORDER BY ind.ativo_total DESC\\r\\nLIMIT 100;\", \"\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- 6.1. TOP 50 CONTAS MAIS UTILIZADAS\\r\\n-- ============================================================================\\r\\n\\r\\nWITH ano_atual AS (\\r\\n    SELECT CAST(MAX(ano_referencia) / 100 AS INT) AS ano \\r\\n    FROM teste.ecd_plano_contas\\r\\n    WHERE ano_referencia > 0\\r\\n),\\r\\ntotal_empresas AS (\\r\\n    SELECT \\r\\n        CAST(ano_referencia / 100 AS INT) AS ano,\\r\\n        COUNT(DISTINCT cnpj) AS total_cnpj\\r\\n    FROM teste.ecd_plano_contas\\r\\n    WHERE ano_referencia > 0\\r\\n    GROUP BY CAST(ano_referencia / 100 AS INT)\\r\\n)\\r\\nSELECT\\r\\n    '6.1. TOP 50 CONTAS MAIS UTILIZADAS' AS consulta,\\r\\n    \\r\\n    pc.cd_conta,\\r\\n    pc.nm_conta,\\r\\n    pc.cd_conta_referencial,\\r\\n    pc.descricao_grupo_balanco,\\r\\n    \\r\\n    -- Hierarquia\\r\\n    pc.cd_conta_sint1,\\r\\n    pc.nm_conta_sint1,\\r\\n    pc.nivel_conta,\\r\\n    pc.tipo_conta,\\r\\n    \\r\\n    COUNT(DISTINCT pc.cnpj) AS qtd_empresas_usam,\\r\\n    ROUND(COUNT(DISTINCT pc.cnpj) * 100.0 / NULLIF(te.total_cnpj, 0), 2) AS perc_empresas,\\r\\n    \\r\\n    -- Valores M\\u00e9dios dos Saldos\\r\\n    ROUND(AVG(ABS(sc.saldo_final_contabil)) / 1000000, 2) AS media_saldo_milhoes,\\r\\n    ROUND(SUM(ABS(sc.saldo_final_contabil)) / 1000000000, 2) AS total_saldo_bilhoes\\r\\n    \\r\\nFROM teste.ecd_plano_contas pc\\r\\nINNER JOIN ano_atual aa ON CAST(pc.ano_referencia / 100 AS INT) = aa.ano\\r\\nINNER JOIN total_empresas te ON te.ano = aa.ano\\r\\nLEFT JOIN teste.ecd_saldos_contas sc \\r\\n    ON pc.cnpj = sc.cnpj \\r\\n    AND pc.cd_conta = sc.cd_conta \\r\\n    AND CAST(pc.ano_referencia / 100 AS INT) = CAST(sc.ano_referencia / 100 AS INT)\\r\\nWHERE pc.tipo_conta = 'A'  -- Apenas contas anal\\u00edticas\\r\\nGROUP BY pc.cd_conta, pc.nm_conta, pc.cd_conta_referencial, pc.descricao_grupo_balanco,\\r\\n         pc.cd_conta_sint1, pc.nm_conta_sint1, pc.nivel_conta, pc.tipo_conta, aa.ano, te.total_cnpj\\r\\nORDER BY qtd_empresas_usam DESC\\r\\nLIMIT 50;\", \"\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- 7.1. RELAT\\u00d3RIO EXECUTIVO - TOP 200 PRIORIDADES\\r\\n-- ============================================================================\\r\\n\\r\\nWITH ano_atual AS (\\r\\n    SELECT CAST(MAX(ano_referencia) / 100 AS INT) AS ano \\r\\n    FROM teste.ecd_score_risco_consolidado\\r\\n    WHERE ano_referencia > 0\\r\\n)\\r\\nSELECT\\r\\n    '7.1. RELAT\\u00d3RIO EXECUTIVO - TOP 200 PRIORIDADES' AS consulta,\\r\\n    \\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    ec.cnpj,\\r\\n    ec.nm_razao_social AS razao_social,\\r\\n    ec.nm_fantasia,\\r\\n    ec.cd_uf,\\r\\n    ec.cd_cnae,\\r\\n    ec.de_cnae,\\r\\n    ec.cnae_secao,\\r\\n    ec.cnae_divisao,\\r\\n    ec.cnae_divisao_descricao,\\r\\n    ec.empresa_grande_porte,\\r\\n    ec.nm_reg_apuracao AS regime_apuracao,\\r\\n    ec.nm_tipo_contribuinte,\\r\\n    \\r\\n    -- Situa\\u00e7\\u00e3o Cadastral\\r\\n    ec.sit_cadastral_sefaz,\\r\\n    ec.nm_sit_cadastral_sefaz,\\r\\n    ec.natureza_juridica_sefaz,\\r\\n    ec.nm_natureza_juridica_sefaz,\\r\\n    \\r\\n    CASE \\r\\n        WHEN ec.sn_simples_nacional_rfb = 1 THEN 'Sim'\\r\\n        WHEN ec.sn_simples_nacional_rfb = 0 THEN 'N\\u00e3o'\\r\\n        ELSE 'N\\u00e3o Informado'\\r\\n    END AS simples_nacional,\\r\\n    \\r\\n    -- Scores de Risco\\r\\n    sr.score_risco_total,\\r\\n    sr.classificacao_risco,\\r\\n    sr.score_equacao_contabil,\\r\\n    sr.score_neaf,\\r\\n    sr.score_risco_financeiro,\\r\\n    sr.qtd_indicios_neaf,\\r\\n    \\r\\n    -- Valores Financeiros\\r\\n    ROUND(ind.ativo_total / 1000000, 2) AS ativo_milhoes,\\r\\n    ROUND(ind.ativo_circulante / 1000000, 2) AS ativo_circulante_milhoes,\\r\\n    ROUND(ind.passivo_total / 1000000, 2) AS passivo_milhoes,\\r\\n    ROUND(ind.patrimonio_liquido / 1000000, 2) AS pl_milhoes,\\r\\n    ROUND(ind.receita_liquida / 1000000, 2) AS receita_milhoes,\\r\\n    ROUND(ind.resultado_liquido / 1000000, 2) AS resultado_milhoes,\\r\\n    \\r\\n    -- Indicadores Financeiros\\r\\n    ROUND(ind.liquidez_corrente, 4) AS liquidez_corrente,\\r\\n    ROUND(ind.liquidez_geral, 4) AS liquidez_geral,\\r\\n    ROUND(ind.endividamento_geral, 4) AS endividamento_geral,\\r\\n    ROUND(ind.margem_liquida_perc, 2) AS margem_liquida_perc,\\r\\n    ROUND(ind.margem_bruta_perc, 2) AS margem_bruta_perc,\\r\\n    ROUND(ind.roa_retorno_ativo_perc, 2) AS roa_perc,\\r\\n    ROUND(ind.roe_retorno_patrimonio_perc, 2) AS roe_perc,\\r\\n    \\r\\n    -- Benchmark Setorial\\r\\n    sr.media_liquidez_corrente_setor,\\r\\n    sr.media_margem_liquida_setor,\\r\\n    sr.media_roe_setor,\\r\\n    sr.qtd_empresas_setor,\\r\\n    sr.posicao_liquidez_setor,\\r\\n    sr.posicao_margem_setor,\\r\\n    \\r\\n    -- Alertas\\r\\n    CASE WHEN ind.liquidez_corrente < 1 THEN 'SIM' ELSE 'N\\u00c3O' END AS alerta_baixa_liquidez,\\r\\n    CASE WHEN ind.endividamento_geral > 0.8 THEN 'SIM' ELSE 'N\\u00c3O' END AS alerta_alto_endividamento,\\r\\n    CASE WHEN ind.resultado_liquido < 0 THEN 'SIM' ELSE 'N\\u00c3O' END AS alerta_prejuizo,\\r\\n    CASE WHEN sr.qtd_indicios_neaf > 0 THEN 'SIM' ELSE 'N\\u00c3O' END AS alerta_indicios_neaf,\\r\\n    \\r\\n    -- Inconsist\\u00eancias\\r\\n    COALESCE(ie.classificacao_inconsistencia, 'OK') AS status_equacao_contabil,\\r\\n    ROUND(ie.percentual_diferenca, 4) AS perc_diferenca_bp,\\r\\n    \\r\\n    -- Prioridade de A\\u00e7\\u00e3o (1 a 5)\\r\\n    CASE \\r\\n        WHEN sr.score_risco_total >= 7 AND ind.ativo_total >= 100000000 THEN 1\\r\\n        WHEN sr.score_risco_total >= 7 OR ind.ativo_total >= 100000000 THEN 2\\r\\n        WHEN sr.score_risco_total >= 5 THEN 3\\r\\n        WHEN sr.score_risco_total >= 3 THEN 4\\r\\n        ELSE 5\\r\\n    END AS prioridade_fiscalizacao,\\r\\n    \\r\\n    aa.ano AS ano_fiscal,\\r\\n    CURRENT_TIMESTAMP() AS data_relatorio\\r\\n    \\r\\nFROM teste.ecd_score_risco_consolidado sr\\r\\nINNER JOIN ano_atual aa ON CAST(sr.ano_referencia / 100 AS INT) = aa.ano\\r\\nINNER JOIN teste.ecd_empresas_cadastro ec \\r\\n    ON sr.cnpj = ec.cnpj \\r\\n    AND CAST(sr.ano_referencia / 100 AS INT) = CAST(ec.ano_referencia / 100 AS INT)\\r\\nINNER JOIN teste.ecd_indicadores_financeiros ind \\r\\n    ON sr.cnpj = ind.cnpj \\r\\n    AND CAST(sr.ano_referencia / 100 AS INT) = CAST(ind.ano_referencia / 100 AS INT)\\r\\nLEFT JOIN teste.ecd_inconsistencias_equacao ie \\r\\n    ON sr.cnpj = ie.cnpj \\r\\n    AND CAST(sr.ano_referencia / 100 AS INT) = CAST(ie.ano_referencia / 100 AS INT)\\r\\nWHERE sr.score_risco_total >= 5 \\r\\n    OR ind.ativo_total >= 50000000\\r\\n    OR sr.qtd_indicios_neaf >= 3\\r\\nORDER BY \\r\\n    prioridade_fiscalizacao ASC,\\r\\n    sr.score_risco_total DESC,\\r\\n    ind.ativo_total DESC\\r\\nLIMIT 200;\", \"\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- 8. AN\\u00c1LISE POR NATUREZA JUR\\u00cdDICA (ANO MAIS RECENTE)\\r\\n-- ============================================================================\\r\\n\\r\\nWITH ano_atual AS (\\r\\n    SELECT CAST(MAX(ano_referencia) / 100 AS INT) AS ano \\r\\n    FROM teste.ecd_empresas_cadastro\\r\\n    WHERE ano_referencia > 0\\r\\n)\\r\\nSELECT\\r\\n    'AN\\u00c1LISE POR NATUREZA JUR\\u00cdDICA' AS consulta,\\r\\n    \\r\\n    aa.ano AS ano_fiscal,\\r\\n    ec.natureza_juridica_sefaz,\\r\\n    ec.nm_natureza_juridica_sefaz,\\r\\n    COUNT(DISTINCT ec.cnpj) AS qtd_empresas,\\r\\n    ROUND(COUNT(DISTINCT ec.cnpj) * 100.0 / SUM(COUNT(DISTINCT ec.cnpj)) OVER(), 2) AS percentual,\\r\\n    \\r\\n    -- Grande Porte\\r\\n    COUNT(DISTINCT CASE WHEN ec.empresa_grande_porte = 'Sim' THEN ec.cnpj END) AS grande_porte,\\r\\n    \\r\\n    -- Indicadores Financeiros M\\u00e9dios\\r\\n    ROUND(AVG(ind.ativo_total) / 1000000, 2) AS media_ativo_milhoes,\\r\\n    ROUND(AVG(ind.receita_liquida) / 1000000, 2) AS media_receita_milhoes,\\r\\n    ROUND(AVG(ind.liquidez_corrente), 4) AS media_liquidez,\\r\\n    ROUND(AVG(ind.margem_liquida_perc), 2) AS media_margem_liquida,\\r\\n    \\r\\n    -- Score de Risco M\\u00e9dio\\r\\n    ROUND(AVG(sr.score_risco_total), 2) AS score_risco_medio\\r\\n    \\r\\nFROM teste.ecd_empresas_cadastro ec\\r\\nINNER JOIN ano_atual aa ON CAST(ec.ano_referencia / 100 AS INT) = aa.ano\\r\\nLEFT JOIN teste.ecd_indicadores_financeiros ind \\r\\n    ON ec.cnpj = ind.cnpj \\r\\n    AND CAST(ec.ano_referencia / 100 AS INT) = CAST(ind.ano_referencia / 100 AS INT)\\r\\nLEFT JOIN teste.ecd_score_risco_consolidado sr \\r\\n    ON ec.cnpj = sr.cnpj \\r\\n    AND CAST(ec.ano_referencia / 100 AS INT) = CAST(sr.ano_referencia / 100 AS INT)\\r\\nWHERE ec.natureza_juridica_sefaz IS NOT NULL\\r\\nGROUP BY aa.ano, ec.natureza_juridica_sefaz, ec.nm_natureza_juridica_sefaz\\r\\nORDER BY qtd_empresas DESC\\r\\nLIMIT 20;\"], \"aceSize\": 100, \"status\": \"ready\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- 7.1. RELAT\\u00d3RIO EXECUTIVO - TOP 200 PRIORIDADES\\r\\n-- ============================================================================\\r\\n\\r\\nWITH ano_atual AS (\\r\\n    SELECT CAST(MAX(ano_referencia) / 100 AS INT) AS ano \\r\\n    FROM teste.ecd_score_risco_consolidado\\r\\n    WHERE ano_referencia > 0\\r\\n)\\r\\nSELECT\\r\\n    '7.1. RELAT\\u00d3RIO EXECUTIVO - TOP 200 PRIORIDADES' AS consulta,\\r\\n    \\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    ec.cnpj,\\r\\n    ec.nm_razao_social AS razao_social,\\r\\n    ec.nm_fantasia,\\r\\n    ec.cd_uf,\\r\\n    ec.cd_cnae,\\r\\n    ec.de_cnae,\\r\\n    ec.cnae_secao,\\r\\n    ec.cnae_divisao,\\r\\n    ec.cnae_divisao_descricao,\\r\\n    ec.empresa_grande_porte,\\r\\n    ec.nm_reg_apuracao AS regime_apuracao,\\r\\n    ec.nm_tipo_contribuinte,\\r\\n    \\r\\n    -- Situa\\u00e7\\u00e3o Cadastral\\r\\n    ec.sit_cadastral_sefaz,\\r\\n    ec.nm_sit_cadastral_sefaz,\\r\\n    ec.natureza_juridica_sefaz,\\r\\n    ec.nm_natureza_juridica_sefaz,\\r\\n    \\r\\n    CASE \\r\\n        WHEN ec.sn_simples_nacional_rfb = 1 THEN 'Sim'\\r\\n        WHEN ec.sn_simples_nacional_rfb = 0 THEN 'N\\u00e3o'\\r\\n        ELSE 'N\\u00e3o Informado'\\r\\n    END AS simples_nacional,\\r\\n    \\r\\n    -- Scores de Risco\\r\\n    sr.score_risco_total,\\r\\n    sr.classificacao_risco,\\r\\n    sr.score_equacao_contabil,\\r\\n    sr.score_neaf,\\r\\n    sr.score_risco_financeiro,\\r\\n    sr.qtd_indicios_neaf,\\r\\n    \\r\\n    -- Valores Financeiros\\r\\n    ROUND(ind.ativo_total / 1000000, 2) AS ativo_milhoes,\\r\\n    ROUND(ind.ativo_circulante / 1000000, 2) AS ativo_circulante_milhoes,\\r\\n    ROUND(ind.passivo_total / 1000000, 2) AS passivo_milhoes,\\r\\n    ROUND(ind.patrimonio_liquido / 1000000, 2) AS pl_milhoes,\\r\\n    ROUND(ind.receita_liquida / 1000000, 2) AS receita_milhoes,\\r\\n    ROUND(ind.resultado_liquido / 1000000, 2) AS resultado_milhoes,\\r\\n    \\r\\n    -- Indicadores Financeiros\\r\\n    ROUND(ind.liquidez_corrente, 4) AS liquidez_corrente,\\r\\n    ROUND(ind.liquidez_geral, 4) AS liquidez_geral,\\r\\n    ROUND(ind.endividamento_geral, 4) AS endividamento_geral,\\r\\n    ROUND(ind.margem_liquida_perc, 2) AS margem_liquida_perc,\\r\\n    ROUND(ind.margem_bruta_perc, 2) AS margem_bruta_perc,\\r\\n    ROUND(ind.roa_retorno_ativo_perc, 2) AS roa_perc,\\r\\n    ROUND(ind.roe_retorno_patrimonio_perc, 2) AS roe_perc,\\r\\n    \\r\\n    -- Benchmark Setorial\\r\\n    sr.media_liquidez_corrente_setor,\\r\\n    sr.media_margem_liquida_setor,\\r\\n    sr.media_roe_setor,\\r\\n    sr.qtd_empresas_setor,\\r\\n    sr.posicao_liquidez_setor,\\r\\n    sr.posicao_margem_setor,\\r\\n    \\r\\n    -- Alertas\\r\\n    CASE WHEN ind.liquidez_corrente < 1 THEN 'SIM' ELSE 'N\\u00c3O' END AS alerta_baixa_liquidez,\\r\\n    CASE WHEN ind.endividamento_geral > 0.8 THEN 'SIM' ELSE 'N\\u00c3O' END AS alerta_alto_endividamento,\\r\\n    CASE WHEN ind.resultado_liquido < 0 THEN 'SIM' ELSE 'N\\u00c3O' END AS alerta_prejuizo,\\r\\n    CASE WHEN sr.qtd_indicios_neaf > 0 THEN 'SIM' ELSE 'N\\u00c3O' END AS alerta_indicios_neaf,\\r\\n    \\r\\n    -- Inconsist\\u00eancias\\r\\n    COALESCE(ie.classificacao_inconsistencia, 'OK') AS status_equacao_contabil,\\r\\n    ROUND(ie.percentual_diferenca, 4) AS perc_diferenca_bp,\\r\\n    \\r\\n    -- Prioridade de A\\u00e7\\u00e3o (1 a 5)\\r\\n    CASE \\r\\n        WHEN sr.score_risco_total >= 7 AND ind.ativo_total >= 100000000 THEN 1\\r\\n        WHEN sr.score_risco_total >= 7 OR ind.ativo_total >= 100000000 THEN 2\\r\\n        WHEN sr.score_risco_total >= 5 THEN 3\\r\\n        WHEN sr.score_risco_total >= 3 THEN 4\\r\\n        ELSE 5\\r\\n    END AS prioridade_fiscalizacao,\\r\\n    \\r\\n    aa.ano AS ano_fiscal,\\r\\n    CURRENT_TIMESTAMP() AS data_relatorio\\r\\n    \\r\\nFROM teste.ecd_score_risco_consolidado sr\\r\\nINNER JOIN ano_atual aa ON CAST(sr.ano_referencia / 100 AS INT) = aa.ano\\r\\nINNER JOIN teste.ecd_empresas_cadastro ec \\r\\n    ON sr.cnpj = ec.cnpj \\r\\n    AND CAST(sr.ano_referencia / 100 AS INT) = CAST(ec.ano_referencia / 100 AS INT)\\r\\nINNER JOIN teste.ecd_indicadores_financeiros ind \\r\\n    ON sr.cnpj = ind.cnpj \\r\\n    AND CAST(sr.ano_referencia / 100 AS INT) = CAST(ind.ano_referencia / 100 AS INT)\\r\\nLEFT JOIN teste.ecd_inconsistencias_equacao ie \\r\\n    ON sr.cnpj = ie.cnpj \\r\\n    AND CAST(sr.ano_referencia / 100 AS INT) = CAST(ie.ano_referencia / 100 AS INT)\\r\\nWHERE sr.score_risco_total >= 5 \\r\\n    OR ind.ativo_total >= 50000000\\r\\n    OR sr.qtd_indicios_neaf >= 3\\r\\nORDER BY \\r\\n    prioridade_fiscalizacao ASC,\\r\\n    sr.score_risco_total DESC,\\r\\n    ind.ativo_total DESC\\r\\nLIMIT 200;\", \"result\": {\"id\": \"9af6c240-3d64-efa4-e281-aff2f08681e2\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"seNkEhoeSxW7nN7HRfEvig==\", \"guid\": \"K6V+9YMkS7UAAAAApXSPug==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"e04eeba90c6561a0:24dc95ca244911a3\", \"session_id\": 22020, \"session_type\": \"impala\", \"statement_id\": 0, \"has_more_statements\": false, \"statements_count\": 1, \"previous_statement_hash\": \"34851b46c3433768b0fc184a3a44fcb942d7f35079d4424caa14ab51\", \"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 0, \"column\": 536}, \"statement\": \"-- ================================================================================\\r\\n-- 9. BUSCA DE EMPRESAS (simples e r\\u00e1pida)\\r\\n-- ================================================================================\\r\\n\\r\\nSELECT\\r\\n    ec.cnpj,\\r\\n    ec.nm_razao_social,\\r\\n    ec.nm_fantasia,\\r\\n    ec.cd_uf,\\r\\n    ec.cd_cnae,\\r\\n    ec.de_cnae\\r\\n\\r\\nFROM teste.ecd_empresas_cadastro ec\\r\\n\\r\\nWHERE ec.ano_referencia = 202401\\r\\n  AND (\\r\\n    UPPER(ec.nm_razao_social) LIKE '%TELEFONICA%'  -- SUBSTITUIR\\r\\n    OR ec.cnpj LIKE '%02558157%'\\r\\n  )\\r\\n\\r\\nLIMIT 50\"}, \"meta\": [], \"rows\": 1, \"hasMore\": false, \"statement_id\": 0, \"statement_range\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 0, \"column\": 0}}, \"statements_count\": 1, \"previous_statement_hash\": null, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": -1, \"filteredMeta\": [], \"fetchedOnce\": false, \"startTime\": \"2025-10-26T23:18:46.085Z\", \"endTime\": \"2025-10-26T23:18:47.430Z\", \"executionTime\": 1345, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 0, \"hasSomeResults\": false}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": -1, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"cnpj\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [\"cd_cnae\"], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": true, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"cnpj\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [\"cd_cnae\"], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": null, \"getLogsTimeout\": null, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1761520725845, \"lastAceSelectionRowOffset\": 255, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 77.33334, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 163, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- ============================================================================\r\n-- CONSULTAS ANALÍTICAS ECD ONLINE - VERSÃO 3.2 FINAL\r\n-- CORRIGIDO: Anos no formato AAAAMM (202401, 202301, etc.)\r\n-- ============================================================================\r\n\r\nSET REQUEST_POOL = 'medium';\r\n\r\n-- ============================================================================\r\n-- 0. VALIDAÇÃO PRÉVIA - ENTENDA SEUS DADOS\r\n-- ============================================================================\r\n\r\n-- Ver distribuição de anos/meses\r\nSELECT \r\n    'Distribuição Ano/Mês' AS info,\r\n    CAST(ano_referencia / 100 AS INT) AS ano,\r\n    ano_referencia % 100 AS mes,\r\n    ano_referencia AS ano_mes_completo,\r\n    COUNT(DISTINCT cnpj) AS qtd_empresas,\r\n    COUNT(DISTINCT id_ecd) AS qtd_ecds\r\nFROM teste.ecd_empresas_cadastro\r\nWHERE ano_referencia > 0  -- Ignorar registros sem data\r\nGROUP BY ano_referencia\r\nORDER BY ano_referencia DESC\r\nLIMIT 20;\r\n\r\n-- Ver apenas anos (ignorando mês)\r\nSELECT \r\n    'Por Ano Fiscal' AS info,\r\n    CAST(ano_referencia / 100 AS INT) AS ano_fiscal,\r\n    COUNT(DISTINCT cnpj) AS qtd_empresas_distintas,\r\n    COUNT(DISTINCT id_ecd) AS qtd_ecds_total\r\nFROM teste.ecd_empresas_cadastro\r\nWHERE ano_referencia > 0\r\nGROUP BY CAST(ano_referencia / 100 AS INT)\r\nORDER BY ano_fiscal DESC;\r\n\r\n\r\n-- ============================================================================\r\n-- 1.1. PANORAMA GERAL V3.2 (CORRIGIDO PARA AAAAMM)\r\n-- ============================================================================\r\n\r\nWITH periodos AS (\r\n    SELECT \r\n        MAX(ano_referencia) AS periodo_mais_recente,\r\n        CAST(MAX(ano_referencia) / 100 AS INT) AS ano_mais_recente\r\n    FROM teste.ecd_empresas_cadastro\r\n    WHERE ano_referencia > 0\r\n)\r\nSELECT\r\n    '1.1. PANORAMA GERAL ECD ONLINE V3.2' AS consulta,\r\n    \r\n    -- Anos detectados\r\n    p.periodo_mais_recente,\r\n    p.ano_mais_recente,\r\n    \r\n    -- Métricas de Volume\r\n    COUNT(DISTINCT ec.cnpj) AS total_empresas_",
    "last_modified": "2025-10-27T09:13:43.290",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "bb81055a-5ce8-40f4-947b-e794da0b0493",
      1,
      false
    ],
    "dependencies": []
  }
}
]
